

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tombo.tombo_stats &mdash; Tombo 1.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Tombo 1.2 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Tombo
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Tombo Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resquiggle.html">Re-squiggle Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modified_base_detection.html">Modified Base Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../text_output.html">Text Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotting.html">Plotting Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filtering.html">Read Filtering Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_training.html">Model Training (Advanced Users Only)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rna.html">RNA Processing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tombo.html">tombo package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Tombo</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>tombo.tombo_stats</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tombo.tombo_stats</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="nb">zip</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>

<span class="c1"># Future warning from cython in h5py</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">h5py</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="k">import</span> <span class="n">pdist</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="k">import</span> <span class="n">single</span><span class="p">,</span> <span class="n">leaves_list</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">unicode</span> <span class="o">=</span> <span class="nb">str</span>

<span class="c1"># import tombo functions</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">tombo_helper</span> <span class="k">as</span> <span class="n">th</span>

<span class="kn">from</span> <span class="nn">.c_helper</span> <span class="k">import</span> <span class="n">c_mean_std</span><span class="p">,</span> <span class="n">c_calc_llh_ratio</span>
<span class="kn">from</span> <span class="nn">._default_parameters</span> <span class="k">import</span> <span class="n">SMALLEST_PVAL</span><span class="p">,</span> <span class="n">MIN_POSITION_SD</span><span class="p">,</span> \
    <span class="n">STANDARD_MODELS</span><span class="p">,</span> <span class="n">ALTERNATE_MODELS</span><span class="p">,</span> <span class="n">MIN_KMER_OBS_TO_EST</span><span class="p">,</span> <span class="n">ALT_EST_BATCH</span><span class="p">,</span> \
    <span class="n">MAX_KMER_OBS</span><span class="p">,</span> <span class="n">NUM_DENS_POINTS</span><span class="p">,</span> <span class="n">LLR_THRESH</span><span class="p">,</span> <span class="n">HYPO_THRESH</span><span class="p">,</span> <span class="n">KERNEL_DENSITY_RANGE</span>

<span class="n">VERBOSE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">_PROFILE_SIGNIF</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_PROFILE_EST_REF</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_PROFILE_ALT_EST</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">_DEBUG_EST_STD</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_DEBUG_EST_BW</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">_DEBUG_EST_NUM_KMER_SAVE</span> <span class="o">=</span> <span class="mi">500</span>

<span class="n">DNA_BASES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;G&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>

<span class="n">HALF_NORM_EXPECTED_VAL</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">halfnorm</span><span class="o">.</span><span class="n">expect</span><span class="p">()</span>

<span class="n">STANDARD_MODEL_NAME</span> <span class="o">=</span> <span class="s1">&#39;standard&#39;</span>

<span class="n">SAMP_COMP_TXT</span> <span class="o">=</span> <span class="s1">&#39;sample_compare&#39;</span>
<span class="n">DE_NOVO_TXT</span> <span class="o">=</span> <span class="s1">&#39;de_novo&#39;</span>
<span class="n">ALT_MODEL_TXT</span> <span class="o">=</span> <span class="s1">&#39;model_compare&#39;</span>


<span class="c1">#############################################</span>
<span class="c1">##### Pair-wise Distance and Clustering #####</span>
<span class="c1">#############################################</span>

<div class="viewcode-block" id="order_reads"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.order_reads">[docs]</a><span class="k">def</span> <span class="nf">order_reads</span><span class="p">(</span><span class="n">log_r_pvals</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute order of reads based on log p-values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get pairwise distances between reads</span>
    <span class="c1"># will get some empty slice means warnings, so suppress those</span>
    <span class="c1">#   (no seterr for this specific warning)</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">r_dists</span> <span class="o">=</span> <span class="n">pdist</span><span class="p">(</span><span class="n">log_r_pvals</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">u</span><span class="o">-</span><span class="n">v</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))))</span>
    <span class="n">r_dists</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r_dists</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">r_dists</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1"># then perform single/min linkage clustering and return the leaf order</span></div>
    <span class="k">return</span> <span class="n">leaves_list</span><span class="p">(</span><span class="n">single</span><span class="p">(</span><span class="n">r_dists</span><span class="p">))</span>

<div class="viewcode-block" id="sliding_window_dist"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.sliding_window_dist">[docs]</a><span class="k">def</span> <span class="nf">sliding_window_dist</span><span class="p">(</span><span class="n">sig_diffs1</span><span class="p">,</span> <span class="n">sig_diffs2</span><span class="p">,</span> <span class="n">slide_span</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute distance over the minimum over a sliding window</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span>
        <span class="n">sig_diffs1</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i1</span><span class="o">+</span><span class="n">num_bases</span><span class="p">]</span> <span class="o">-</span> <span class="n">sig_diffs2</span><span class="p">[</span><span class="n">i2</span><span class="p">:</span><span class="n">i2</span><span class="o">+</span><span class="n">num_bases</span><span class="p">]))</span>
                       <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">slide_span</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span></div>
                       <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">slide_span</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>

<div class="viewcode-block" id="euclidian_dist"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.euclidian_dist">[docs]</a><span class="k">def</span> <span class="nf">euclidian_dist</span><span class="p">(</span><span class="n">sig_diffs1</span><span class="p">,</span> <span class="n">sig_diffs2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Euclidean distance</span>
<span class="sd">    &quot;&quot;&quot;</span></div>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sig_diffs1</span> <span class="o">-</span> <span class="n">sig_diffs2</span><span class="p">)))</span>

<div class="viewcode-block" id="get_pairwise_dists"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.get_pairwise_dists">[docs]</a><span class="k">def</span> <span class="nf">get_pairwise_dists</span><span class="p">(</span><span class="n">reg_sig_diffs</span><span class="p">,</span> <span class="n">index_q</span><span class="p">,</span> <span class="n">dists_q</span><span class="p">,</span> <span class="n">slide_span</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute pairwise distances between a set of signal shifts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">slide_span</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">num_bases</span><span class="o">=</span><span class="n">reg_sig_diffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">slide_span</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">index_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">index_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">slide_span</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">row_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">sliding_window_dist</span><span class="p">(</span>
                    <span class="n">reg_sig_diffs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">reg_sig_diffs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">slide_span</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span>
                <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_sig_diffs</span><span class="p">))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">row_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">euclidian_dist</span><span class="p">(</span><span class="n">reg_sig_diffs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">reg_sig_diffs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                 <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span>
                <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_sig_diffs</span><span class="p">))])</span>
        <span class="n">dists_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">row_dists</span><span class="p">))</span>
</div>
    <span class="k">return</span>


<span class="c1">########################################</span>
<span class="c1">##### Significant Region Selection #####</span>
<span class="c1">########################################</span>

<div class="viewcode-block" id="get_most_signif_regions"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.get_most_signif_regions">[docs]</a><span class="k">def</span> <span class="nf">get_most_signif_regions</span><span class="p">(</span><span class="n">all_stats</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">,</span> <span class="n">unique_pos</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select the most significant genome locations based on some criteria</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_stats</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;frac&#39;</span><span class="p">))</span>
    <span class="n">plot_intervals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">used_intervals</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_stats</span><span class="p">):</span>
        <span class="n">int_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_bases</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="n">chrm</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;chrm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">strand</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">unique_pos</span> <span class="ow">or</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_intervals</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]:</span>
            <span class="n">used_intervals</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="n">int_start</span><span class="p">,</span> <span class="n">int_start</span> <span class="o">+</span> <span class="n">num_bases</span><span class="p">))</span>
            <span class="n">plot_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">int_start</span><span class="p">,</span>
                <span class="n">int_start</span> <span class="o">+</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span>
                <span class="s1">&#39;Frac. Alternate: </span><span class="si">{0:.2g}</span><span class="s1">  Coverage: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="mi">1</span> <span class="o">-</span> <span class="n">stat</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;frac&#39;</span><span class="p">)],</span> <span class="n">stat</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;cov&#39;</span><span class="p">)])))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_intervals</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">num_regions</span><span class="p">:</span> <span class="k">break</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_intervals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;No locations identified. Most likely an empty statistics file.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_intervals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_regions</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Fewer unique significant locations more than [--num-bases]/2 &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;apart were identified. Continuing with &#39;</span> <span class="o">+</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plot_intervals</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; unique locations.&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">plot_intervals</span>


<span class="c1">#############################</span>
<span class="c1">##### Tombo Model Class #####</span>
<span class="c1">#############################</span>

<div class="viewcode-block" id="TomboModel"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.TomboModel">[docs]</a><span class="k">class</span> <span class="nc">TomboModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load, store and access Tombo model attributes and sequence-based expected</span>
<span class="sd">    mean and standard deviation levels (median normalization only)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_parse_tombo_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a tombo model file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ref_fp</span><span class="p">:</span>
                <span class="n">ref_raw</span> <span class="o">=</span> <span class="n">ref_fp</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                <span class="n">central_pos</span> <span class="o">=</span> <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;central_pos&#39;</span><span class="p">]</span>
                <span class="n">model_name</span> <span class="o">=</span> <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">pass</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">alt_base</span> <span class="o">=</span> <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;alt_base&#39;</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">alt_base</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">alt_base</span> <span class="o">=</span> <span class="n">alt_base</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">pass</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Invalid tombo kmer model file provided: &#39;</span>
                <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_fn</span><span class="p">))</span>

        <span class="n">mean_ref</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sd_ref</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">kmer_mean</span><span class="p">,</span> <span class="n">kmer_std</span> <span class="ow">in</span> <span class="n">ref_raw</span><span class="p">:</span>
            <span class="n">kmer</span> <span class="o">=</span> <span class="n">kmer</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="n">mean_ref</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmer_mean</span>
            <span class="n">sd_ref</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmer_std</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="n">mean_ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sds</span> <span class="o">=</span> <span class="n">sd_ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">=</span> <span class="n">central_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_base</span> <span class="o">=</span> <span class="n">alt_base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">model_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mean_ref</span><span class="p">))</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_fn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_fn</span> <span class="o">=</span> <span class="n">ref_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_tombo_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_std_model</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">STANDARD_MODEL_NAME</span> <span class="ow">and</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">alt_base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_alt_model</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_std_model</span>


<span class="c1">############################</span>
<span class="c1">##### Model Estimation #####</span>
<span class="c1">############################</span>

<div class="viewcode-block" id="write_tombo_model"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.write_tombo_model">[docs]</a><span class="k">def</span> <span class="nf">write_tombo_model</span><span class="p">(</span><span class="n">kmer_ref</span><span class="p">,</span> <span class="n">ref_fn</span><span class="p">,</span> <span class="n">central_pos</span><span class="p">,</span>
                      <span class="n">alt_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alt_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a tombo model file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ref_fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ref_fp</span><span class="p">:</span>
        <span class="n">ref_fp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">kmer_ref</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
        <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;central_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">central_pos</span>
        <span class="k">if</span> <span class="n">alt_base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">STANDARD_MODEL_NAME</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alt_name</span>
            <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;alt_base&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alt_base</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="parse_tombo_models"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.parse_tombo_models">[docs]</a><span class="k">def</span> <span class="nf">parse_tombo_models</span><span class="p">(</span><span class="n">alt_fns</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse several alternative tombo model files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alt_refs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">alt_model_fn</span> <span class="ow">in</span> <span class="n">alt_fns</span><span class="p">:</span>
        <span class="n">alt_ref</span> <span class="o">=</span> <span class="n">TomboModel</span><span class="p">(</span><span class="n">alt_model_fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">!=</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="ow">or</span>
            <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">!=</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">):</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
                <span class="s1">&#39;Standard and &#39;</span> <span class="o">+</span> <span class="n">alt_model_fn</span> <span class="o">+</span> <span class="s1">&#39; alternative base &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;models must be estimated using the same k-mer positions.&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">is_alt_model</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
                <span class="s1">&#39;Alternative model &#39;</span> <span class="o">+</span> <span class="n">alt_model_fn</span> <span class="o">+</span> <span class="s1">&#39; appears to be a &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;standard model and will not be processed.&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">alt_refs</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
                <span class="n">alt_ref</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; alternative model found in more than one &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;model file. Ignoring: &#39;</span> <span class="o">+</span> <span class="n">alt_model_fn</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">alt_refs</span><span class="p">[</span><span class="n">alt_ref</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">alt_ref</span>
</div>
    <span class="k">return</span> <span class="n">alt_refs</span>

<div class="viewcode-block" id="get_default_standard_ref"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.get_default_standard_ref">[docs]</a><span class="k">def</span> <span class="nf">get_default_standard_ref</span><span class="p">(</span><span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">bio_samp_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">bio_samp_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">standard_ref_fn</span> <span class="o">=</span> <span class="n">STANDARD_MODELS</span><span class="p">[</span><span class="n">bio_samp_type</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">th</span><span class="o">.</span><span class="n">is_rna</span><span class="p">(</span><span class="n">raw_read_coverage</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s1">&#39;Using default canonical ***** RNA ***** model.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">standard_ref_fn</span> <span class="o">=</span> <span class="n">STANDARD_MODELS</span><span class="p">[</span><span class="s1">&#39;RNA&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s1">&#39;Using default canonical ***** DNA ***** model.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">standard_ref_fn</span> <span class="o">=</span> <span class="n">STANDARD_MODELS</span><span class="p">[</span><span class="s1">&#39;DNA&#39;</span><span class="p">]</span>
    <span class="c1"># get full filename path with setuptools</span>
    <span class="n">standard_ref_fn</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span>
        <span class="s1">&#39;tombo&#39;</span><span class="p">,</span> <span class="s1">&#39;tombo_models/&#39;</span> <span class="o">+</span> <span class="n">standard_ref_fn</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">standard_ref_fn</span><span class="p">,</span> <span class="n">bio_samp_type</span>

<div class="viewcode-block" id="get_default_standard_ref_from_files"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.get_default_standard_ref_from_files">[docs]</a><span class="k">def</span> <span class="nf">get_default_standard_ref_from_files</span><span class="p">(</span><span class="n">fast5_fns</span><span class="p">,</span> <span class="n">bio_samp_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">bio_samp_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">standard_ref_fn</span> <span class="o">=</span> <span class="n">STANDARD_MODELS</span><span class="p">[</span><span class="n">bio_samp_type</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">th</span><span class="o">.</span><span class="n">is_rna_from_files</span><span class="p">(</span><span class="n">fast5_fns</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s1">&#39;Using default canonical ***** RNA ***** model.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">standard_ref_fn</span> <span class="o">=</span> <span class="n">STANDARD_MODELS</span><span class="p">[</span><span class="s1">&#39;RNA&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s1">&#39;Using default canonical ***** DNA ***** model.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">standard_ref_fn</span> <span class="o">=</span> <span class="n">STANDARD_MODELS</span><span class="p">[</span><span class="s1">&#39;DNA&#39;</span><span class="p">]</span>
    <span class="c1"># get full filename path with setuptools</span>
    <span class="n">standard_ref_fn</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span>
        <span class="s1">&#39;tombo&#39;</span><span class="p">,</span> <span class="s1">&#39;tombo_models/&#39;</span> <span class="o">+</span> <span class="n">standard_ref_fn</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">standard_ref_fn</span><span class="p">,</span> <span class="n">bio_samp_type</span>

<div class="viewcode-block" id="get_default_alt_ref"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.get_default_alt_ref">[docs]</a><span class="k">def</span> <span class="nf">get_default_alt_ref</span><span class="p">(</span><span class="n">alt_name</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">bio_samp_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">bio_samp_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">alt_model_fn</span> <span class="o">=</span> <span class="n">ALTERNATE_MODELS</span><span class="p">[</span><span class="n">bio_samp_type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">alt_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">alt_model_fn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">th</span><span class="o">.</span><span class="n">is_rna</span><span class="p">(</span><span class="n">raw_read_coverage</span><span class="p">):</span>
        <span class="n">bio_samp_type</span> <span class="o">=</span> <span class="s1">&#39;RNA&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">alt_model_fn</span> <span class="o">=</span> <span class="n">ALTERNATE_MODELS</span><span class="p">[</span><span class="s1">&#39;RNA_&#39;</span> <span class="o">+</span> <span class="n">alt_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">alt_model_fn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bio_samp_type</span> <span class="o">=</span> <span class="s1">&#39;DNA&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">alt_model_fn</span> <span class="o">=</span> <span class="n">ALTERNATE_MODELS</span><span class="p">[</span><span class="s1">&#39;DNA_&#39;</span> <span class="o">+</span> <span class="n">alt_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">alt_model_fn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">alt_model_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># get full filename path with setuptools</span>
        <span class="n">alt_model_fn</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span>
            <span class="s1">&#39;tombo&#39;</span><span class="p">,</span> <span class="s1">&#39;tombo_models/&#39;</span> <span class="o">+</span> <span class="n">alt_model_fn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alt_model_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">alt_model_fn</span><span class="p">):</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Tombo default model for &#39;</span> <span class="o">+</span> <span class="n">alt_name</span> <span class="o">+</span> <span class="s1">&#39; in &#39;</span> <span class="o">+</span>
            <span class="n">bio_samp_type</span> <span class="o">+</span> <span class="s1">&#39; does not exists.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</div>
    <span class="k">return</span> <span class="n">alt_model_fn</span><span class="p">,</span> <span class="n">bio_samp_type</span>

<div class="viewcode-block" id="load_alt_refs"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.load_alt_refs">[docs]</a><span class="k">def</span> <span class="nf">load_alt_refs</span><span class="p">(</span><span class="n">alt_names</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">bio_samp_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load several default alternative tombo models</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alt_fns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">alt_name</span> <span class="ow">in</span> <span class="n">alt_names</span><span class="p">:</span>
        <span class="n">alt_model_fn</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_default_alt_ref</span><span class="p">(</span>
            <span class="n">alt_name</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">bio_samp_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alt_model_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">alt_fns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alt_model_fn</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">parse_tombo_models</span><span class="p">(</span><span class="n">alt_fns</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">)</span>

<div class="viewcode-block" id="get_ref_from_seq"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.get_ref_from_seq">[docs]</a><span class="k">def</span> <span class="nf">get_ref_from_seq</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">rev_strand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alt_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">seq_kmers</span> <span class="o">=</span> <span class="p">[</span><span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">-</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="c1"># get stat lookups from seq on native strand then flip if rev_strand</span>
    <span class="k">if</span> <span class="n">rev_strand</span><span class="p">:</span>
        <span class="n">seq_kmers</span> <span class="o">=</span> <span class="n">seq_kmers</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">ref_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">std_ref</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">seq_kmers</span><span class="p">])</span>
    <span class="n">ref_sds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">std_ref</span><span class="o">.</span><span class="n">sds</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">seq_kmers</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">alt_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">alt_means</span><span class="p">,</span> <span class="n">alt_sds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alt_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">alt_ref</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">seq_kmers</span><span class="p">])</span>
        <span class="n">alt_sds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">alt_ref</span><span class="o">.</span><span class="n">sds</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">seq_kmers</span><span class="p">])</span>
</div>
    <span class="k">return</span> <span class="n">ref_means</span><span class="p">,</span> <span class="n">ref_sds</span><span class="p">,</span> <span class="n">alt_means</span><span class="p">,</span> <span class="n">alt_sds</span>

<div class="viewcode-block" id="calc_med_sd"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.calc_med_sd">[docs]</a><span class="k">def</span> <span class="nf">calc_med_sd</span><span class="p">(</span><span class="n">vals</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to compute median and standard deviation from a numpy array</span>
<span class="sd">    &quot;&quot;&quot;</span></div>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

<div class="viewcode-block" id="get_region_kmer_levels"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.get_region_kmer_levels">[docs]</a><span class="k">def</span> <span class="nf">get_region_kmer_levels</span><span class="p">(</span>
        <span class="n">reg_reads</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="p">,</span> <span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">,</span>
        <span class="n">cs_cov_thresh</span><span class="p">,</span> <span class="n">est_mean</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">strand</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute mean or median and standard deviation for each k-mer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cs_cov_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># sample reads until requested mean depth of coverage is achieved</span>
        <span class="n">cs_num_bases_thresh</span> <span class="o">=</span> <span class="n">region_size</span> <span class="o">*</span> <span class="n">cs_cov_thresh</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">reg_reads</span><span class="p">)</span>
        <span class="n">cumm_num_bases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="n">r_data</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span>
                                    <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">reg_reads</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cs_num_reads</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cumm_num_bases</span><span class="p">)</span>
                                 <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="n">cs_num_bases_thresh</span><span class="p">))</span>
            <span class="n">reg_reads</span> <span class="o">=</span> <span class="n">reg_reads</span><span class="p">[:</span><span class="n">cs_num_reads</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="c1"># if threshold is not met use all reads from region</span>
            <span class="k">pass</span>
    <span class="n">base_events</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_reads_events</span><span class="p">(</span><span class="n">reg_reads</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># get intervals within the region where coverage is high enough</span>
    <span class="c1"># for model estimation</span>
    <span class="n">reg_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">base_events</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="k">if</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">base_events</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reg_start</span><span class="p">,</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">region_size</span><span class="p">)])</span>
    <span class="n">cov_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[[</span><span class="kc">False</span><span class="p">],</span> <span class="n">reg_cov</span> <span class="o">&gt;</span> <span class="n">cov_thresh</span><span class="p">])))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">reg_cov</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cov_thresh</span><span class="p">:</span>
        <span class="c1"># if valid coverage goes until end of coverage, add the last</span>
        <span class="c1"># interval endpoint</span>
        <span class="n">cov_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">cov_intervals</span><span class="p">,</span> <span class="p">[</span><span class="n">region_size</span><span class="p">]])</span>
    <span class="k">if</span> <span class="n">cov_intervals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">cov_intervals</span> <span class="o">=</span> <span class="n">cov_intervals</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">kmer_width</span> <span class="o">=</span> <span class="n">upstrm_bases</span> <span class="o">+</span> <span class="n">dnstrm_bases</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">reg_kmer_levels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">),[])</span>
        <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">DNA_BASES</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">kmer_width</span><span class="p">))</span>
    <span class="c1"># upstream and downstream changes the sequence selection</span>
    <span class="c1"># depending on the strand</span>
    <span class="n">bb</span><span class="p">,</span> <span class="n">ab</span> <span class="o">=</span> <span class="p">(</span><span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">)</span> <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> \
             <span class="p">(</span><span class="n">dnstrm_bases</span><span class="p">,</span> <span class="n">upstrm_bases</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">int_start</span><span class="p">,</span> <span class="n">int_end</span> <span class="ow">in</span> <span class="n">cov_intervals</span><span class="p">:</span>
        <span class="n">int_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_seq_from_reads</span><span class="p">(</span>
            <span class="n">reg_start</span> <span class="o">+</span> <span class="n">int_start</span> <span class="o">-</span> <span class="n">bb</span><span class="p">,</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">int_end</span> <span class="o">+</span> <span class="n">ab</span><span class="p">,</span> <span class="n">reg_reads</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
            <span class="n">int_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">comp_seq</span><span class="p">(</span><span class="n">int_seq</span><span class="p">)</span>
        <span class="n">int_len</span> <span class="o">=</span> <span class="n">int_end</span> <span class="o">-</span> <span class="n">int_start</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">int_len</span><span class="p">):</span>
            <span class="n">pos_kmer</span> <span class="o">=</span> <span class="n">int_seq</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span><span class="o">+</span><span class="n">kmer_width</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">pos_kmer</span> <span class="o">=</span> <span class="n">pos_kmer</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">est_mean</span><span class="p">:</span>
                    <span class="n">reg_kmer_levels</span><span class="p">[</span><span class="n">pos_kmer</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_mean_std</span><span class="p">(</span>
                        <span class="n">base_events</span><span class="p">[</span><span class="n">reg_start</span><span class="o">+</span><span class="n">pos</span><span class="o">+</span><span class="n">int_start</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reg_kmer_levels</span><span class="p">[</span><span class="n">pos_kmer</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calc_med_sd</span><span class="p">(</span>
                        <span class="n">base_events</span><span class="p">[</span><span class="n">reg_start</span><span class="o">+</span><span class="n">pos</span><span class="o">+</span><span class="n">int_start</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>
</div>
    <span class="k">return</span> <span class="n">reg_kmer_levels</span>

<span class="k">def</span> <span class="nf">_est_kmer_model_worker</span><span class="p">(</span>
        <span class="n">region_q</span><span class="p">,</span> <span class="n">kmer_level_q</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="p">,</span>
        <span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">,</span> <span class="n">cs_cov_thresh</span><span class="p">,</span> <span class="n">est_mean</span><span class="p">,</span> <span class="n">region_size</span><span class="p">):</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">region_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">reg_start</span> <span class="o">=</span> <span class="n">region_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">reg_reads</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_data</span> <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span>
                     <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">region_size</span> <span class="ow">or</span>
                             <span class="n">r_data</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">reg_start</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_reads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">continue</span>

        <span class="n">reg_kmer_levels</span> <span class="o">=</span> <span class="n">get_region_kmer_levels</span><span class="p">(</span>
            <span class="n">reg_reads</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="p">,</span> <span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">,</span>
            <span class="n">cs_cov_thresh</span><span class="p">,</span> <span class="n">est_mean</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reg_kmer_levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kmer_level_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">reg_kmer_levels</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">return</span>

<span class="k">if</span> <span class="n">_PROFILE_EST_REF</span><span class="p">:</span>
    <span class="n">_est_kmer_model_wrapper</span> <span class="o">=</span> <span class="n">_est_kmer_model_worker</span>
    <span class="k">def</span> <span class="nf">_est_kmer_model_worker</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">cProfile</span>
        <span class="n">cProfile</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span><span class="s1">&#39;_est_kmer_model_wrapper(*args)&#39;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span>
                        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;est_kmer_model.prof&#39;</span><span class="p">)</span>
        <span class="k">return</span>

<div class="viewcode-block" id="estimate_kmer_model"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.estimate_kmer_model">[docs]</a><span class="k">def</span> <span class="nf">estimate_kmer_model</span><span class="p">(</span>
        <span class="n">f5_dirs</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">,</span>
        <span class="n">kmer_ref_fn</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="p">,</span> <span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">,</span> <span class="n">min_kmer_obs</span><span class="p">,</span>
        <span class="n">kmer_specific_sd</span><span class="p">,</span> <span class="n">cs_cov_thresh</span><span class="p">,</span> <span class="n">est_mean</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate a standard tombo k-mer model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raw_read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">f5_dirs</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
    <span class="n">chrm_sizes</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_chrm_sizes</span><span class="p">(</span><span class="n">raw_read_coverage</span><span class="p">)</span>

    <span class="n">manager</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
    <span class="n">region_q</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">kmer_level_q</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">num_regions</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">chrm_len</span> <span class="ow">in</span> <span class="n">chrm_sizes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">plus_covered</span> <span class="o">=</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span>
        <span class="n">minus_covered</span> <span class="o">=</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span>
        <span class="k">for</span> <span class="n">reg_start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">chrm_len</span><span class="p">,</span> <span class="n">region_size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">plus_covered</span><span class="p">:</span>
                <span class="n">region_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">chrm</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">))</span>
                <span class="n">num_regions</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">minus_covered</span><span class="p">:</span>
                <span class="n">region_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">chrm</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">))</span>
                <span class="n">num_regions</span> <span class="o">+=</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s1">&#39;Extracting average kmer levels across &#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">num_regions</span><span class="p">)</span> <span class="o">+</span>
            <span class="s1">&#39; regions. (Will print a dot or each batch completed)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">est_args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">region_q</span><span class="p">,</span> <span class="n">kmer_level_q</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="p">,</span>
        <span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">,</span> <span class="n">cs_cov_thresh</span><span class="p">,</span> <span class="n">est_mean</span><span class="p">,</span> <span class="n">region_size</span><span class="p">)</span>
    <span class="n">est_ps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_processes</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_est_kmer_model_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">est_args</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">est_ps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="n">all_reg_kmer_levels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">est_ps</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reg_kmer_levels</span> <span class="o">=</span> <span class="n">kmer_level_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">all_reg_kmer_levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_kmer_levels</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">continue</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">kmer_level_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">reg_kmer_levels</span> <span class="o">=</span> <span class="n">kmer_level_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">all_reg_kmer_levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_kmer_levels</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_reg_kmer_levels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;No genomic positions contain --minimum-test-reads. Consider &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;setting this option to a lower value.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Tabulating k-mer model statistics.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">all_kmer_mean_sds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">kmer_width</span> <span class="o">=</span> <span class="n">upstrm_bases</span> <span class="o">+</span> <span class="n">dnstrm_bases</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">_DEBUG_EST_STD</span><span class="p">:</span>
        <span class="n">kmer_dens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">save_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">KERNEL_DENSITY_RANGE</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">KERNEL_DENSITY_RANGE</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">_DEBUG_EST_NUM_KMER_SAVE</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">DNA_BASES</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">kmer_width</span><span class="p">):</span>
        <span class="n">kmer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">)</span>
        <span class="n">kmer_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
            <span class="n">reg_kmer_levels</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="k">for</span> <span class="n">reg_kmer_levels</span> <span class="ow">in</span> <span class="n">all_reg_kmer_levels</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_kmer_levels</span><span class="p">[</span><span class="n">kmer</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">kmer_levels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_kmer_obs</span><span class="p">:</span>
            <span class="n">min_obs</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reg_levs</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">)])</span>
                    <span class="k">for</span> <span class="n">reg_levs</span> <span class="ow">in</span> <span class="n">all_reg_kmer_levels</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">DNA_BASES</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">kmer_width</span><span class="p">))</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;K-mers represeneted in fewer observations than &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;requested in the provided reads. Consider a shorter &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;k-mer or providing more reads.</span><span class="se">\n\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">min_obs</span><span class="p">)</span> <span class="o">+</span>
                <span class="s1">&#39; observations found in least common kmer.&#39;</span><span class="p">)</span>
        <span class="n">all_kmer_mean_sds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kmer</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">kmer_levels</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">kmer_levels</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">if</span> <span class="n">_DEBUG_EST_STD</span><span class="p">:</span>
            <span class="n">kmer_kde</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span>
                <span class="n">kmer_levels</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">bw_method</span><span class="o">=</span><span class="n">_DEBUG_EST_BW</span> <span class="o">/</span> <span class="n">kmer_levels</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                <span class="n">kmer_dens</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kmer</span><span class="p">,</span> <span class="n">kmer_kde</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">save_x</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">_DEBUG_EST_STD</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;debug_est_standard_ref.density.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Kmer</span><span class="se">\t</span><span class="s1">Signal</span><span class="se">\t</span><span class="s1">Density</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)))</span>
                               <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">dens_i</span> <span class="ow">in</span> <span class="n">kmer_dens</span>
                               <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">save_x</span><span class="p">,</span> <span class="n">dens_i</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Explicity use btype string names for py3 compatiblity as well as</span>
    <span class="c1"># pickle-ability of numpy arrays for consistency. See discussion here:</span>
    <span class="c1"># https://github.com/numpy/numpy/issues/2407</span>
    <span class="n">kmer_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">all_kmer_mean_sds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;kmer&#39;</span><span class="p">),</span> <span class="s1">&#39;S&#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">kmer_width</span><span class="p">)),</span>
                                  <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;sd&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">)])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">kmer_specific_sd</span><span class="p">:</span>
        <span class="n">kmer_ref</span><span class="p">[</span><span class="s1">&#39;sd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">kmer_ref</span><span class="p">[</span><span class="s1">&#39;sd&#39;</span><span class="p">])</span>
    <span class="n">write_tombo_model</span><span class="p">(</span><span class="n">kmer_ref</span><span class="p">,</span> <span class="n">kmer_ref_fn</span><span class="p">,</span> <span class="n">upstrm_bases</span><span class="p">)</span>
</div>
    <span class="k">return</span>


<span class="c1">########################################</span>
<span class="c1">##### Alternative Model Estimation #####</span>
<span class="c1">########################################</span>

<span class="k">def</span> <span class="nf">_parse_base_levels_worker</span><span class="p">(</span>
        <span class="n">reads_q</span><span class="p">,</span> <span class="n">kmer_level_q</span><span class="p">,</span> <span class="n">kmer_width</span><span class="p">,</span> <span class="n">central_pos</span><span class="p">,</span> <span class="n">completed_kmers</span><span class="p">):</span>
    <span class="n">dnstrm_bases</span> <span class="o">=</span> <span class="n">kmer_width</span> <span class="o">-</span> <span class="n">central_pos</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">proc_kmer_levels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">),</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">DNA_BASES</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">kmer_width</span><span class="p">))</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">reads_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r_fn</span><span class="p">,</span> <span class="n">corr_slot</span> <span class="o">=</span> <span class="n">reads_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">r_fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">fast5_data</span><span class="p">:</span>
            <span class="n">r_means</span><span class="p">,</span> <span class="n">r_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_multiple_slots_read_centric</span><span class="p">(</span>
                <span class="n">fast5_data</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;norm_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">],</span> <span class="n">corr_slot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r_means</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">r_seq</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r_seq</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">(</span><span class="n">r_seq</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">kmer_width</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r_seq</span><span class="p">)</span> <span class="o">-</span> <span class="n">kmer_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="n">r_means</span><span class="p">[</span><span class="n">central_pos</span><span class="p">:</span><span class="o">-</span><span class="n">dnstrm_bases</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">completed_kmers</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">proc_kmer_levels</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

    <span class="n">kmer_level_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">proc_kmer_levels</span><span class="p">)</span>

    <span class="k">return</span>

<div class="viewcode-block" id="get_batch_kmer_levels"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.get_batch_kmer_levels">[docs]</a><span class="k">def</span> <span class="nf">get_batch_kmer_levels</span><span class="p">(</span>
        <span class="n">reads_q</span><span class="p">,</span> <span class="n">kmer_level_q</span><span class="p">,</span> <span class="n">all_reads</span><span class="p">,</span> <span class="n">parse_levels_batch_size</span><span class="p">,</span>
        <span class="n">std_ref</span><span class="p">,</span> <span class="n">completed_kmers</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">):</span>
    <span class="n">no_more_reads</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parse_levels_batch_size</span><span class="p">):</span>
            <span class="n">r_data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">all_reads</span><span class="p">)</span>
            <span class="n">reads_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">r_data</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="n">r_data</span><span class="o">.</span><span class="n">corr_group</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="n">no_more_reads</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">base_lev_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">reads_q</span><span class="p">,</span> <span class="n">kmer_level_q</span><span class="p">,</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">,</span>
                     <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">,</span> <span class="n">completed_kmers</span><span class="p">)</span>
    <span class="n">base_lev_ps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_processes</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_parse_base_levels_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">base_lev_args</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">base_lev_ps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="n">batch_kmer_levels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">base_lev_ps</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">proc_kmer_levels</span> <span class="o">=</span> <span class="n">kmer_level_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">batch_kmer_levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proc_kmer_levels</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">continue</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">kmer_level_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">proc_kmer_levels</span> <span class="o">=</span> <span class="n">kmer_level_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">batch_kmer_levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proc_kmer_levels</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">batch_kmer_levels</span><span class="p">,</span> <span class="n">no_more_reads</span>

<div class="viewcode-block" id="parse_base_levels"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.parse_base_levels">[docs]</a><span class="k">def</span> <span class="nf">parse_base_levels</span><span class="p">(</span>
        <span class="n">all_reads</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">parse_levels_batch_size</span><span class="p">,</span> <span class="n">kmer_obs_thresh</span><span class="p">,</span>
        <span class="n">max_kmer_obs</span><span class="p">,</span> <span class="n">min_kmer_obs_to_est</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse base levels and store grouped by k-mer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
    <span class="n">reads_q</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">kmer_level_q</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="n">all_kmer_levels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">),</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">DNA_BASES</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">))</span>
    <span class="c1"># store set of k-mers with enough observations to save on memory footprint</span>
    <span class="c1"># while filling more rare k-mers</span>
    <span class="n">completed_kmers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">all_reads</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">all_reads</span><span class="p">)</span>
    <span class="n">n_batches</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">batch_kmer_levels</span><span class="p">,</span> <span class="n">no_more_reads</span> <span class="o">=</span> <span class="n">get_batch_kmer_levels</span><span class="p">(</span>
            <span class="n">reads_q</span><span class="p">,</span> <span class="n">kmer_level_q</span><span class="p">,</span> <span class="n">all_reads</span><span class="p">,</span> <span class="n">parse_levels_batch_size</span><span class="p">,</span>
            <span class="n">std_ref</span><span class="p">,</span> <span class="n">completed_kmers</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">)</span>

        <span class="c1"># only add observations for k-mers that have not been seen enough times</span>
        <span class="c1"># save memory for abundent k-mers</span>
        <span class="n">batch_total_kmers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_kmer_levels</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">completed_kmers</span><span class="p">):</span>
            <span class="n">all_kmer_levels</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span>
                <span class="n">kmer_level</span> <span class="k">for</span> <span class="n">proc_kmer_levels</span> <span class="ow">in</span> <span class="n">batch_kmer_levels</span>
                <span class="k">for</span> <span class="n">kmer_level</span> <span class="ow">in</span> <span class="n">proc_kmer_levels</span><span class="p">[</span><span class="n">kmer</span><span class="p">]))</span>
            <span class="n">batch_total_kmers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_kmer_levels</span><span class="p">[</span><span class="n">kmer</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">batch_total_kmers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_kmer_obs</span><span class="p">:</span>
                <span class="n">completed_kmers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">kmer</span><span class="p">)</span>

        <span class="n">curr_min_kmer_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">batch_total_kmers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">curr_min_kmer_count</span> <span class="o">&gt;</span> <span class="n">kmer_obs_thresh</span> <span class="ow">or</span> <span class="n">no_more_reads</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">n_batches</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">n_batches</span> <span class="o">*</span> <span class="n">parse_levels_batch_size</span><span class="p">)</span> <span class="o">+</span>
                <span class="s1">&#39; reads processed. Current minimum k-mer observations: &#39;</span> <span class="o">+</span>
                <span class="n">unicode</span><span class="p">(</span><span class="n">curr_min_kmer_count</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; towards goal of &#39;</span> <span class="o">+</span>
                <span class="n">unicode</span><span class="p">(</span><span class="n">kmer_obs_thresh</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">fewest_kmer_obs</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kmer_levels</span><span class="p">)</span> <span class="k">for</span> <span class="n">kmer_levels</span> <span class="ow">in</span>
                          <span class="n">all_kmer_levels</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">fewest_kmer_obs</span> <span class="o">&lt;</span> <span class="n">kmer_obs_thresh</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fewest_kmer_obs</span> <span class="o">&lt;</span> <span class="n">min_kmer_obs_to_est</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Too few minimal k-mer observations to continue to &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;alternative estimation. Minimal k-mer has &#39;</span> <span class="o">+</span>
                <span class="n">unicode</span><span class="p">(</span><span class="n">fewest_kmer_obs</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; total observations and &#39;</span> <span class="o">+</span>
                <span class="n">unicode</span><span class="p">(</span><span class="n">min_kmer_obs_to_est</span><span class="p">)</span> <span class="o">+</span>
                <span class="s1">&#39; observations per k-mer are required.&#39;</span><span class="p">)</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Requested minimal k-mer observations not found in all reads. &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;Continuing to estimation using a k-mer with &#39;</span> <span class="o">+</span>
            <span class="n">unicode</span><span class="p">(</span><span class="n">fewest_kmer_obs</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; total observations&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">all_kmer_levels</span>

<div class="viewcode-block" id="write_kmer_densities_file"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.write_kmer_densities_file">[docs]</a><span class="k">def</span> <span class="nf">write_kmer_densities_file</span><span class="p">(</span><span class="n">dens_fn</span><span class="p">,</span> <span class="n">kmer_dens</span><span class="p">,</span> <span class="n">save_x</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dens_fn</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Kmer</span><span class="se">\t</span><span class="s1">Signal</span><span class="se">\t</span><span class="s1">Density</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)))</span>
                           <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">dens_i</span> <span class="ow">in</span> <span class="n">kmer_dens</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                           <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">save_x</span><span class="p">,</span> <span class="n">dens_i</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="parse_kmer_densities_file"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.parse_kmer_densities_file">[docs]</a><span class="k">def</span> <span class="nf">parse_kmer_densities_file</span><span class="p">(</span><span class="n">dens_fn</span><span class="p">):</span>
    <span class="n">kmer_dens_raw</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dens_fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">dens_fp</span><span class="p">:</span>
        <span class="c1"># read in header</span>
        <span class="n">dens_fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dens_fp</span><span class="p">:</span>
            <span class="n">kmer</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dens_i</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">kmer_dens_raw</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dens_i</span><span class="p">))</span>

    <span class="n">kmer_dens</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">first_len</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">dens_i</span> <span class="ow">in</span> <span class="n">kmer_dens_raw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">first_len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">first_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dens_i</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dens_i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">first_len</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span><span class="s1">&#39;Density file is valid.&#39;</span><span class="p">)</span>
        <span class="n">kmer_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dens_i</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">kmer_dens</span>

<div class="viewcode-block" id="est_kernel_density"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.est_kernel_density">[docs]</a><span class="k">def</span> <span class="nf">est_kernel_density</span><span class="p">(</span>
        <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">kmer_obs_thresh</span><span class="p">,</span>
        <span class="n">density_basename</span><span class="p">,</span> <span class="n">save_x</span><span class="p">,</span> <span class="n">kernel_dens_bw</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">,</span>
        <span class="n">alt_or_stnd_name</span><span class="o">=</span><span class="s1">&#39;alt&#39;</span><span class="p">,</span> <span class="n">parse_levels_batch_size</span><span class="o">=</span><span class="n">ALT_EST_BATCH</span><span class="p">,</span>
        <span class="n">max_kmer_obs</span><span class="o">=</span><span class="n">MAX_KMER_OBS</span><span class="p">,</span> <span class="n">min_kmer_obs_to_est</span><span class="o">=</span><span class="n">MIN_KMER_OBS_TO_EST</span><span class="p">):</span>
    <span class="n">all_reads</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_data</span> <span class="k">for</span> <span class="n">cs_reads</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                 <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">cs_reads</span><span class="p">]</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">all_reads</span><span class="p">)</span>
    <span class="n">base_levels</span> <span class="o">=</span> <span class="n">parse_base_levels</span><span class="p">(</span>
        <span class="n">all_reads</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">parse_levels_batch_size</span><span class="p">,</span> <span class="n">kmer_obs_thresh</span><span class="p">,</span>
        <span class="n">max_kmer_obs</span><span class="p">,</span> <span class="n">min_kmer_obs_to_est</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Fitting kernel densities for k-mer levels</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">kmer_dens</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">norm_levels</span> <span class="ow">in</span> <span class="n">base_levels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">norm_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">norm_levels</span><span class="p">)</span>
        <span class="n">kmer_kde</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span>
            <span class="n">norm_levels</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="n">kernel_dens_bw</span> <span class="o">/</span> <span class="n">norm_levels</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">kmer_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmer_kde</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">save_x</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">density_basename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">write_kmer_densities_file</span><span class="p">(</span>
            <span class="n">density_basename</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">alt_or_stnd_name</span> <span class="o">+</span> <span class="s1">&#39;_density.txt&#39;</span><span class="p">,</span>
            <span class="n">kmer_dens</span><span class="p">,</span> <span class="n">save_x</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">kmer_dens</span>

<div class="viewcode-block" id="estimate_kmer_densities"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.estimate_kmer_densities">[docs]</a><span class="k">def</span> <span class="nf">estimate_kmer_densities</span><span class="p">(</span>
        <span class="n">f5_dirs</span><span class="p">,</span> <span class="n">control_dirs</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">,</span>
        <span class="n">standard_ref_fn</span><span class="p">,</span> <span class="n">bio_samp_type</span><span class="p">,</span> <span class="n">kmer_obs_thresh</span><span class="p">,</span> <span class="n">density_basename</span><span class="p">,</span>
        <span class="n">kernel_dens_bw</span><span class="p">,</span> <span class="n">save_x</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">):</span>
    <span class="n">raw_read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">f5_dirs</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
    <span class="n">cntrl_read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">control_dirs</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Parsing standard model file</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">standard_ref_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">standard_ref_fn</span><span class="p">,</span> <span class="n">bio_samp_type</span> <span class="o">=</span> <span class="n">get_default_standard_ref</span><span class="p">(</span>
            <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">bio_samp_type</span><span class="p">)</span>
    <span class="n">std_ref</span> <span class="o">=</span> <span class="n">TomboModel</span><span class="p">(</span><span class="n">standard_ref_fn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Parsing base levels from alternative reads</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">alt_dens</span> <span class="o">=</span> <span class="n">est_kernel_density</span><span class="p">(</span>
        <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">kmer_obs_thresh</span><span class="p">,</span> <span class="n">density_basename</span><span class="p">,</span>
        <span class="n">save_x</span><span class="p">,</span> <span class="n">kernel_dens_bw</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">,</span> <span class="s1">&#39;alternate&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Parsing base levels from standard reads</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">std_dens</span> <span class="o">=</span> <span class="n">est_kernel_density</span><span class="p">(</span>
        <span class="n">cntrl_read_coverage</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">kmer_obs_thresh</span><span class="p">,</span> <span class="n">density_basename</span><span class="p">,</span>
        <span class="n">save_x</span><span class="p">,</span> <span class="n">kernel_dens_bw</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">,</span> <span class="s1">&#39;control&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">alt_dens</span><span class="p">,</span> <span class="n">std_dens</span><span class="p">,</span> <span class="n">std_ref</span>

<div class="viewcode-block" id="load_kmer_densities"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.load_kmer_densities">[docs]</a><span class="k">def</span> <span class="nf">load_kmer_densities</span><span class="p">(</span>
        <span class="n">alt_dens_fn</span><span class="p">,</span> <span class="n">std_dens_fn</span><span class="p">,</span> <span class="n">f5_dirs</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span>
        <span class="n">basecall_subgroups</span><span class="p">,</span> <span class="n">std_ref_fn</span><span class="p">,</span> <span class="n">bio_samp_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Parsing standard model file</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">std_ref_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f5_dirs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bio_samp_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Must provide a FAST5s directory, a canonical model &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;file or spcify the biological sample type.&#39;</span><span class="p">)</span>
        <span class="n">raw_read_coverage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">f5_dirs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">raw_read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
                <span class="n">f5_dirs</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
        <span class="n">std_ref_fn</span><span class="p">,</span> <span class="n">bio_samp_type</span> <span class="o">=</span> <span class="n">get_default_standard_ref</span><span class="p">(</span>
            <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">bio_samp_type</span><span class="p">)</span>
    <span class="n">std_ref</span> <span class="o">=</span> <span class="n">TomboModel</span><span class="p">(</span><span class="n">std_ref_fn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Parsing density files</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">alt_dens</span> <span class="o">=</span> <span class="n">parse_kmer_densities_file</span><span class="p">(</span><span class="n">alt_dens_fn</span><span class="p">)</span>
    <span class="n">std_dens</span> <span class="o">=</span> <span class="n">parse_kmer_densities_file</span><span class="p">(</span><span class="n">std_dens_fn</span><span class="p">)</span>
    <span class="n">num_dens_points</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">alt_dens</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">num_dens_points</span> <span class="o">!=</span> <span class="nb">next</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">std_dens</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Alternative and standard density &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;estimates do not correspond.&#39;</span><span class="p">)</span>

    <span class="n">save_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">KERNEL_DENSITY_RANGE</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">KERNEL_DENSITY_RANGE</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                         <span class="n">num_dens_points</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">alt_dens</span><span class="p">,</span> <span class="n">std_dens</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">save_x</span>

<div class="viewcode-block" id="isolate_alt_density"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.isolate_alt_density">[docs]</a><span class="k">def</span> <span class="nf">isolate_alt_density</span><span class="p">(</span>
        <span class="n">alt_dens</span><span class="p">,</span> <span class="n">std_dens</span><span class="p">,</span> <span class="n">alt_base</span><span class="p">,</span> <span class="n">alt_frac_pctl</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">save_x</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">calc_mean</span><span class="p">(</span><span class="n">dens</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">save_x</span><span class="p">[</span><span class="n">dens</span><span class="o">&gt;</span><span class="mf">1e-10</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">dens</span><span class="p">[</span><span class="n">dens</span><span class="o">&gt;</span><span class="mf">1e-10</span><span class="p">])</span>


    <span class="c1"># estimate density shift from k-mers without the alternate base</span>
    <span class="n">no_alt_std_means</span><span class="p">,</span> <span class="n">no_alt_mean_diffs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">std_dens</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">alt_base</span> <span class="ow">in</span> <span class="n">kmer</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">no_alt_std_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calc_mean</span><span class="p">(</span><span class="n">std_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">]))</span>
        <span class="n">kmer_alt_mean</span> <span class="o">=</span> <span class="n">calc_mean</span><span class="p">(</span><span class="n">alt_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">])</span>
        <span class="n">no_alt_mean_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kmer_alt_mean</span> <span class="o">-</span> <span class="n">no_alt_std_means</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">calc_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">no_alt_std_means</span><span class="p">,</span> <span class="n">no_alt_mean_diffs</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">save_x_unit</span> <span class="o">=</span> <span class="n">save_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">save_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">shifted_alt_dens</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">kmer_alt_dens</span> <span class="ow">in</span> <span class="n">alt_dens</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">est_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">calc_offset</span><span class="p">(</span><span class="n">calc_mean</span><span class="p">(</span><span class="n">std_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">]))</span> <span class="o">/</span> <span class="n">save_x_unit</span><span class="p">)</span>
        <span class="c1"># if std density mean is estimated to be greater</span>
        <span class="k">if</span> <span class="n">est_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># shift alt dens to the right</span>
            <span class="n">shifted_alt_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                <span class="p">[</span><span class="mf">0.0</span><span class="p">,]</span> <span class="o">*</span> <span class="o">-</span><span class="n">est_offset</span><span class="p">,</span> <span class="n">kmer_alt_dens</span><span class="p">[:</span><span class="n">est_offset</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># else shift alt dens to the left</span>
            <span class="n">shifted_alt_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                <span class="n">kmer_alt_dens</span><span class="p">[</span><span class="n">est_offset</span><span class="p">:],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,]</span> <span class="o">*</span> <span class="n">est_offset</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_peak_frac</span><span class="p">(</span><span class="n">kmer_std_dens</span><span class="p">,</span> <span class="n">kmer_alt_dens</span><span class="p">):</span>
        <span class="c1"># find highest peak in standard density</span>
        <span class="n">std_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">kmer_std_dens</span><span class="p">)</span>

        <span class="c1"># find closest peak in alternative density</span>
        <span class="n">alt_local_peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
            <span class="p">[</span><span class="kc">False</span><span class="p">,],</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">kmer_alt_dens</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">kmer_alt_dens</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">kmer_alt_dens</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">kmer_alt_dens</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">+</span> <span class="p">[</span><span class="kc">False</span><span class="p">,]]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">matched_alt_peak</span> <span class="o">=</span> <span class="n">alt_local_peaks</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alt_local_peaks</span> <span class="o">-</span> <span class="n">std_peak</span><span class="p">))]</span>
        <span class="k">return</span> <span class="n">kmer_alt_dens</span><span class="p">[</span><span class="n">matched_alt_peak</span><span class="p">]</span> <span class="o">/</span> <span class="n">kmer_std_dens</span><span class="p">[</span><span class="n">std_peak</span><span class="p">]</span>


    <span class="c1"># estimate the alternative base incorporation rate</span>
    <span class="n">std_frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">([</span>
        <span class="n">get_peak_frac</span><span class="p">(</span><span class="n">std_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">],</span> <span class="n">shifted_alt_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">std_dens</span> <span class="k">if</span> <span class="n">kmer</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">alt_base</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">alt_frac_pctl</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s1">&#39;Alternative base incorporation rate estimate: &#39;</span> <span class="o">+</span>
            <span class="n">unicode</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">std_frac</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">std_frac</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Alternative base incorporation rate &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;estimate is approximately 0. Consider lowering &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;--alt-fraction-percentile.&#39;</span><span class="p">)</span>

    <span class="c1"># get mean model SD. most models will be constant, but use mean in case</span>
    <span class="n">model_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">std_ref</span><span class="o">.</span><span class="n">sds</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="c1"># subtract off fraction of standard density from alt density</span>
    <span class="c1"># to estimate mean of isolated alternative distribution</span>
    <span class="n">alt_ref</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">std_level</span> <span class="ow">in</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">means</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">kmer</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">alt_base</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">alt_ref</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kmer</span><span class="p">,</span> <span class="n">std_level</span><span class="p">,</span> <span class="n">model_sd</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="c1"># assuming random incorporation the prortion of standard base</span>
        <span class="c1"># observations at this k-mer is the standard fraction raised</span>
        <span class="c1"># to the number of alt_base occurences in the k-mer</span>
        <span class="n">kmer_std_frac</span> <span class="o">=</span> <span class="n">std_frac</span><span class="o">**</span><span class="n">kmer</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">alt_base</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">diff_dens</span> <span class="o">=</span> <span class="n">shifted_alt_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span>
                <span class="n">std_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">*</span> <span class="n">kmer_std_frac</span><span class="p">)</span>
            <span class="n">diff_dens</span><span class="p">[</span><span class="n">diff_dens</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">alt_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">save_x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">diff_dens</span><span class="p">)</span>
        <span class="n">alt_ref</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kmer</span><span class="p">,</span> <span class="n">alt_level</span><span class="p">,</span> <span class="n">model_sd</span><span class="p">))</span>

    <span class="n">alt_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">alt_ref</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;kmer&#39;</span><span class="p">),</span> <span class="s1">&#39;S&#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">)),</span>
        <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;sd&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">)])</span>
</div>
    <span class="k">return</span> <span class="n">alt_ref</span>

<span class="k">def</span> <span class="nf">estimate_alt_model</span><span class="p">(</span>
        <span class="n">f5_dirs</span><span class="p">,</span> <span class="n">control_dirs</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">,</span>
        <span class="n">std_ref_fn</span><span class="p">,</span> <span class="n">bio_samp_type</span><span class="p">,</span> <span class="n">alt_base</span><span class="p">,</span> <span class="n">alt_frac_pctl</span><span class="p">,</span>
        <span class="n">kmer_obs_thresh</span><span class="p">,</span> <span class="n">density_basename</span><span class="p">,</span> <span class="n">kernel_dens_bw</span><span class="p">,</span> <span class="n">alt_dens_fn</span><span class="p">,</span>
        <span class="n">std_dens_fn</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">,</span> <span class="n">num_dens_points</span><span class="o">=</span><span class="n">NUM_DENS_POINTS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate an alternative model from a sample with a single,</span>
<span class="sd">    known, randomly-incorporated alternative base</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">alt_dens_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">std_dens_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">save_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">KERNEL_DENSITY_RANGE</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">KERNEL_DENSITY_RANGE</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">num_dens_points</span><span class="p">)</span>
        <span class="n">alt_dens</span><span class="p">,</span> <span class="n">std_dens</span><span class="p">,</span> <span class="n">std_ref</span> <span class="o">=</span> <span class="n">estimate_kmer_densities</span><span class="p">(</span>
            <span class="n">f5_dirs</span><span class="p">,</span> <span class="n">control_dirs</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">,</span>
            <span class="n">std_ref_fn</span><span class="p">,</span> <span class="n">bio_samp_type</span><span class="p">,</span> <span class="n">kmer_obs_thresh</span><span class="p">,</span> <span class="n">density_basename</span><span class="p">,</span>
            <span class="n">kernel_dens_bw</span><span class="p">,</span> <span class="n">save_x</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alt_dens</span><span class="p">,</span> <span class="n">std_dens</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">save_x</span> <span class="o">=</span> <span class="n">load_kmer_densities</span><span class="p">(</span>
            <span class="n">alt_dens_fn</span><span class="p">,</span> <span class="n">std_dens_fn</span><span class="p">,</span> <span class="n">f5_dirs</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span>
            <span class="n">basecall_subgroups</span><span class="p">,</span> <span class="n">std_ref_fn</span><span class="p">,</span> <span class="n">bio_samp_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Isolating alternative base distribtuions</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># perform alternative density isolation algorithm</span>
    <span class="n">alt_ref</span> <span class="o">=</span> <span class="n">isolate_alt_density</span><span class="p">(</span>
        <span class="n">alt_dens</span><span class="p">,</span> <span class="n">std_dens</span><span class="p">,</span> <span class="n">alt_base</span><span class="p">,</span> <span class="n">alt_frac_pctl</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">save_x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">alt_ref</span><span class="p">,</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span>

<span class="k">if</span> <span class="n">_PROFILE_ALT_EST</span><span class="p">:</span>
    <span class="n">_est_alt_wrapper</span> <span class="o">=</span> <span class="n">estimate_alt_model</span>
<div class="viewcode-block" id="estimate_alt_model"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.estimate_alt_model">[docs]</a>    <span class="k">def</span> <span class="nf">estimate_alt_model</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">cProfile</span>
        <span class="n">cProfile</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span><span class="s1">&#39;_est_alt_wrapper(*args)&#39;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span>
                        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;est_alt_model.prof&#39;</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>


<span class="c1">####################################</span>
<span class="c1">##### Core Statistical Testing #####</span>
<span class="c1">####################################</span>

<div class="viewcode-block" id="p_value_to_z_score"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.p_value_to_z_score">[docs]</a><span class="k">def</span> <span class="nf">p_value_to_z_score</span><span class="p">(</span><span class="n">pvalue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to convert p-value to z-score</span>
<span class="sd">    &quot;&quot;&quot;</span></div>
    <span class="k">return</span> <span class="o">-</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">pvalue</span><span class="p">)</span>

<div class="viewcode-block" id="z_score_to_p_value"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.z_score_to_p_value">[docs]</a><span class="k">def</span> <span class="nf">z_score_to_p_value</span><span class="p">(</span><span class="n">zscore</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to convert z-score to p-value</span>
<span class="sd">    &quot;&quot;&quot;</span></div>
    <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">zscore</span><span class="p">)</span>

<div class="viewcode-block" id="correct_multiple_testing"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.correct_multiple_testing">[docs]</a><span class="k">def</span> <span class="nf">correct_multiple_testing</span><span class="p">(</span><span class="n">pvals</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use FDR Benjamini-Hochberg multiple testing correction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span>

    <span class="n">pvals_sortind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span>
    <span class="n">pvals_sorted</span> <span class="o">=</span> <span class="n">pvals</span><span class="p">[</span><span class="n">pvals_sortind</span><span class="p">]</span>
    <span class="n">sortrevind</span> <span class="o">=</span> <span class="n">pvals_sortind</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>

    <span class="n">nobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span>
    <span class="n">ecdffcator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nobs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">nobs</span>
    <span class="c1"># ignore underflow values</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">pvals_corrected_raw</span> <span class="o">=</span> <span class="n">pvals_sorted</span> <span class="o">/</span> <span class="n">ecdffcator</span>
    <span class="n">pvals_corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span>
        <span class="n">pvals_corrected_raw</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">pvals_corrected_raw</span>
    <span class="n">pvals_corrected</span><span class="p">[</span><span class="n">pvals_corrected</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</div>
    <span class="k">return</span> <span class="n">pvals_corrected</span><span class="p">[</span><span class="n">sortrevind</span><span class="p">]</span>

<div class="viewcode-block" id="calc_vectorized_fm_pvals"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.calc_vectorized_fm_pvals">[docs]</a><span class="k">def</span> <span class="nf">calc_vectorized_fm_pvals</span><span class="p">(</span><span class="n">split_pvals</span><span class="p">,</span> <span class="n">filter_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Fisher&#39;s Method p-values in a vectorized fashion</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filter_nan</span><span class="p">:</span>
        <span class="n">chi_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">base_pvals</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">base_pvals</span><span class="p">)]))</span> <span class="o">*</span> <span class="o">-</span><span class="mi">2</span>
                     <span class="k">for</span> <span class="n">base_pvals</span> <span class="ow">in</span> <span class="n">split_pvals</span><span class="p">]</span>
        <span class="n">chi_shapes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">base_pvals</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">base_pvals</span> <span class="ow">in</span> <span class="n">split_pvals</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chi_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">base_pvals</span><span class="p">))</span> <span class="o">*</span> <span class="o">-</span><span class="mi">2</span>
                     <span class="k">for</span> <span class="n">base_pvals</span> <span class="ow">in</span> <span class="n">split_pvals</span><span class="p">]</span>
        <span class="n">chi_shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_pvals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
                     <span class="k">for</span> <span class="n">base_pvals</span> <span class="ow">in</span> <span class="n">split_pvals</span><span class="p">]</span>

    <span class="n">f_pvals</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">chi_stats</span><span class="p">,</span> <span class="n">chi_shapes</span><span class="p">)</span></div>
    <span class="k">return</span> <span class="n">f_pvals</span>

<div class="viewcode-block" id="calc_window_fishers_method"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.calc_window_fishers_method">[docs]</a><span class="k">def</span> <span class="nf">calc_window_fishers_method</span><span class="p">(</span><span class="n">pvals</span><span class="p">,</span> <span class="n">lag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Fisher&#39;s Method over a moving window across a set of p-values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">lag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Invalid p-value window provided.&#39;</span>
    <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">lag</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">pvals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;P-values vector too short for Fisher&#39;s Method &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;window compuation.&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">pvals</span><span class="p">,</span> <span class="n">SMALLEST_PVAL</span><span class="p">)</span>
    <span class="n">log_sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pvals</span><span class="p">),</span>
        <span class="n">shape</span><span class="o">=</span><span class="n">pvals</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">pvals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span>
        <span class="n">strides</span><span class="o">=</span><span class="n">pvals</span><span class="o">.</span><span class="n">strides</span> <span class="o">+</span> <span class="p">(</span><span class="n">pvals</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">f_pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">pvals</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">f_pvals</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">f_pvals</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">lag</span><span class="p">:</span><span class="o">-</span><span class="n">lag</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">log_sums</span> <span class="o">*</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">f_pvals</span>

<div class="viewcode-block" id="calc_window_z_transform"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.calc_window_z_transform">[docs]</a><span class="k">def</span> <span class="nf">calc_window_z_transform</span><span class="p">(</span><span class="n">r_means</span><span class="p">,</span> <span class="n">ref_means</span><span class="p">,</span> <span class="n">ref_sds</span><span class="p">,</span> <span class="n">lag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Stouffer&#39;s Z-transformation across a read</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r_means</span> <span class="o">-</span> <span class="n">ref_means</span><span class="p">)</span> <span class="o">/</span> <span class="n">ref_sds</span>
    <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">lag</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">window_z_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
        <span class="n">z_scores</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">z_scores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">lag</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">width</span><span class="p">),</span>
        <span class="n">strides</span><span class="o">=</span><span class="n">z_scores</span><span class="o">.</span><span class="n">strides</span> <span class="o">+</span>
        <span class="p">(</span><span class="n">z_scores</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
    <span class="n">window_z_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">NAN</span><span class="p">]</span> <span class="o">*</span> <span class="n">lag</span><span class="p">),</span>
                                     <span class="n">window_z_trans</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">NAN</span><span class="p">]</span> <span class="o">*</span> <span class="n">lag</span><span class="p">)])</span>
</div>
    <span class="k">return</span> <span class="n">window_z_trans</span>

<div class="viewcode-block" id="calc_mann_whitney_z_score"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.calc_mann_whitney_z_score">[docs]</a><span class="k">def</span> <span class="nf">calc_mann_whitney_z_score</span><span class="p">(</span><span class="n">samp1</span><span class="p">,</span> <span class="n">samp2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Mann-Whitney z-scores comparing two samples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s1_len</span> <span class="o">=</span> <span class="n">samp1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s2_len</span> <span class="o">=</span> <span class="n">samp2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tot_len</span> <span class="o">=</span> <span class="n">s1_len</span> <span class="o">+</span> <span class="n">s2_len</span>

    <span class="n">all_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">samp1</span><span class="p">,</span> <span class="n">samp2</span><span class="p">])</span>
    <span class="n">ranks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">tot_len</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">ranks</span><span class="p">[</span><span class="n">all_vals</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tot_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">s1_ranks_sum</span> <span class="o">=</span> <span class="n">ranks</span><span class="p">[:</span><span class="n">s1_len</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="c1">#s2_ranks_sum = ranks[s1_len:].sum()</span>

    <span class="n">u1</span> <span class="o">=</span> <span class="n">s1_ranks_sum</span> <span class="o">-</span> <span class="p">(</span><span class="n">s1_len</span> <span class="o">*</span> <span class="p">(</span><span class="n">s1_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="c1">#u2 = s2_ranks_sum - (s2_len * (s2_len + 1)) / 2</span>

    <span class="n">mu</span> <span class="o">=</span> <span class="n">s1_len</span> <span class="o">*</span> <span class="n">s2_len</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">rhou</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s1_len</span> <span class="o">*</span> <span class="n">s2_len</span> <span class="o">*</span> <span class="p">(</span><span class="n">s1_len</span> <span class="o">+</span> <span class="n">s2_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span><span class="p">)</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u1</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">rhou</span>
</div>
    <span class="k">return</span> <span class="n">z</span>


<span class="c1">#########################################</span>
<span class="c1">##### Local Model-based Re-squiggle #####</span>
<span class="c1">#########################################</span>

<div class="viewcode-block" id="get_dynamic_prog_params"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.get_dynamic_prog_params">[docs]</a><span class="k">def</span> <span class="nf">get_dynamic_prog_params</span><span class="p">(</span><span class="n">match_evalue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute dynamic programming shift parameters from an expected match</span>
<span class="sd">    expected value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">z_shift</span> <span class="o">=</span> <span class="n">HALF_NORM_EXPECTED_VAL</span> <span class="o">+</span> <span class="n">match_evalue</span>
    <span class="n">stay_pen</span> <span class="o">=</span> <span class="n">match_evalue</span></div>
    <span class="k">return</span> <span class="n">z_shift</span><span class="p">,</span> <span class="n">stay_pen</span>

<div class="viewcode-block" id="get_begin_nan"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.get_begin_nan">[docs]</a><span class="k">def</span> <span class="nf">get_begin_nan</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the index of the first NAN value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tot</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">):</span> <span class="k">break</span>
        <span class="n">tot</span> <span class="o">+=</span> <span class="mi">1</span></div>
    <span class="k">return</span> <span class="n">tot</span>

<div class="viewcode-block" id="get_read_signif_shift_regions"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.get_read_signif_shift_regions">[docs]</a><span class="k">def</span> <span class="nf">get_read_signif_shift_regions</span><span class="p">(</span>
        <span class="n">z_scores</span><span class="p">,</span> <span class="n">z_thresh</span><span class="p">,</span> <span class="n">context_bases</span><span class="p">,</span> <span class="n">signif_shift_len_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify regions along a read that do not match well with the genomic</span>
<span class="sd">    reference tombo model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># extend NANs by context_bases to avoid regions extending outside of</span>
    <span class="c1"># valid regions over which statistics were computed</span>
    <span class="n">start_nans</span> <span class="o">=</span> <span class="n">get_begin_nan</span><span class="p">(</span><span class="n">z_scores</span><span class="p">)</span> <span class="o">+</span> <span class="n">context_bases</span>
    <span class="n">z_scores</span><span class="p">[:</span><span class="n">start_nans</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
    <span class="n">end_nans</span> <span class="o">=</span> <span class="n">get_begin_nan</span><span class="p">(</span><span class="n">z_scores</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">context_bases</span>
    <span class="k">if</span> <span class="n">end_nans</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">z_scores</span><span class="p">[</span><span class="o">-</span><span class="n">end_nans</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
    <span class="c1"># suppress NAN errors form less than compare</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">signif_shift_locs</span> <span class="o">=</span> <span class="n">z_scores</span> <span class="o">&gt;</span> <span class="n">z_thresh</span>
    <span class="c1"># find the edges of significantly shifted signal regions</span>
    <span class="n">signif_shift_chngpnts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">signif_shift_locs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">signif_shift_regs</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">signif_shift_chngpnts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span>
                            <span class="n">signif_shift_chngpnts</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">signif_shift_cntxt_regs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">curr_start</span><span class="p">,</span> <span class="n">curr_end</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">signif_shift_regs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">reg_end</span> <span class="ow">in</span> <span class="n">signif_shift_regs</span><span class="p">:</span>
        <span class="c1"># if next region overlaps the current region with context</span>
        <span class="k">if</span> <span class="n">reg_start</span> <span class="o">-</span> <span class="p">(</span><span class="n">context_bases</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">curr_end</span><span class="p">:</span>
            <span class="c1"># extend the current region to cover both regions</span>
            <span class="n">curr_end</span> <span class="o">=</span> <span class="n">reg_end</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># else check that the region is long enough</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">signif_shift_len_thresh</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                <span class="n">curr_end</span> <span class="o">-</span> <span class="n">curr_start</span> <span class="o">&gt;=</span> <span class="n">signif_shift_len_thresh</span><span class="p">):</span>
                <span class="c1"># and add it to the list of regions to model re-squiggle</span>
                <span class="n">signif_shift_cntxt_regs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">curr_start</span> <span class="o">-</span> <span class="n">context_bases</span><span class="p">,</span>
                                                <span class="n">curr_end</span> <span class="o">+</span> <span class="n">context_bases</span><span class="p">))</span>
            <span class="c1"># and set the next region to be the current one</span>
            <span class="n">curr_start</span><span class="p">,</span> <span class="n">curr_end</span> <span class="o">=</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">reg_end</span>

    <span class="c1"># add last region</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">signif_shift_len_thresh</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
        <span class="n">curr_end</span> <span class="o">-</span> <span class="n">curr_start</span> <span class="o">&gt;=</span> <span class="n">signif_shift_len_thresh</span><span class="p">):</span>
        <span class="n">signif_shift_cntxt_regs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">curr_start</span> <span class="o">-</span> <span class="n">context_bases</span><span class="p">,</span>
                                        <span class="n">curr_end</span> <span class="o">+</span> <span class="n">context_bases</span><span class="p">))</span>
</div>
    <span class="k">return</span> <span class="n">signif_shift_cntxt_regs</span>


<span class="c1">##########################</span>
<span class="c1">##### Statistics I/O #####</span>
<span class="c1">##########################</span>

<div class="viewcode-block" id="parse_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.parse_stats">[docs]</a><span class="k">def</span> <span class="nf">parse_stats</span><span class="p">(</span><span class="n">stats_fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a tombo statistics file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">stats_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">stats_fn</span><span class="p">):</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Statistics file not provided or provided file does not exist.&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">stats_fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stats_fp</span><span class="p">:</span>
            <span class="n">all_stats</span> <span class="o">=</span> <span class="n">stats_fp</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stat_type</span> <span class="o">=</span> <span class="n">stats_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stat_type&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># if this is the old stats file assume sample compare</span>
                <span class="n">stat_type</span> <span class="o">=</span> <span class="n">SAMP_COMP_TXT</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Attempt to load statistics file failed. May be an old &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;version of statistics file. Try deleting statistics &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;file and recalculating using current tombo version.&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">all_stats</span><span class="p">,</span> <span class="n">stat_type</span>

<div class="viewcode-block" id="write_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.write_stats">[docs]</a><span class="k">def</span> <span class="nf">write_stats</span><span class="p">(</span><span class="n">all_stats</span><span class="p">,</span> <span class="n">stats_bsnm</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a tombo statistics file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s1">&#39;Saving signal shift significance testing results.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stat_type</span> <span class="o">==</span> <span class="n">ALT_MODEL_TXT</span><span class="p">:</span>
        <span class="c1"># for alternative model testing, write one stats file per</span>
        <span class="c1"># alternative model</span>
        <span class="k">for</span> <span class="n">alt_name</span><span class="p">,</span> <span class="n">alt_stats</span> <span class="ow">in</span> <span class="n">all_stats</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">stats_bsnm</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">alt_name</span> <span class="o">+</span>
                           <span class="s1">&#39;.tombo.stats&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stats_fp</span><span class="p">:</span>
                <span class="n">stats_fp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                    <span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">alt_stats</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
                <span class="n">stats_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stat_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_type</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">stats_bsnm</span> <span class="o">+</span> <span class="s1">&#39;.tombo.stats&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stats_fp</span><span class="p">:</span>
            <span class="n">stats_fp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">all_stats</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
            <span class="n">stats_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stat_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_type</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="PerReadStats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.PerReadStats">[docs]</a><span class="k">class</span> <span class="nc">PerReadStats</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">per_read_stats_fn</span><span class="p">,</span> <span class="n">stat_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">region_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open per-read statistics file. If stat_type and region_size are provided</span>
<span class="sd">        the file is opened for writing, else it is opened for random access.</span>

<span class="sd">        WARNING: If stat_type and region_size are provided the current file&#39;s</span>
<span class="sd">        contents will be deleted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stat_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">region_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># open file for reading</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">per_read_stats_fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stat_type&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;block_size&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">per_read_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">[</span><span class="s1">&#39;Statistic_Blocks&#39;</span><span class="p">]</span>
                <span class="n">blocks_index</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">block_name</span><span class="p">,</span> <span class="n">block_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_read_blocks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">blocks_index</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;chrm&#39;</span><span class="p">],</span>
                         <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                             <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">],</span>
                             <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span><span class="p">,</span>
                             <span class="n">block_name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blocks_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">blocks_index</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
                    <span class="s1">&#39;Non-existent or invalid per-read statistics file provided.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># set class attributes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="o">=</span> <span class="n">stat_type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span> <span class="o">=</span> <span class="n">region_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_block_num</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># try to remove file for overwriting old results</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">per_read_stats_fn</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># open file for writing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">per_read_stats_fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="c1"># save attributes to file and open stats blocks group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stat_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;block_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">per_read_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;Statistic_Blocks&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">are_pvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="o">!=</span> <span class="n">ALT_MODEL_TXT</span>

        <span class="k">return</span>

<div class="viewcode-block" id="PerReadStats.write_per_read_block"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.PerReadStats.write_per_read_block">[docs]</a>    <span class="k">def</span> <span class="nf">write_per_read_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">per_read_block</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write region statistics block to file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">block_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_read_blocks</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span>
                <span class="s1">&#39;Block_&#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_block_num</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_block_num</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
                <span class="s1">&#39;Per-read statistics file not opened for writing.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;chrm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chrm</span>
        <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strand</span>
        <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">block_data</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
            <span class="s1">&#39;block_stats&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">per_read_block</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</div>
        <span class="k">return</span>

<div class="viewcode-block" id="PerReadStats.get_region_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.PerReadStats.get_region_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_region_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval_data</span><span class="p">,</span> <span class="n">num_reads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get per-read statistics from the specifed interval for a random selection</span>
<span class="sd">        of num_reads.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cs_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks_index</span><span class="p">[(</span>
                <span class="n">interval_data</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">interval_data</span><span class="o">.</span><span class="n">strand</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">int_block_stats</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">per_read_blocks</span><span class="p">[</span><span class="n">block_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="s1">&#39;block_stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="k">for</span> <span class="n">block_data</span> <span class="ow">in</span> <span class="n">cs_blocks</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">interval_data</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">block_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span>
                   <span class="n">interval_data</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">block_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_block_stats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_block_stats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">int_block_stats</span> <span class="o">=</span> <span class="n">int_block_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">int_block_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">int_block_stats</span><span class="p">)</span>

        <span class="n">all_int_stats</span> <span class="o">=</span> <span class="n">int_block_stats</span><span class="p">[</span>
            <span class="p">(</span><span class="n">int_block_stats</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">interval_data</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">int_block_stats</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">interval_data</span><span class="o">.</span><span class="n">end</span><span class="p">)]</span>

        <span class="n">read_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_int_stats</span><span class="p">[</span><span class="s1">&#39;read_id&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">num_reads</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_reads</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">read_ids</span><span class="p">):</span>
            <span class="n">int_plot_reads</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">read_ids</span><span class="p">,</span> <span class="n">num_reads</span><span class="p">))</span>
            <span class="n">all_int_stats</span> <span class="o">=</span> <span class="n">all_int_stats</span><span class="p">[</span>
                <span class="n">all_int_stats</span><span class="p">[</span><span class="s1">&#39;read_id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">int_plot_reads</span><span class="p">]</span>
</div>
        <span class="k">return</span> <span class="n">all_int_stats</span>

<div class="viewcode-block" id="PerReadStats.close"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.PerReadStats.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>
        <span class="k">return</span>


<span class="c1">################################</span>
<span class="c1">##### Base-by-base Testing #####</span>
<span class="c1">################################</span>

<div class="viewcode-block" id="get_reads_ref"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.get_reads_ref">[docs]</a><span class="k">def</span> <span class="nf">get_reads_ref</span><span class="p">(</span><span class="n">ctrl_reg_reads</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span>
                  <span class="n">min_test_vals</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get mean and standard deviation of levels from a sample across the genome</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ctrl_base_events</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_reads_events</span><span class="p">(</span><span class="n">ctrl_reg_reads</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ctrl_base_events</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    <span class="n">arr_size</span> <span class="o">=</span> <span class="n">region_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">fm_offset</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ctrl_means</span><span class="p">,</span> <span class="n">ctrl_sds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">arr_size</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">arr_size</span><span class="p">)</span>
    <span class="n">ctrl_means</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
    <span class="n">ctrl_sds</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
    <span class="n">ctrl_cov</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">pos_events</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ctrl_base_events</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="c1"># if position is past the end of the region return</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">fm_offset</span> <span class="o">&gt;=</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">region_size</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">fm_offset</span> <span class="o">&lt;</span> <span class="n">reg_start</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ctrl_cov</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_events</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ctrl_cov</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_test_vals</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ctrl_mean</span><span class="p">,</span> <span class="n">ctrl_sd</span> <span class="o">=</span> <span class="n">c_mean_std</span><span class="p">(</span><span class="n">pos_events</span><span class="p">)</span>
        <span class="n">ctrl_sd</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ctrl_sd</span><span class="p">,</span> <span class="n">MIN_POSITION_SD</span><span class="p">)</span>
        <span class="n">ctrl_means</span><span class="p">[</span><span class="n">pos</span> <span class="o">-</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">fm_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrl_mean</span>
        <span class="n">ctrl_sds</span><span class="p">[</span><span class="n">pos</span> <span class="o">-</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">fm_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrl_sd</span>
</div>
    <span class="k">return</span> <span class="n">ctrl_means</span><span class="p">,</span> <span class="n">ctrl_sds</span><span class="p">,</span> <span class="n">ctrl_cov</span>

<div class="viewcode-block" id="compute_sample_compare_read_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.compute_sample_compare_read_stats">[docs]</a><span class="k">def</span> <span class="nf">compute_sample_compare_read_stats</span><span class="p">(</span>
        <span class="n">r_data</span><span class="p">,</span> <span class="n">ctrl_means</span><span class="p">,</span> <span class="n">ctrl_sds</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">region_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute signficance statistics using comparison of two sequenceing samples</span>
<span class="sd">    method for a single read within a specified genomic region.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">comp_clip_and_flip</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fast5_data</span><span class="p">:</span>
            <span class="n">r_means</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_single_slot_read_centric</span><span class="p">(</span>
                <span class="n">fast5_data</span><span class="p">,</span> <span class="s1">&#39;norm_mean&#39;</span><span class="p">,</span> <span class="n">r_data</span><span class="o">.</span><span class="n">corr_group</span><span class="p">)</span>
            <span class="n">read_id</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_raw_read_slot</span><span class="p">(</span><span class="n">fast5_data</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;read_id&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">r_means</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s1">&#39;Read does not contain re-squiggled level means.&#39;</span><span class="p">)</span>

        <span class="n">read_start</span><span class="p">,</span> <span class="n">read_end</span> <span class="o">=</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span>
        <span class="k">if</span> <span class="n">read_start</span> <span class="o">+</span> <span class="n">fm_offset</span> <span class="o">&lt;</span> <span class="n">reg_start</span><span class="p">:</span>
            <span class="n">num_start_clip</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">-</span> <span class="p">(</span><span class="n">read_start</span> <span class="o">+</span> <span class="n">fm_offset</span><span class="p">)</span>
            <span class="n">read_start</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">-</span> <span class="n">fm_offset</span>
            <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[</span><span class="n">num_start_clip</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[:</span><span class="o">-</span><span class="n">num_start_clip</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">read_end</span> <span class="o">-</span> <span class="n">fm_offset</span> <span class="o">&gt;</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">region_size</span><span class="p">:</span>
            <span class="n">num_end_clip</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_end</span> <span class="o">-</span> <span class="n">fm_offset</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">reg_start</span> <span class="o">+</span> <span class="n">region_size</span><span class="p">)</span>
            <span class="n">read_end</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">region_size</span> <span class="o">+</span> <span class="n">fm_offset</span>
            <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[:</span><span class="o">-</span><span class="n">num_end_clip</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[</span><span class="n">num_end_clip</span><span class="p">:]</span>

        <span class="c1"># flip means to match genomic positions</span>
        <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
            <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">r_means</span><span class="p">,</span> <span class="n">read_start</span><span class="p">,</span> <span class="n">read_end</span><span class="p">,</span> <span class="n">read_id</span>

    <span class="k">def</span> <span class="nf">get_read_comp_z_score</span><span class="p">(</span><span class="n">r_means</span><span class="p">,</span> <span class="n">read_start</span><span class="p">,</span> <span class="n">read_end</span><span class="p">):</span>
        <span class="n">r_z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
            <span class="n">r_means</span> <span class="o">-</span> <span class="n">ctrl_means</span><span class="p">[</span><span class="n">read_start</span><span class="o">-</span><span class="n">reg_start</span><span class="o">+</span><span class="n">fm_offset</span><span class="p">:</span>
                                 <span class="n">read_end</span><span class="o">-</span><span class="n">reg_start</span><span class="o">+</span><span class="n">fm_offset</span><span class="p">])</span> <span class="o">/</span> <span class="n">ctrl_sds</span><span class="p">[</span>
                                     <span class="n">read_start</span><span class="o">-</span><span class="n">reg_start</span><span class="o">+</span><span class="n">fm_offset</span><span class="p">:</span>
                                     <span class="n">read_end</span><span class="o">-</span><span class="n">reg_start</span><span class="o">+</span><span class="n">fm_offset</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">r_z_scores</span>

    <span class="k">def</span> <span class="nf">get_pvals</span><span class="p">(</span><span class="n">r_z_scores</span><span class="p">):</span>
        <span class="c1"># mask out nan z-scores for efficient CDF computation</span>
        <span class="n">r_poss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r_z_scores</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">r_pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">r_z_scores</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">r_pvals</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
        <span class="n">valid_r_pvals</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">r_z_scores</span><span class="p">[</span><span class="n">r_poss</span><span class="p">])</span> <span class="o">*</span> <span class="mf">2.0</span>
        <span class="n">r_pvals</span><span class="p">[</span><span class="n">r_poss</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_r_pvals</span>

        <span class="k">return</span> <span class="n">r_pvals</span><span class="p">,</span> <span class="n">r_poss</span>

    <span class="n">r_means</span><span class="p">,</span> <span class="n">read_start</span><span class="p">,</span> <span class="n">read_end</span><span class="p">,</span> <span class="n">read_id</span> <span class="o">=</span> <span class="n">comp_clip_and_flip</span><span class="p">()</span>
    <span class="n">r_z_scores</span> <span class="o">=</span> <span class="n">get_read_comp_z_score</span><span class="p">(</span><span class="n">r_means</span><span class="p">,</span> <span class="n">read_start</span><span class="p">,</span> <span class="n">read_end</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r_z_scores</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;No valid z-scores in read.&#39;</span><span class="p">)</span>
    <span class="n">r_pvals</span><span class="p">,</span> <span class="n">r_poss</span> <span class="o">=</span> <span class="n">get_pvals</span><span class="p">(</span><span class="n">r_z_scores</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fm_offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">r_pvals</span> <span class="o">=</span> <span class="n">calc_window_fishers_method</span><span class="p">(</span><span class="n">r_pvals</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">)</span>
        <span class="n">r_poss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r_pvals</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">r_pvals</span> <span class="o">=</span> <span class="n">r_pvals</span><span class="p">[</span><span class="n">r_poss</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r_pvals</span> <span class="o">=</span> <span class="n">r_pvals</span><span class="p">[</span><span class="n">r_poss</span><span class="p">]</span>

    <span class="n">r_poss</span> <span class="o">+=</span> <span class="n">read_start</span>
</div>
    <span class="k">return</span> <span class="n">r_pvals</span><span class="p">,</span> <span class="n">r_poss</span><span class="p">,</span> <span class="n">read_id</span>

<div class="viewcode-block" id="compute_de_novo_read_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.compute_de_novo_read_stats">[docs]</a><span class="k">def</span> <span class="nf">compute_de_novo_read_stats</span><span class="p">(</span>
        <span class="n">r_data</span><span class="p">,</span> <span class="n">gnm_begin_lag</span><span class="p">,</span> <span class="n">gnm_end_lag</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">,</span>
        <span class="n">region_size</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute signficance statistics using de novo comparison to a canonical model</span>
<span class="sd">    method for a single read within a specified genomic region.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">de_novo_clip_and_flip</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fast5_data</span><span class="p">:</span>
            <span class="n">r_means</span><span class="p">,</span> <span class="n">r_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_multiple_slots_read_centric</span><span class="p">(</span>
                <span class="n">fast5_data</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;norm_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">],</span> <span class="n">r_data</span><span class="o">.</span><span class="n">corr_group</span><span class="p">)</span>
            <span class="n">read_id</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_raw_read_slot</span><span class="p">(</span><span class="n">fast5_data</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;read_id&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">r_means</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r_seq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s1">&#39;Read does not contain valid re-squiggled data.&#39;</span><span class="p">)</span>
        <span class="n">r_seq</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r_seq</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="n">read_start</span><span class="p">,</span> <span class="n">read_end</span> <span class="o">=</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span>
        <span class="c1"># clip read if it extends outside the current genomic region, so</span>
        <span class="c1"># stats are only computed within this region</span>
        <span class="k">if</span> <span class="n">read_start</span> <span class="o">+</span> <span class="n">gnm_begin_lag</span> <span class="o">+</span> <span class="n">fm_offset</span> <span class="o">&lt;</span> <span class="n">reg_start</span><span class="p">:</span>
            <span class="n">num_start_clip</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">-</span> <span class="p">(</span><span class="n">read_start</span> <span class="o">+</span> <span class="n">gnm_begin_lag</span> <span class="o">+</span> <span class="n">fm_offset</span><span class="p">)</span>
            <span class="n">read_start</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">-</span> <span class="n">gnm_begin_lag</span> <span class="o">-</span> <span class="n">fm_offset</span>
            <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[</span><span class="n">num_start_clip</span><span class="p">:]</span>
                <span class="n">r_seq</span> <span class="o">=</span> <span class="n">r_seq</span><span class="p">[</span><span class="n">num_start_clip</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[:</span><span class="o">-</span><span class="n">num_start_clip</span><span class="p">]</span>
                <span class="n">r_seq</span> <span class="o">=</span> <span class="n">r_seq</span><span class="p">[:</span><span class="o">-</span><span class="n">num_start_clip</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">read_end</span> <span class="o">-</span> <span class="n">gnm_end_lag</span> <span class="o">-</span> <span class="n">fm_offset</span> <span class="o">&gt;</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">region_size</span><span class="p">:</span>
            <span class="n">num_end_clip</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_end</span> <span class="o">-</span> <span class="n">gnm_end_lag</span> <span class="o">-</span> <span class="n">fm_offset</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
                <span class="n">reg_start</span> <span class="o">+</span> <span class="n">region_size</span><span class="p">)</span>
            <span class="n">read_end</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">region_size</span> <span class="o">+</span> <span class="n">gnm_end_lag</span> <span class="o">+</span> <span class="n">fm_offset</span>
            <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[:</span><span class="o">-</span><span class="n">num_end_clip</span><span class="p">]</span>
                <span class="n">r_seq</span> <span class="o">=</span> <span class="n">r_seq</span><span class="p">[:</span><span class="o">-</span><span class="n">num_end_clip</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[</span><span class="n">num_end_clip</span><span class="p">:]</span>
                <span class="n">r_seq</span> <span class="o">=</span> <span class="n">r_seq</span><span class="p">[</span><span class="n">num_end_clip</span><span class="p">:]</span>

        <span class="c1"># if this read does not cover enough of this region for stat</span>
        <span class="c1"># computation raise an error to be handled below</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_seq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s1">&#39;Read does not contain information in this region.&#39;</span><span class="p">)</span>

        <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_ref_from_seq</span><span class="p">(</span>
            <span class="n">r_seq</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
            <span class="c1"># reverse means to match genomic order</span>
            <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># clip means that don&#39;t have testing model data</span>
        <span class="c1"># note that this is still extended by fm_offset</span>
        <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[</span><span class="n">gnm_begin_lag</span><span class="p">:</span><span class="o">-</span><span class="n">gnm_end_lag</span><span class="p">]</span>
        <span class="n">read_start</span> <span class="o">+=</span> <span class="n">gnm_begin_lag</span>
        <span class="n">read_end</span> <span class="o">-=</span> <span class="n">gnm_end_lag</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">r_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">read_start</span><span class="p">,</span>
                <span class="n">read_end</span><span class="p">,</span> <span class="n">read_id</span><span class="p">)</span>


    <span class="p">(</span><span class="n">r_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span>
     <span class="n">read_start</span><span class="p">,</span> <span class="n">read_end</span><span class="p">,</span> <span class="n">read_id</span><span class="p">)</span> <span class="o">=</span> <span class="n">de_novo_clip_and_flip</span><span class="p">()</span>

    <span class="n">z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r_means</span> <span class="o">-</span> <span class="n">r_ref_means</span><span class="p">)</span> <span class="o">/</span> <span class="n">r_ref_sds</span>
    <span class="n">r_pvals</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">z_scores</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span>
    <span class="k">if</span> <span class="n">fm_offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">r_pvals</span> <span class="o">=</span> <span class="n">calc_window_fishers_method</span><span class="p">(</span><span class="n">r_pvals</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">)</span>

    <span class="c1"># ignore errors in max over NAN values if fisher&#39;s method was used</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">r_pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">r_pvals</span><span class="p">,</span> <span class="n">SMALLEST_PVAL</span><span class="p">)</span>

    <span class="n">r_poss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">read_start</span><span class="p">,</span> <span class="n">read_end</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">r_pvals</span><span class="p">,</span> <span class="n">r_poss</span><span class="p">,</span> <span class="n">read_id</span>

<div class="viewcode-block" id="calc_llh_ratio"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.calc_llh_ratio">[docs]</a><span class="k">def</span> <span class="nf">calc_llh_ratio</span><span class="p">(</span><span class="n">reg_means</span><span class="p">,</span> <span class="n">reg_ref_means</span><span class="p">,</span> <span class="n">reg_ref_vars</span><span class="p">,</span>
                   <span class="n">reg_alt_means</span><span class="p">,</span> <span class="n">reg_alt_vars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute log likelihood ratio</span>

<span class="sd">    This is about 10X slower than the cython version in tombo.c_helper, but</span>
<span class="sd">    has been kept for debugging purposes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># compute log likelihood ratio</span>
    <span class="c1"># positive value means standard base fits data better</span>
    <span class="c1"># negative value means alternative base fits data better</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">reg_means</span> <span class="o">-</span> <span class="n">reg_alt_means</span><span class="p">)</span> <span class="o">/</span> <span class="n">reg_alt_vars</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">reg_alt_vars</span><span class="p">)))</span> <span class="o">-</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">reg_means</span> <span class="o">-</span> <span class="n">reg_ref_means</span><span class="p">)</span> <span class="o">/</span> <span class="n">reg_ref_vars</span><span class="p">)</span> <span class="o">+</span></div>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">reg_ref_vars</span><span class="p">)))</span>

<div class="viewcode-block" id="compute_alt_model_read_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.compute_alt_model_read_stats">[docs]</a><span class="k">def</span> <span class="nf">compute_alt_model_read_stats</span><span class="p">(</span>
        <span class="n">r_data</span><span class="p">,</span> <span class="n">gnm_begin_lag</span><span class="p">,</span> <span class="n">gnm_end_lag</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span>
        <span class="n">std_ref</span><span class="p">,</span> <span class="n">alt_ref</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute signficance statistics using comparison of read signal to canonical</span>
<span class="sd">    and alternative models method for a single read within a specified genomic</span>
<span class="sd">    region.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">motif_width</span> <span class="o">=</span> <span class="n">gnm_begin_lag</span> <span class="o">+</span> <span class="n">gnm_end_lag</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="nf">alt_clip_and_flip</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fast5_data</span><span class="p">:</span>
            <span class="n">r_means</span><span class="p">,</span> <span class="n">r_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_multiple_slots_read_centric</span><span class="p">(</span>
                <span class="n">fast5_data</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;norm_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">],</span> <span class="n">r_data</span><span class="o">.</span><span class="n">corr_group</span><span class="p">)</span>
            <span class="n">read_id</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_raw_read_slot</span><span class="p">(</span><span class="n">fast5_data</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;read_id&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">r_means</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r_seq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s1">&#39;Read does not contain valid re-squiggled data.&#39;</span><span class="p">)</span>
        <span class="n">r_seq</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r_seq</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="n">read_start</span> <span class="o">=</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span>
        <span class="c1"># clip read if it extends outside the current genomic region, so</span>
        <span class="c1"># stats are only computed within this region</span>
        <span class="k">if</span> <span class="n">read_start</span> <span class="o">+</span> <span class="n">motif_width</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">reg_start</span><span class="p">:</span>
            <span class="n">num_start_clip</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">-</span> <span class="p">(</span><span class="n">read_start</span> <span class="o">+</span> <span class="n">motif_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">read_start</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">-</span> <span class="p">(</span><span class="n">motif_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[</span><span class="n">num_start_clip</span><span class="p">:]</span>
                <span class="n">r_seq</span> <span class="o">=</span> <span class="n">r_seq</span><span class="p">[</span><span class="n">num_start_clip</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[:</span><span class="o">-</span><span class="n">num_start_clip</span><span class="p">]</span>
                <span class="n">r_seq</span> <span class="o">=</span> <span class="n">r_seq</span><span class="p">[:</span><span class="o">-</span><span class="n">num_start_clip</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="p">(</span><span class="n">motif_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">region_size</span><span class="p">:</span>
            <span class="n">num_end_clip</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="p">(</span><span class="n">motif_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span>
                <span class="n">reg_start</span> <span class="o">+</span> <span class="n">region_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[:</span><span class="o">-</span><span class="n">num_end_clip</span><span class="p">]</span>
                <span class="n">r_seq</span> <span class="o">=</span> <span class="n">r_seq</span><span class="p">[:</span><span class="o">-</span><span class="n">num_end_clip</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[</span><span class="n">num_end_clip</span><span class="p">:]</span>
                <span class="n">r_seq</span> <span class="o">=</span> <span class="n">r_seq</span><span class="p">[</span><span class="n">num_end_clip</span><span class="p">:]</span>

        <span class="c1"># if this read does not cover enough of this region for stat</span>
        <span class="c1"># computation raise an error to be handled below</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_seq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s1">&#39;Read does not contain information in this region.&#39;</span><span class="p">)</span>

        <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">r_alt_means</span><span class="p">,</span> <span class="n">r_alt_sds</span> <span class="o">=</span> <span class="n">get_ref_from_seq</span><span class="p">(</span>
            <span class="n">r_seq</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alt_ref</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
            <span class="c1"># reverse means and seq to match genomic order</span>
            <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r_seq</span> <span class="o">=</span> <span class="n">r_seq</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># clip means to individual tested positions</span>
        <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[</span><span class="n">gnm_begin_lag</span><span class="p">:</span><span class="o">-</span><span class="n">gnm_end_lag</span><span class="p">]</span>
        <span class="c1"># trim seq to positions with valid llh ratio test results</span>
        <span class="c1"># this is shorter than the means and model</span>
        <span class="n">r_seq</span> <span class="o">=</span> <span class="n">r_seq</span><span class="p">[(</span><span class="n">motif_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span><span class="o">-</span><span class="p">(</span><span class="n">motif_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">read_start</span> <span class="o">+=</span> <span class="n">motif_width</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">r_means</span><span class="p">,</span> <span class="n">r_seq</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">read_start</span><span class="p">,</span>
                <span class="n">r_alt_means</span><span class="p">,</span> <span class="n">r_alt_sds</span><span class="p">,</span> <span class="n">read_id</span><span class="p">)</span>


    <span class="p">(</span><span class="n">r_means</span><span class="p">,</span> <span class="n">r_seq</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">read_start</span><span class="p">,</span>
     <span class="n">r_alt_means</span><span class="p">,</span> <span class="n">r_alt_sds</span><span class="p">,</span> <span class="n">read_id</span><span class="p">)</span> <span class="o">=</span> <span class="n">alt_clip_and_flip</span><span class="p">()</span>
    <span class="n">r_ref_vars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">r_ref_sds</span><span class="p">)</span>
    <span class="n">r_alt_vars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">r_alt_sds</span><span class="p">)</span>

    <span class="n">alt_base_poss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">log_lh_ratios</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># note search space is clipped since all k-mers covering the position</span>
    <span class="c1"># of interest must be valid</span>
    <span class="k">for</span> <span class="n">alt_base_pos</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">alt_ref</span><span class="o">.</span><span class="n">alt_base</span><span class="p">,</span> <span class="n">r_seq</span><span class="p">):</span>
        <span class="n">alt_pos</span> <span class="o">=</span> <span class="n">alt_base_pos</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">alt_base_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alt_pos</span> <span class="o">+</span> <span class="n">read_start</span><span class="p">)</span>
        <span class="n">pos_lh_ratio</span> <span class="o">=</span> <span class="n">c_calc_llh_ratio</span><span class="p">(</span>
            <span class="n">r_means</span><span class="p">[</span><span class="n">alt_pos</span><span class="p">:</span><span class="n">alt_pos</span> <span class="o">+</span> <span class="n">motif_width</span><span class="p">],</span>
            <span class="n">r_ref_means</span><span class="p">[</span><span class="n">alt_pos</span><span class="p">:</span><span class="n">alt_pos</span> <span class="o">+</span> <span class="n">motif_width</span><span class="p">],</span>
            <span class="n">r_ref_vars</span><span class="p">[</span><span class="n">alt_pos</span><span class="p">:</span><span class="n">alt_pos</span> <span class="o">+</span> <span class="n">motif_width</span><span class="p">],</span>
            <span class="n">r_alt_means</span><span class="p">[</span><span class="n">alt_pos</span><span class="p">:</span><span class="n">alt_pos</span> <span class="o">+</span> <span class="n">motif_width</span><span class="p">],</span>
            <span class="n">r_alt_vars</span><span class="p">[</span><span class="n">alt_pos</span><span class="p">:</span><span class="n">alt_pos</span> <span class="o">+</span> <span class="n">motif_width</span><span class="p">])</span>
        <span class="n">log_lh_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_lh_ratio</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">log_lh_ratios</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">alt_base_poss</span><span class="p">),</span> <span class="n">read_id</span>

<div class="viewcode-block" id="compute_read_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.compute_read_stats">[docs]</a><span class="k">def</span> <span class="nf">compute_read_stats</span><span class="p">(</span>
        <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">reg_reads</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span> <span class="n">min_test_vals</span><span class="p">,</span>
        <span class="n">region_size</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">ctrl_reg_reads</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span>
        <span class="n">alt_ref</span><span class="p">,</span> <span class="n">per_read_q</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">stat_type</span> <span class="o">==</span> <span class="n">SAMP_COMP_TXT</span><span class="p">:</span>
        <span class="n">ctrl_means</span><span class="p">,</span> <span class="n">ctrl_sds</span><span class="p">,</span> <span class="n">ctrl_cov</span> <span class="o">=</span> <span class="n">get_reads_ref</span><span class="p">(</span>
            <span class="n">ctrl_reg_reads</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span>
            <span class="n">min_test_vals</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctrl_cov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># compute begin and end lag wrt the genome from upstream and downstream</span>
        <span class="c1"># which are wrt to the read</span>
        <span class="n">dnstrm_bases</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">-</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">gnm_begin_lag</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="n">dnstrm_bases</span>
        <span class="n">gnm_end_lag</span> <span class="o">=</span> <span class="n">dnstrm_bases</span> <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span>

    <span class="n">reg_read_stats</span><span class="p">,</span> <span class="n">reg_poss</span><span class="p">,</span> <span class="n">reg_ids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">reg_reads</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stat_type</span> <span class="o">==</span> <span class="n">SAMP_COMP_TXT</span><span class="p">:</span>
                <span class="n">r_stats</span><span class="p">,</span> <span class="n">r_poss</span><span class="p">,</span> <span class="n">read_id</span> <span class="o">=</span> <span class="n">compute_sample_compare_read_stats</span><span class="p">(</span>
                    <span class="n">r_data</span><span class="p">,</span> <span class="n">ctrl_means</span><span class="p">,</span> <span class="n">ctrl_sds</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">,</span>
                    <span class="n">region_size</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">stat_type</span> <span class="o">==</span> <span class="n">DE_NOVO_TXT</span><span class="p">:</span>
                <span class="n">r_stats</span><span class="p">,</span> <span class="n">r_poss</span><span class="p">,</span> <span class="n">read_id</span> <span class="o">=</span> <span class="n">compute_de_novo_read_stats</span><span class="p">(</span>
                    <span class="n">r_data</span><span class="p">,</span> <span class="n">gnm_begin_lag</span><span class="p">,</span> <span class="n">gnm_end_lag</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span>
                    <span class="n">reg_start</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r_stats</span><span class="p">,</span> <span class="n">r_poss</span><span class="p">,</span> <span class="n">read_id</span> <span class="o">=</span> <span class="n">compute_alt_model_read_stats</span><span class="p">(</span>
                    <span class="n">r_data</span><span class="p">,</span> <span class="n">gnm_begin_lag</span><span class="p">,</span> <span class="n">gnm_end_lag</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span>
                    <span class="n">std_ref</span><span class="p">,</span> <span class="n">alt_ref</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">r_stats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">reg_read_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_stats</span><span class="p">)</span>
        <span class="n">reg_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_poss</span><span class="p">)</span>
        <span class="n">reg_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_read_stats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">if</span> <span class="n">per_read_q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># compile read_ids vector for per-read output</span>
        <span class="n">reg_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">r_id</span><span class="p">,</span> <span class="n">r_poss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                                  <span class="k">for</span> <span class="n">r_id</span><span class="p">,</span> <span class="n">r_poss</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">reg_ids</span><span class="p">,</span> <span class="n">reg_poss</span><span class="p">)])</span>
    <span class="n">reg_read_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">reg_read_stats</span><span class="p">)</span>
    <span class="n">reg_poss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">reg_poss</span><span class="p">)</span>
    <span class="c1"># remove nans possibly introduced by fisher&#39;s method calculcations</span>
    <span class="n">valid_poss</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">reg_read_stats</span><span class="p">)</span>
    <span class="n">reg_poss</span> <span class="o">=</span> <span class="n">reg_poss</span><span class="p">[</span><span class="n">valid_poss</span><span class="p">]</span>
    <span class="n">reg_read_stats</span> <span class="o">=</span> <span class="n">reg_read_stats</span><span class="p">[</span><span class="n">valid_poss</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">reg_poss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">reg_read_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">(</span>
        <span class="n">reg_poss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reg_read_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

    <span class="k">if</span> <span class="n">per_read_q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">reg_ids</span> <span class="o">=</span> <span class="n">reg_ids</span><span class="p">[</span><span class="n">valid_poss</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">reg_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">reg_poss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">per_read_block</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">reg_poss</span><span class="p">,</span> <span class="n">reg_read_stats</span><span class="p">,</span> <span class="n">reg_ids</span><span class="p">)),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;stat&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;read_id&#39;</span><span class="p">),</span> <span class="n">h5py</span><span class="o">.</span><span class="n">special_dtype</span><span class="p">(</span><span class="n">vlen</span><span class="o">=</span><span class="nb">str</span><span class="p">))])</span>
        <span class="n">per_read_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">per_read_block</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">))</span>

    <span class="c1"># get order of all bases from position array</span>
    <span class="n">as_reg_poss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">reg_poss</span><span class="p">)</span>
    <span class="c1"># sort all positions from all reads</span>
    <span class="n">reg_poss</span> <span class="o">=</span> <span class="n">reg_poss</span><span class="p">[</span><span class="n">as_reg_poss</span><span class="p">]</span>
    <span class="c1"># get unique tested genomic positions across all reads</span>
    <span class="n">us_reg_poss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">reg_poss</span><span class="p">)</span>

    <span class="c1"># then sort the stats array by genomic position and</span>
    <span class="c1"># split into stats by genomic base position</span>
    <span class="n">reg_base_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
        <span class="n">reg_read_stats</span><span class="p">[</span><span class="n">as_reg_poss</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">,],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">reg_poss</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">reg_cov</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">base_stats</span> <span class="ow">in</span> <span class="n">reg_base_stats</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">stat_type</span> <span class="o">==</span> <span class="n">ALT_MODEL_TXT</span><span class="p">:</span>
        <span class="c1"># filter base statistics that fall between the upper and lower</span>
        <span class="c1"># stat threshold for the log likelihood statistic</span>
        <span class="n">reg_base_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_stats</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">base_stats</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">single_read_thresh</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">base_stats</span> <span class="ow">in</span> <span class="n">reg_base_stats</span><span class="p">]</span>
        <span class="n">valid_cov</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">base_stats</span> <span class="ow">in</span> <span class="n">reg_base_stats</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">valid_cov</span> <span class="o">=</span> <span class="n">reg_cov</span>

    <span class="k">if</span> <span class="n">stat_type</span> <span class="o">==</span> <span class="n">SAMP_COMP_TXT</span><span class="p">:</span>
        <span class="n">ctrl_cov</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctrl_cov</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="k">if</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">ctrl_cov</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">reg_poss</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctrl_cov</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">reg_base_stats</span><span class="p">,</span> <span class="n">us_reg_poss</span><span class="p">,</span> <span class="n">reg_cov</span><span class="p">,</span> <span class="n">ctrl_cov</span><span class="p">,</span> <span class="n">valid_cov</span>

<div class="viewcode-block" id="get_region_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.get_region_stats">[docs]</a><span class="k">def</span> <span class="nf">get_region_stats</span><span class="p">(</span>
        <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">reg_reads</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span> <span class="n">min_test_vals</span><span class="p">,</span>
        <span class="n">region_size</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">ctrl_reg_reads</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span>
        <span class="n">alt_ref</span><span class="p">,</span> <span class="n">per_read_q</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute requested statistics for a specific region of the genome</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="p">(</span><span class="n">reg_base_stats</span><span class="p">,</span> <span class="n">reg_poss</span><span class="p">,</span>
         <span class="n">reg_cov</span><span class="p">,</span> <span class="n">ctrl_cov</span><span class="p">,</span> <span class="n">valid_cov</span><span class="p">)</span> <span class="o">=</span> <span class="n">compute_read_stats</span><span class="p">(</span>
             <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">reg_reads</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span> <span class="n">min_test_vals</span><span class="p">,</span>
             <span class="n">region_size</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">ctrl_reg_reads</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span>
             <span class="n">alt_ref</span><span class="p">,</span> <span class="n">per_read_q</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">reg_frac_standard_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">np</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span>
            <span class="n">base_stats</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">base_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">base_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
        <span class="k">for</span> <span class="n">base_stats</span> <span class="ow">in</span> <span class="n">reg_base_stats</span><span class="p">])</span>

    <span class="n">reg_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">pos_stats</span> <span class="k">for</span> <span class="n">pos_stats</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">reg_frac_standard_base</span><span class="p">,</span>
            <span class="n">reg_poss</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">chrm</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="n">strand</span><span class="p">),</span>
            <span class="n">reg_cov</span><span class="p">,</span> <span class="n">ctrl_cov</span><span class="p">,</span> <span class="n">valid_cov</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">pos_stats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_test_vals</span> <span class="ow">and</span>
         <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pos_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;frac&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;chrm&#39;</span><span class="p">),</span> <span class="s1">&#39;S32&#39;</span><span class="p">),</span>
               <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;strand&#39;</span><span class="p">),</span> <span class="s1">&#39;S1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;cov&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
               <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;control_cov&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;valid_cov&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">)])</span>

    <span class="k">if</span> <span class="n">reg_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</div>
    <span class="k">return</span> <span class="n">reg_stats</span>

<span class="k">def</span> <span class="nf">_test_signif_worker</span><span class="p">(</span>
        <span class="n">region_q</span><span class="p">,</span> <span class="n">stats_q</span><span class="p">,</span> <span class="n">per_read_q</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span>
        <span class="n">min_test_vals</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">ctrl_read_coverage</span><span class="p">,</span>
        <span class="n">std_ref</span><span class="p">,</span> <span class="n">alt_ref</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">):</span>
    <span class="n">ctrl_reg_reads</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">region_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">reg_start</span> <span class="o">=</span> <span class="n">region_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">reg_reads</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_data</span> <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span>
                     <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">region_size</span> <span class="ow">or</span>
                             <span class="n">r_data</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">reg_start</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_reads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">ctrl_read_coverage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ctrl_reg_reads</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">r_data</span> <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">ctrl_read_coverage</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">region_size</span> <span class="ow">or</span>
                        <span class="n">r_data</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">reg_start</span><span class="p">)]</span>
        <span class="n">reg_stats</span> <span class="o">=</span> <span class="n">get_region_stats</span><span class="p">(</span>
            <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">reg_reads</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span> <span class="n">min_test_vals</span><span class="p">,</span>
            <span class="n">region_size</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">ctrl_reg_reads</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span>
            <span class="n">alt_ref</span><span class="p">,</span> <span class="n">per_read_q</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reg_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stats_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">return</span>

<span class="k">if</span> <span class="n">_PROFILE_SIGNIF</span><span class="p">:</span>
    <span class="n">_test_signif_wrapper</span> <span class="o">=</span> <span class="n">_test_signif_worker</span>
    <span class="k">def</span> <span class="nf">_test_signif_worker</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">cProfile</span>
        <span class="n">cProfile</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span><span class="s1">&#39;_test_signif_wrapper(*args)&#39;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span>
                        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;test_signif.prof&#39;</span><span class="p">)</span>
        <span class="k">return</span>

<div class="viewcode-block" id="test_significance"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.test_significance">[docs]</a><span class="k">def</span> <span class="nf">test_significance</span><span class="p">(</span>
        <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">min_test_vals</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span>
        <span class="n">region_size</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">,</span> <span class="n">per_read_bn</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span>
        <span class="n">ctrl_read_coverage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">std_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alt_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alt_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test for significant shifted signal in mutliprocessed batches</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
    <span class="n">region_q</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">stats_q</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">per_read_q</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span> <span class="k">if</span> <span class="n">per_read_bn</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="c1"># split chromosomes into separate regions to process independently</span>
    <span class="n">chrm_sizes</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_chrm_sizes</span><span class="p">(</span><span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">ctrl_read_coverage</span><span class="p">)</span>
    <span class="n">num_regions</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">chrm_len</span> <span class="ow">in</span> <span class="n">chrm_sizes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">plus_covered</span> <span class="o">=</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span>
        <span class="n">minus_covered</span> <span class="o">=</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span>
        <span class="k">for</span> <span class="n">reg_start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">chrm_len</span><span class="p">,</span> <span class="n">region_size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">plus_covered</span><span class="p">:</span>
                <span class="n">region_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">chrm</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">))</span>
                <span class="n">num_regions</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">minus_covered</span><span class="p">:</span>
                <span class="n">region_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">chrm</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">))</span>
                <span class="n">num_regions</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s1">&#39;Performing significance testing across &#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">num_regions</span><span class="p">)</span> <span class="o">+</span>
            <span class="s1">&#39; regions. (Will print a dot for each batch completed)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">test_args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">region_q</span><span class="p">,</span> <span class="n">stats_q</span><span class="p">,</span> <span class="n">per_read_q</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span>
        <span class="n">min_test_vals</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">ctrl_read_coverage</span><span class="p">,</span>
        <span class="n">std_ref</span><span class="p">,</span> <span class="n">alt_ref</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">)</span>
    <span class="n">test_ps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_processes</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_test_signif_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">test_args</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">test_ps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">per_read_bn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stat_type</span> <span class="o">==</span> <span class="n">ALT_MODEL_TXT</span><span class="p">:</span>
            <span class="n">per_read_fn</span> <span class="o">=</span> <span class="n">per_read_bn</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">alt_name</span> <span class="o">+</span> <span class="s1">&#39;.tombo.per_read_stats&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">per_read_fn</span> <span class="o">=</span> <span class="n">per_read_bn</span> <span class="o">+</span> <span class="s1">&#39;.tombo.per_read_stats&#39;</span>
        <span class="n">per_read_stats</span> <span class="o">=</span> <span class="n">PerReadStats</span><span class="p">(</span><span class="n">per_read_fn</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span> <span class="n">region_size</span><span class="p">)</span>

    <span class="n">all_reg_stats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">test_ps</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">per_read_bn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span>
            <span class="n">reg_read_stats</span> <span class="o">=</span> <span class="n">per_read_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">per_read_stats</span><span class="o">.</span><span class="n">write_per_read_block</span><span class="p">(</span><span class="o">*</span><span class="n">reg_read_stats</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">reg_stats</span> <span class="o">=</span> <span class="n">stats_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">all_reg_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">continue</span>

    <span class="c1"># Clear leftover values from queues</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">stats_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">reg_stats</span> <span class="o">=</span> <span class="n">stats_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">all_reg_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">per_read_bn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">per_read_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">reg_read_stats</span> <span class="o">=</span> <span class="n">per_read_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">per_read_stats</span><span class="o">.</span><span class="n">write_per_read_block</span><span class="p">(</span><span class="o">*</span><span class="n">reg_read_stats</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Tabulating all stats.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">per_read_bn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">per_read_stats</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_reg_stats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;No genomic positions contain --minimum-test-reads.&#39;</span><span class="p">)</span>
    <span class="c1"># put all stats back together</span>
    <span class="n">all_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_reg_stats</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">all_stats</span>


<span class="c1">##########################</span>
<span class="c1">##### Main Functions #####</span>
<span class="c1">##########################</span>

<div class="viewcode-block" id="test_shifts_main"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.test_shifts_main">[docs]</a><span class="k">def</span> <span class="nf">test_shifts_main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">VERBOSE</span>
    <span class="n">VERBOSE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span>
    <span class="n">th</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">VERBOSE</span>

    <span class="n">raw_read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">fast5_basedirs</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">corrected_group</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">basecall_subgroups</span><span class="p">)</span>
    <span class="c1"># if second set of reads is prodived, perform comparison testing</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">control_fast5_basedirs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stat_type</span> <span class="o">=</span> <span class="n">SAMP_COMP_TXT</span>
        <span class="n">single_read_thresh</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">HYPO_THRESH</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s1">&#39;Performing two-sample comparison significance testing.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ctrl_read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">control_fast5_basedirs</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">corrected_group</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">basecall_subgroups</span><span class="p">)</span>
        <span class="n">all_stats</span> <span class="o">=</span> <span class="n">test_significance</span><span class="p">(</span>
            <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">minimum_test_reads</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">fishers_method_context</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">multiprocess_region_size</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">per_read_statistics_basename</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span>
            <span class="n">ctrl_read_coverage</span><span class="o">=</span><span class="n">ctrl_read_coverage</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tb_model_fn</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">tombo_model_filename</span>
        <span class="n">bio_samp_type</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">bio_sample_type</span>
        <span class="k">if</span> <span class="n">bio_samp_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bio_samp_type</span> <span class="o">=</span> <span class="s1">&#39;RNA&#39;</span> <span class="k">if</span> <span class="n">th</span><span class="o">.</span><span class="n">is_rna</span><span class="p">(</span><span class="n">raw_read_coverage</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;DNA&#39;</span>
        <span class="k">if</span> <span class="n">tb_model_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">bio_samp_type</span> <span class="o">=</span> <span class="n">get_default_standard_ref</span><span class="p">(</span>
                <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">bio_samp_type</span><span class="p">)</span>
        <span class="n">std_ref</span> <span class="o">=</span> <span class="n">TomboModel</span><span class="p">(</span><span class="n">tb_model_fn</span><span class="p">)</span>

        <span class="c1"># if no alt model provided perform de novo testing for shifts</span>
        <span class="c1"># from a standard model</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">alternate_model_filenames</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="n">args</span><span class="o">.</span><span class="n">alternate_bases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">stat_type</span> <span class="o">=</span> <span class="n">DE_NOVO_TXT</span>
            <span class="n">single_read_thresh</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span>
                <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">HYPO_THRESH</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s1">&#39;Performing de novo model testing against a &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;standard model</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">all_stats</span> <span class="o">=</span> <span class="n">test_significance</span><span class="p">(</span>
                <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">minimum_test_reads</span><span class="p">,</span>
                <span class="n">args</span><span class="o">.</span><span class="n">fishers_method_context</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span>
                <span class="n">args</span><span class="o">.</span><span class="n">multiprocess_region_size</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">,</span>
                <span class="n">args</span><span class="o">.</span><span class="n">per_read_statistics_basename</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span>
                <span class="n">std_ref</span><span class="o">=</span><span class="n">std_ref</span><span class="p">)</span>
        <span class="c1"># else perform comparison model testing</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stat_type</span> <span class="o">=</span> <span class="n">ALT_MODEL_TXT</span>
            <span class="n">single_read_thresh</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span>
                <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">LLR_THRESH</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s1">&#39;Performing alternative model testing</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">alternate_model_filenames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">alt_refs</span> <span class="o">=</span> <span class="n">parse_tombo_models</span><span class="p">(</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">alternate_model_filenames</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alt_refs</span> <span class="o">=</span> <span class="n">load_alt_refs</span><span class="p">(</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">alternate_bases</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span>
                    <span class="n">std_ref</span><span class="p">,</span> <span class="n">bio_samp_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_refs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
                    <span class="s1">&#39;No alternative models successfully loaded.&#39;</span><span class="p">)</span>

            <span class="n">all_stats</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">alt_name</span><span class="p">,</span> <span class="n">alt_ref</span> <span class="ow">in</span> <span class="n">alt_refs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s1">&#39;Performing alternative model testing against &#39;</span> <span class="o">+</span>
                        <span class="n">alt_name</span> <span class="o">+</span> <span class="s1">&#39; model</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">all_stats</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">alt_name</span><span class="p">,</span> <span class="n">test_significance</span><span class="p">(</span>
                    <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">minimum_test_reads</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">multiprocess_region_size</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">per_read_statistics_basename</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span>
                    <span class="n">std_ref</span><span class="o">=</span><span class="n">std_ref</span><span class="p">,</span> <span class="n">alt_ref</span><span class="o">=</span><span class="n">alt_ref</span><span class="p">,</span> <span class="n">alt_name</span><span class="o">=</span><span class="n">alt_name</span><span class="p">)))</span>
    <span class="c1"># TODO add comparison to processed genome reference determined by</span>
    <span class="c1"># deep learning performed on the genomic sequence</span>

    <span class="n">write_stats</span><span class="p">(</span><span class="n">all_stats</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">statistics_file_basename</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">)</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="est_ref_main"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.est_ref_main">[docs]</a><span class="k">def</span> <span class="nf">est_ref_main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">VERBOSE</span>
    <span class="n">VERBOSE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span>
    <span class="n">th</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">VERBOSE</span>

    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">upstream_bases</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">downstream_bases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Context upstream and downstream must be greater &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;than 0 for model estimation.&#39;</span><span class="p">)</span>

    <span class="n">estimate_kmer_model</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">fast5_basedirs</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">corrected_group</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">basecall_subgroups</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">tombo_model_filename</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">minimum_test_reads</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">upstream_bases</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">downstream_bases</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">minimum_kmer_observations</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">kmer_specific_sd</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">coverage_threshold</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">estimate_mean</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">multiprocess_region_size</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">)</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="est_alt_ref_main"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.est_alt_ref_main">[docs]</a><span class="k">def</span> <span class="nf">est_alt_ref_main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">VERBOSE</span>
    <span class="n">VERBOSE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span>
    <span class="n">th</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">VERBOSE</span>

    <span class="n">alt_ref</span><span class="p">,</span> <span class="n">upstrm_bases</span> <span class="o">=</span> <span class="n">estimate_alt_model</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">fast5_basedirs</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">control_fast5_basedirs</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">corrected_group</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">basecall_subgroups</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">tombo_model_filename</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">bio_sample_type</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">alternate_model_base</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">alt_fraction_percentile</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">minimum_kmer_observations</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">save_density_basename</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">kernel_density_bandwidth</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">alternate_density_filename</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">control_density_filename</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">)</span>
    <span class="c1"># returns None when profiling method</span>
    <span class="k">if</span> <span class="n">alt_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">write_tombo_model</span><span class="p">(</span><span class="n">alt_ref</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">alternate_model_filename</span><span class="p">,</span> <span class="n">upstrm_bases</span><span class="p">,</span>
                      <span class="n">args</span><span class="o">.</span><span class="n">alternate_model_base</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">alternate_model_name</span><span class="p">)</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="estimate_scale_main"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.estimate_scale_main">[docs]</a><span class="k">def</span> <span class="nf">estimate_scale_main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">VERBOSE</span>
    <span class="n">VERBOSE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span>
    <span class="n">th</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">VERBOSE</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Getting files list</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">fast5_basedir</span><span class="p">):</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Provided [fast5-basedir] is not a directory.&#39;</span><span class="p">)</span>
        <span class="n">fast5_basedir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">fast5_basedir</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fast5_basedir</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="k">else</span>
            <span class="n">args</span><span class="o">.</span><span class="n">fast5_basedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">fast5_fns</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_files_list</span><span class="p">(</span><span class="n">fast5_basedir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Reads base directory, a sub-directory or an old (hidden) &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;index file does not appear to be accessible. Check &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;directory permissions.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fast5_fns</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;No files identified in the specified &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;directory or within immediate subdirectories.&#39;</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Global scaling estimate: &#39;</span> <span class="o">+</span>
                     <span class="n">unicode</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">estimate_global_scale</span><span class="p">(</span><span class="n">fast5_fns</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s1">&#39;This is a module. See commands with `tombo -h`&#39;</span><span class="p">)</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Oxford Nanopore Technologies.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>
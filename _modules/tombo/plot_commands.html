

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tombo.plot_commands &mdash; Tombo 1.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Tombo 1.2 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Tombo
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Tombo Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resquiggle.html">Re-squiggle Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modified_base_detection.html">Modified Base Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../text_output.html">Text Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotting.html">Plotting Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filtering.html">Read Filtering Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_training.html">Model Training (Advanced Users Only)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rna.html">RNA Processing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tombo.html">tombo package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Tombo</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>tombo.plot_commands</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tombo.plot_commands</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">future.utils</span> <span class="k">import</span> <span class="n">native</span>

<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="nb">zip</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">queue</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">groupby</span>
<span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="k">import</span> <span class="n">resource_string</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">unicode</span> <span class="o">=</span> <span class="nb">str</span>

<span class="c1"># import tombo functions</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">tombo_stats</span> <span class="k">as</span> <span class="n">ts</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">tombo_helper</span> <span class="k">as</span> <span class="n">th</span>

<span class="kn">from</span> <span class="nn">._default_parameters</span> <span class="k">import</span> <span class="n">SMALLEST_PVAL</span><span class="p">,</span> <span class="n">ROC_PLOT_POINTS</span>

<span class="n">VERBOSE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># quantiles and especially density plots at leat 3 values</span>
<span class="c1"># to be meaningful</span>
<span class="n">QUANT_MIN</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># plotting names for strands</span>
<span class="n">FWD_STRAND</span> <span class="o">=</span> <span class="s1">&#39;Forward Strand&#39;</span>
<span class="n">REV_STRAND</span> <span class="o">=</span> <span class="s1">&#39;Reverse Strand&#39;</span>


<span class="c1">###################################</span>
<span class="c1">#### ggplot via rpy2 functions ####</span>
<span class="c1">###################################</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">rpy2.robjects</span> <span class="k">as</span> <span class="nn">r</span>
    <span class="kn">from</span> <span class="nn">rpy2.robjects.packages</span> <span class="k">import</span> <span class="n">importr</span>
<span class="k">except</span><span class="p">:</span>
    <span class="c1"># pass here and raise error when main functions are actually called</span>
    <span class="k">pass</span>


<span class="c1">###################</span>
<span class="c1">#### ROC Curve ####</span>
<span class="c1">###################</span>

<div class="viewcode-block" id="get_stat_seq"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_stat_seq">[docs]</a><span class="k">def</span> <span class="nf">get_stat_seq</span><span class="p">(</span><span class="n">motif</span><span class="p">,</span> <span class="n">pos_stat</span><span class="p">,</span> <span class="n">genome_index</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pos_stat</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
        <span class="n">stat_seq</span> <span class="o">=</span> <span class="n">genome_index</span><span class="o">.</span><span class="n">get_seq</span><span class="p">(</span>
            <span class="n">pos_stat</span><span class="p">[</span><span class="s1">&#39;chrm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
            <span class="n">pos_stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">pos_stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">-</span> <span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stat_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">rev_comp</span><span class="p">(</span><span class="n">genome_index</span><span class="o">.</span><span class="n">get_seq</span><span class="p">(</span>
            <span class="n">pos_stat</span><span class="p">[</span><span class="s1">&#39;chrm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
            <span class="n">pos_stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">+</span> <span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span><span class="p">,</span>
            <span class="n">pos_stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span><span class="p">))</span>
</div>
    <span class="k">return</span> <span class="n">stat_seq</span>

<div class="viewcode-block" id="get_motif_stats"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_motif_stats">[docs]</a><span class="k">def</span> <span class="nf">get_motif_stats</span><span class="p">(</span>
        <span class="n">motif</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">genome_index</span><span class="p">,</span> <span class="n">num_plot_points</span><span class="o">=</span><span class="n">ROC_PLOT_POINTS</span><span class="p">):</span>
    <span class="n">stat_has_mod</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pos_stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
        <span class="n">stat_seq</span> <span class="o">=</span> <span class="n">get_stat_seq</span><span class="p">(</span><span class="n">motif</span><span class="p">,</span> <span class="n">pos_stat</span><span class="p">,</span> <span class="n">genome_index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">stat_seq</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stat_has_mod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># don&#39;t include sites that aren&#39;t at the base of interest</span>
        <span class="k">elif</span> <span class="n">stat_seq</span><span class="p">[</span><span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">motif</span><span class="o">.</span><span class="n">mod_base</span><span class="p">:</span>
            <span class="n">stat_has_mod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">tp_cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">stat_has_mod</span><span class="p">)</span>
    <span class="n">tp_rate</span> <span class="o">=</span> <span class="n">tp_cumsum</span> <span class="o">/</span> <span class="n">tp_cumsum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fp_cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">stat_has_mod</span><span class="p">))</span>
    <span class="n">fp_rate</span> <span class="o">=</span> <span class="n">fp_cumsum</span> <span class="o">/</span> <span class="n">fp_cumsum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">precision</span> <span class="o">=</span> <span class="n">tp_cumsum</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">stat_has_mod</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># trim to number of requested points</span>
    <span class="n">tp_rate</span> <span class="o">=</span> <span class="n">tp_rate</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tp_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                  <span class="n">num_plot_points</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)]</span>
    <span class="n">fp_rate</span> <span class="o">=</span> <span class="n">fp_rate</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fp_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                  <span class="n">num_plot_points</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)]</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">precision</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                      <span class="n">num_plot_points</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]</span>
</div>
    <span class="k">return</span> <span class="n">tp_rate</span><span class="p">,</span> <span class="n">fp_rate</span><span class="p">,</span> <span class="n">precision</span>

<div class="viewcode-block" id="parse_motif_descs"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.parse_motif_descs">[docs]</a><span class="k">def</span> <span class="nf">parse_motif_descs</span><span class="p">(</span><span class="n">stat_motif_descs</span><span class="p">):</span>
    <span class="n">parsed_motif_descs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">motif_desc</span> <span class="ow">in</span> <span class="n">stat_motif_descs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;::&#39;</span><span class="p">):</span>
            <span class="n">raw_motif</span><span class="p">,</span> <span class="n">mod_pos</span><span class="p">,</span> <span class="n">mod_name</span> <span class="o">=</span> <span class="n">motif_desc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">motif</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboMotif</span><span class="p">(</span><span class="n">raw_motif</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">mod_pos</span><span class="p">))</span>
            <span class="n">parsed_motif_descs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">motif</span><span class="p">,</span> <span class="n">mod_name</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Invalid motif decriptions format. Format descriptions as: &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;&quot;motif:mod_pos:name[::motif2:mod_pos2:name2...]&quot;.&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">parsed_motif_descs</span>

<div class="viewcode-block" id="plot_roc"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_roc">[docs]</a><span class="k">def</span> <span class="nf">plot_roc</span><span class="p">(</span><span class="n">stats_fns</span><span class="p">,</span> <span class="n">motif_descs</span><span class="p">,</span> <span class="n">fasta_fn</span><span class="p">,</span> <span class="n">min_reads</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">motif_descs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stats_fns</span><span class="p">):</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Must provide exactly one set of motif descriptions for &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;each statistics file.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Parsing motifs.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">motif_descs</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_motif_descs</span><span class="p">(</span><span class="n">stat_motif_descs</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">stat_motif_descs</span> <span class="ow">in</span> <span class="n">motif_descs</span><span class="p">]</span>
    <span class="n">mod_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">mod_name</span> <span class="k">for</span> <span class="n">stat_mds</span> <span class="ow">in</span> <span class="n">motif_descs</span>
                 <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">mod_name</span> <span class="ow">in</span> <span class="n">stat_mds</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mod_names</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">mod_names</span><span class="p">)):</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span><span class="s1">&#39;Modified base names are not unique.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Parsing genome.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">genome_index</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">Fasta</span><span class="p">(</span><span class="n">fasta_fn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Computing accuracy statistics.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">tp_rates</span><span class="p">,</span> <span class="n">fp_rates</span><span class="p">,</span> <span class="n">precisions</span><span class="p">,</span> <span class="n">mod_names_for_r</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">stats_fn</span><span class="p">,</span> <span class="n">stat_motif_descs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stats_fns</span><span class="p">,</span> <span class="n">motif_descs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">stats_fn</span><span class="p">):</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span><span class="s1">&#39;Statistics file does not exist. Skipping: &#39;</span> <span class="o">+</span>
                                <span class="n">stats_fn</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">stats</span><span class="p">,</span> <span class="n">stat_type</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">parse_stats</span><span class="p">(</span><span class="n">stats_fn</span><span class="p">)</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;valid_cov&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_reads</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">stat_type</span> <span class="o">!=</span> <span class="n">ts</span><span class="o">.</span><span class="n">SAMP_COMP_TXT</span><span class="p">,</span>
                          <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;control_cov&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_reads</span><span class="p">))]</span>
        <span class="k">if</span> <span class="n">stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
                <span class="s1">&#39;No locations pass coverage threshold. Skipping: &#39;</span> <span class="o">+</span> <span class="n">stats_fn</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;frac&#39;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">motif</span><span class="p">,</span> <span class="n">mod_name</span> <span class="ow">in</span> <span class="n">stat_motif_descs</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">stat_type</span> <span class="o">==</span> <span class="n">ts</span><span class="o">.</span><span class="n">ALT_MODEL_TXT</span> <span class="ow">and</span>
                <span class="n">get_stat_seq</span><span class="p">(</span><span class="n">motif</span><span class="p">,</span> <span class="n">stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">genome_index</span><span class="p">)[</span><span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span>
                <span class="n">motif</span><span class="o">.</span><span class="n">mod_base</span><span class="p">):</span>
                <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
                    <span class="s1">&#39;Cannot assess modified base accuracy with alternative &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;model testing to another canonical base. Skipping: &#39;</span> <span class="o">+</span>
                    <span class="n">mod_name</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">mod_tp_rate</span><span class="p">,</span> <span class="n">mod_fp_rate</span><span class="p">,</span> <span class="n">mod_precision</span> <span class="o">=</span> <span class="n">get_motif_stats</span><span class="p">(</span>
                <span class="n">motif</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">genome_index</span><span class="p">)</span>
            <span class="c1"># print auc and average precision</span>
            <span class="n">auc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mod_tp_rate</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mod_fp_rate</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">mod_fp_rate</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="c1"># TODO compute precision recall summary stat</span>
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
                    <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">mod_name</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="s1">&#39;AUC:&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">auc</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">tp_rates</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mod_tp_rate</span><span class="p">)</span>
            <span class="n">fp_rates</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mod_fp_rate</span><span class="p">)</span>
            <span class="n">precisions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mod_precision</span><span class="p">)</span>
            <span class="n">mod_names_for_r</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">mod_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mod_tp_rate</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Plotting.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">rocDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;TP&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">tp_rates</span><span class="p">),</span>
        <span class="s1">&#39;FP&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">fp_rates</span><span class="p">),</span>
        <span class="s1">&#39;Precision&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">precisions</span><span class="p">),</span>
        <span class="s1">&#39;Comparison&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">mod_names_for_r</span><span class="p">)})</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">resource_string</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;R_scripts/plotROC.R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;pdf(&quot;&#39;</span> <span class="o">+</span> <span class="n">pdf_fn</span> <span class="o">+</span> <span class="s1">&#39;&quot;, height=4, width=6)&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotROC&#39;</span><span class="p">)](</span><span class="n">rocDat</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;dev.off()&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span>


<span class="c1">###################################</span>
<span class="c1">#### K-mer Signal Distribution ####</span>
<span class="c1">###################################</span>

<div class="viewcode-block" id="plot_kmer_dist"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_kmer_dist">[docs]</a><span class="k">def</span> <span class="nf">plot_kmer_dist</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span>
        <span class="n">read_mean</span><span class="p">,</span> <span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">,</span> <span class="n">kmer_thresh</span><span class="p">,</span> <span class="n">num_reads</span><span class="p">,</span>
        <span class="n">r_struct_fn</span><span class="p">,</span> <span class="n">dont_plot</span><span class="p">):</span>
    <span class="n">kmer_width</span> <span class="o">=</span> <span class="n">upstrm_bases</span> <span class="o">+</span> <span class="n">dnstrm_bases</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">reads_added</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">all_kmers</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="n">raw_read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Extracting read levels.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_data</span> <span class="k">for</span> <span class="n">cs_r_data</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
             <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">cs_r_data</span><span class="p">]</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">r_means</span><span class="p">,</span> <span class="n">r_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_multiple_slots_read_centric</span><span class="p">(</span>
            <span class="n">r_data</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;norm_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">r_means</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">r_seq</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r_seq</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="n">read_kmers</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">event_mean</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">[</span><span class="n">r_seq</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">kmer_width</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r_seq</span><span class="p">)</span><span class="o">-</span><span class="n">kmer_width</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span>
                <span class="n">r_means</span><span class="p">[</span><span class="n">upstrm_bases</span><span class="p">:]):</span>
            <span class="n">read_kmers</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_mean</span><span class="p">)</span>
        <span class="c1"># if every k-mer is present (unless kmer is greater than 4) and</span>
        <span class="c1"># each k-mer has the requested number of occurences</span>
        <span class="k">if</span> <span class="n">kmer_thresh</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">read_kmers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">**</span> <span class="n">kmer_width</span> <span class="ow">and</span>
                <span class="p">(</span><span class="n">kmer_thresh</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span>
                 <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">read_kmers</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">kmer_thresh</span><span class="p">)):</span>
            <span class="n">reads_added</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">kmer_means</span> <span class="ow">in</span> <span class="n">read_kmers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">read_mean</span><span class="p">:</span>
                    <span class="n">all_kmers</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">kmer_means</span><span class="p">),</span> <span class="n">reads_added</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">all_kmers</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="nb">zip</span><span class="p">(</span><span class="n">kmer_means</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">reads_added</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">reads_added</span> <span class="o">&gt;=</span> <span class="n">num_reads</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">reads_added</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Only zero or one valid reads present. &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;Check corrected group used in resquiggle as well as &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;[--num-kmer-threshold] parameter especially if requested &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;k-mer length is greater than 3 or 4. Consider setting &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;to 0 for k-mer lengths &gt; 4.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reads_added</span> <span class="o">&lt;</span> <span class="n">num_reads</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Fewer valid reads present than &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;requested. Check corrected group used in &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;resquiggle as well as [--num-kmer-threshold] &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;parameter especially if requested k-mer length is &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;greater than 3 or 4. Consider setting to 0 for k-mer &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;legnths &gt; 4.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Preparing plot data.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">kmer_levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">kmer</span> <span class="k">for</span> <span class="n">means</span><span class="p">,</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">([</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">means</span><span class="p">))),</span> <span class="n">kmer</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">means</span> <span class="ow">in</span> <span class="n">all_kmers</span><span class="o">.</span><span class="n">items</span><span class="p">()])]</span>

    <span class="n">plot_kmers</span><span class="p">,</span> <span class="n">plot_bases</span><span class="p">,</span> <span class="n">plot_means</span><span class="p">,</span> <span class="n">plot_r_ids</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
        <span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">kmer</span><span class="p">[</span><span class="n">upstrm_bases</span><span class="p">],</span> <span class="n">sig_mean</span><span class="p">,</span> <span class="n">read_i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">kmer_levels</span>
        <span class="k">for</span> <span class="n">sig_mean</span><span class="p">,</span> <span class="n">read_i</span> <span class="ow">in</span> <span class="n">all_kmers</span><span class="p">[</span><span class="n">kmer</span><span class="p">]])</span>

    <span class="n">kmerDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Kmer&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FactorVector</span><span class="p">(</span>
            <span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">plot_kmers</span><span class="p">),</span>
            <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">kmer_levels</span><span class="p">)),</span>
        <span class="s1">&#39;Base&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">plot_bases</span><span class="p">),</span>
        <span class="s1">&#39;Signal&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">plot_means</span><span class="p">),</span>
        <span class="s1">&#39;Read&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">plot_r_ids</span><span class="p">)})</span>
    <span class="c1"># df to plot kmers as tile of colors requires gridExtra R package</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">importr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;gridExtra&#39;</span><span class="p">))</span>
        <span class="n">baseDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Kmer&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FactorVector</span><span class="p">(</span>
                <span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span><span class="n">kmer</span> <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">kmer_levels</span>
                             <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kmer_width</span><span class="p">)]),</span>
                <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">kmer_levels</span><span class="p">)),</span>
            <span class="s1">&#39;Base&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span><span class="n">kmer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">kmer_levels</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kmer_width</span><span class="p">)]),</span>
            <span class="s1">&#39;Position&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">IntVector</span><span class="p">([</span>
                <span class="n">i</span> <span class="o">-</span> <span class="n">upstrm_bases</span> <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">kmer_levels</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kmer_width</span><span class="p">)])})</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Install R package `gridExtra` for &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;visual kmer display. Using text kmer display.&#39;</span><span class="p">)</span>
        <span class="n">baseDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">NA_Character</span>

    <span class="k">if</span> <span class="n">r_struct_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">r_struct_fn</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">NA_Character</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r_struct_fn</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span><span class="n">r_struct_fn</span><span class="p">,])</span>
    <span class="n">dont_plot_r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">BoolVector</span><span class="p">([</span><span class="n">dont_plot</span><span class="p">,])</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Plotting.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">resource_string</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;R_scripts/plotKmerDist.R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dont_plot</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;pdf(&quot;&#39;</span> <span class="o">+</span> <span class="n">pdf_fn</span> <span class="o">+</span> <span class="s1">&#39;&quot;, height=7, width=10)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">read_mean</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotKmerDistWReadPath&#39;</span><span class="p">)](</span>
            <span class="n">kmerDat</span><span class="p">,</span> <span class="n">baseDat</span><span class="p">,</span> <span class="n">r_struct_fn</span><span class="p">,</span> <span class="n">dont_plot_r</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotKmerDist&#39;</span><span class="p">)](</span>
            <span class="n">kmerDat</span><span class="p">,</span> <span class="n">baseDat</span><span class="p">,</span> <span class="n">r_struct_fn</span><span class="p">,</span> <span class="n">dont_plot_r</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dont_plot</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;dev.off()&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span>



<span class="c1">########################################</span>
<span class="c1">#### General data parsing functions ####</span>
<span class="c1">########################################</span>

<div class="viewcode-block" id="get_read_correction_data"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_read_correction_data">[docs]</a><span class="k">def</span> <span class="nf">get_read_correction_data</span><span class="p">(</span>
        <span class="n">r_data</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">,</span> <span class="n">num_obs</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_at_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">r_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r_strand</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">read_corr_data</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_read_correction_data</span><span class="p">(</span><span class="n">r_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">read_corr_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="p">(</span><span class="n">read_id</span><span class="p">,</span> <span class="n">signal_data</span><span class="p">,</span> <span class="n">raw_offset</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">lower_lim</span><span class="p">,</span> <span class="n">upper_lim</span><span class="p">,</span>
     <span class="n">old_segs</span><span class="p">,</span> <span class="n">old_align_vals</span><span class="p">,</span> <span class="n">new_align_vals</span><span class="p">,</span> <span class="n">events_end</span><span class="p">,</span>
     <span class="n">new_segs</span><span class="p">)</span> <span class="o">=</span> <span class="n">read_corr_data</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">native</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">r_strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
            <span class="n">reg_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_segs</span><span class="p">[</span><span class="n">reg_type</span> <span class="o">-</span> <span class="n">r_start</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">num_obs</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reg_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">new_segs</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">new_segs</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">reg_type</span> <span class="o">-</span> <span class="n">r_start</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                             <span class="o">-</span> <span class="n">num_obs</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_obs</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;start&#39;</span><span class="p">:</span>
        <span class="n">reg_start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
        <span class="n">reg_start</span> <span class="o">=</span> <span class="n">events_end</span> <span class="o">-</span> <span class="n">num_obs</span>
    <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
        <span class="n">reg_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">events_end</span> <span class="o">-</span> <span class="n">num_obs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;Invalid reg_type (int or str) to extract read correction data&#39;</span><span class="p">)</span>

    <span class="n">norm_reg_signal</span><span class="p">,</span> <span class="n">scale_values</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">normalize_raw_signal</span><span class="p">(</span>
        <span class="n">signal_data</span><span class="p">,</span> <span class="n">raw_offset</span> <span class="o">+</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">num_obs</span><span class="p">,</span>
        <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">lower_lim</span><span class="o">=</span><span class="n">lower_lim</span><span class="p">,</span>
        <span class="n">upper_lim</span><span class="o">=</span><span class="n">upper_lim</span><span class="p">)</span>

    <span class="c1"># calculate running difference</span>
    <span class="n">min_seg_len</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">sig_cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">norm_reg_signal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">running_diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sig_cs</span><span class="p">[</span><span class="n">min_seg_len</span><span class="p">:</span><span class="o">-</span><span class="n">min_seg_len</span><span class="p">])</span> <span class="o">-</span>
                           <span class="n">sig_cs</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">min_seg_len</span><span class="p">]</span> <span class="o">-</span>
                           <span class="n">sig_cs</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">min_seg_len</span><span class="p">:])</span>

    <span class="c1"># note that I need to check that both new and old segments are</span>
    <span class="c1"># in the region as the start of the same genomic position can</span>
    <span class="c1"># shift in raw space (i.e. only the old or new position could be</span>
    <span class="c1"># in the region of interest)</span>
    <span class="n">old_segs_in_reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">reg_start</span> <span class="o">&lt;=</span> <span class="n">old_segs</span><span class="p">,</span> <span class="n">old_segs</span> <span class="o">&lt;</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">num_obs</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">old_reg_segs</span> <span class="o">=</span> <span class="n">old_segs</span><span class="p">[</span><span class="n">old_segs_in_reg</span><span class="p">]</span>
    <span class="n">new_segs_in_reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">reg_start</span> <span class="o">&lt;=</span> <span class="n">new_segs</span><span class="p">,</span> <span class="n">new_segs</span> <span class="o">&lt;</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">num_obs</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">new_reg_segs</span> <span class="o">=</span> <span class="n">new_segs</span><span class="p">[</span><span class="n">new_segs_in_reg</span><span class="p">]</span>

    <span class="n">i_old_segs</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">old_segs</span><span class="p">)</span>
    <span class="n">i_new_segs</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">new_segs</span><span class="p">)</span>
    <span class="n">align_vals</span> <span class="o">=</span> <span class="p">[((</span><span class="n">old_b</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">i_old_segs</span><span class="p">)</span> <span class="k">if</span> <span class="n">old_b</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                   <span class="p">(</span><span class="n">new_b</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">i_new_segs</span><span class="p">)</span> <span class="k">if</span> <span class="n">new_b</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                  <span class="k">for</span> <span class="n">old_b</span><span class="p">,</span> <span class="n">new_b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old_align_vals</span><span class="p">,</span> <span class="n">new_align_vals</span><span class="p">)]</span>
    <span class="n">reg_align_vals</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">((</span><span class="n">old_b</span><span class="p">,</span> <span class="n">old_pos</span><span class="p">,</span> <span class="n">old_pos</span> <span class="ow">in</span> <span class="n">old_reg_segs</span><span class="p">),</span>
         <span class="p">(</span><span class="n">new_b</span><span class="p">,</span> <span class="n">new_pos</span><span class="p">,</span> <span class="n">new_pos</span> <span class="ow">in</span> <span class="n">new_reg_segs</span><span class="p">))</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">old_b</span><span class="p">,</span> <span class="n">old_pos</span><span class="p">),</span> <span class="p">(</span><span class="n">new_b</span><span class="p">,</span> <span class="n">new_pos</span><span class="p">)</span> <span class="ow">in</span> <span class="n">align_vals</span>
        <span class="k">if</span> <span class="n">old_pos</span> <span class="ow">in</span> <span class="n">old_reg_segs</span> <span class="ow">or</span> <span class="n">new_pos</span> <span class="ow">in</span> <span class="n">new_reg_segs</span><span class="p">]</span>

    <span class="c1"># summarize alignment for old and new segments</span>
    <span class="n">old_is_del</span><span class="p">,</span> <span class="n">old_is_mismatch</span><span class="p">,</span> <span class="n">new_is_ins</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">last_was_del</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">old_b</span><span class="p">,</span> <span class="n">old_pos</span><span class="p">,</span> <span class="n">old_in_reg</span><span class="p">),</span> <span class="p">(</span>
            <span class="n">new_b</span><span class="p">,</span> <span class="n">new_pos</span><span class="p">,</span> <span class="n">new_in_reg</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reg_align_vals</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">old_b</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="ow">and</span> <span class="n">new_in_reg</span><span class="p">:</span>
            <span class="n">new_is_ins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">new_b</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="ow">and</span> <span class="n">old_in_reg</span><span class="p">:</span>
            <span class="n">old_is_del</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">old_is_mismatch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">last_was_del</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_in_reg</span><span class="p">:</span>
                <span class="n">new_is_ins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_in_reg</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">last_was_del</span><span class="p">:</span>
                    <span class="n">old_is_del</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">last_was_del</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">old_is_del</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">old_is_mismatch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">old_b</span> <span class="o">!=</span> <span class="n">new_b</span><span class="p">)</span>

    <span class="n">old_bases</span><span class="p">,</span> <span class="n">old_reg_segs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reg_align_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
        <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">reg_align_vals</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">old_bases</span><span class="p">,</span> <span class="n">old_reg_segs</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
            <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">in_reg</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">reg_align_vals</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">in_reg</span><span class="p">])</span>
    <span class="n">new_bases</span><span class="p">,</span> <span class="n">new_reg_segs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reg_align_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
        <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reg_align_vals</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">new_bases</span><span class="p">,</span> <span class="n">new_reg_segs</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
            <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">in_reg</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reg_align_vals</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">in_reg</span><span class="p">])</span>

    <span class="c1"># bring positions to zero start if aligning multiple sequences</span>
    <span class="n">sig_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">reg_start</span><span class="p">,</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">num_obs</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">start_at_zero</span><span class="p">:</span>
        <span class="n">old_reg_segs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">old_seg_pos</span> <span class="o">-</span> <span class="n">reg_start</span> <span class="k">for</span> <span class="n">old_seg_pos</span> <span class="ow">in</span> <span class="n">old_reg_segs</span><span class="p">]</span>
        <span class="n">new_reg_segs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">new_seg_pos</span> <span class="o">-</span> <span class="n">reg_start</span> <span class="k">for</span> <span class="n">new_seg_pos</span> <span class="ow">in</span> <span class="n">new_reg_segs</span><span class="p">]</span>
        <span class="n">sig_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_obs</span><span class="p">))</span>

    <span class="n">old_dat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Position&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">old_reg_segs</span><span class="p">),</span>
        <span class="s1">&#39;Base&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">old_bases</span><span class="p">),</span>
        <span class="s1">&#39;IsDel&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">BoolVector</span><span class="p">(</span><span class="n">old_is_del</span><span class="p">),</span>
        <span class="s1">&#39;IsMismatch&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">BoolVector</span><span class="p">(</span><span class="n">old_is_mismatch</span><span class="p">),</span>
        <span class="s1">&#39;Read&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span><span class="n">read_id</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">old_bases</span><span class="p">))])}</span>
    <span class="n">new_dat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Position&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">new_reg_segs</span><span class="p">),</span>
        <span class="s1">&#39;Base&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">new_bases</span><span class="p">),</span>
        <span class="s1">&#39;IsIns&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">BoolVector</span><span class="p">(</span><span class="n">new_is_ins</span><span class="p">),</span>
        <span class="s1">&#39;Read&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span><span class="n">read_id</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_bases</span><span class="p">))])}</span>
    <span class="n">sig_dat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Signal&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">norm_reg_signal</span><span class="p">),</span>
        <span class="s1">&#39;Position&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">sig_range</span><span class="p">),</span>
        <span class="s1">&#39;Read&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span>
            <span class="n">read_id</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">norm_reg_signal</span><span class="p">))])}</span>
    <span class="n">diff_dat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Signal&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">running_diffs</span><span class="p">),</span>
        <span class="s1">&#39;Position&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">sig_range</span><span class="p">[</span>
            <span class="n">min_seg_len</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">running_diffs</span><span class="p">)</span> <span class="o">+</span> <span class="n">min_seg_len</span><span class="p">]),</span>
        <span class="s1">&#39;Read&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span>
            <span class="n">read_id</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">running_diffs</span><span class="p">))])}</span>
    <span class="c1"># add region is applicable</span>
    <span class="k">if</span> <span class="n">region_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">old_dat</span><span class="p">[</span><span class="s1">&#39;Region&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span>
            <span class="n">region_name</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">old_bases</span><span class="p">))])</span>
        <span class="n">new_dat</span><span class="p">[</span><span class="s1">&#39;Region&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span>
            <span class="n">region_name</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_bases</span><span class="p">))])</span>
        <span class="n">sig_dat</span><span class="p">[</span><span class="s1">&#39;Region&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span>
            <span class="n">region_name</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">norm_reg_signal</span><span class="p">))])</span>
        <span class="n">diff_dat</span><span class="p">[</span><span class="s1">&#39;Region&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span>
            <span class="n">region_name</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">running_diffs</span><span class="p">))])</span>

    <span class="n">old_dat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">old_dat</span><span class="p">)</span>
    <span class="n">new_dat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">new_dat</span><span class="p">)</span>
    <span class="n">sig_dat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sig_dat</span><span class="p">)</span>
    <span class="n">diff_dat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">diff_dat</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">old_dat</span><span class="p">,</span> <span class="n">new_dat</span><span class="p">,</span> <span class="n">sig_dat</span><span class="p">,</span> <span class="n">diff_dat</span>

<div class="viewcode-block" id="get_read_reg_events"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_read_reg_events">[docs]</a><span class="k">def</span> <span class="nf">get_read_reg_events</span><span class="p">(</span><span class="n">r_data</span><span class="p">,</span> <span class="n">int_start</span><span class="p">,</span> <span class="n">int_end</span><span class="p">):</span>
    <span class="n">r_means</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_single_slot_genome_centric</span><span class="p">(</span><span class="n">r_data</span><span class="p">,</span> <span class="s1">&#39;norm_mean&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r_means</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">int_start</span> <span class="ow">and</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">int_end</span><span class="p">:</span>
        <span class="c1"># handle reads that are contained in a region</span>
        <span class="n">start_overlap</span> <span class="o">=</span> <span class="n">int_end</span> <span class="o">-</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span>
        <span class="n">end_overlap</span> <span class="o">=</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">int_start</span>
        <span class="c1"># create region with nan values</span>
        <span class="n">region_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">int_end</span> <span class="o">-</span> <span class="n">int_start</span><span class="p">)</span>
        <span class="n">region_means</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
        <span class="n">region_means</span><span class="p">[</span><span class="o">-</span><span class="n">start_overlap</span><span class="p">:</span><span class="n">end_overlap</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[</span>
            <span class="o">-</span><span class="n">end_overlap</span><span class="p">:</span><span class="n">start_overlap</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">int_start</span><span class="p">:</span>
        <span class="c1"># handle reads that start in middle of region</span>
        <span class="n">start_overlap</span> <span class="o">=</span> <span class="n">int_end</span> <span class="o">-</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span>
        <span class="c1"># create region with nan values</span>
        <span class="n">region_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">int_end</span> <span class="o">-</span> <span class="n">int_start</span><span class="p">)</span>
        <span class="n">region_means</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
        <span class="n">region_means</span><span class="p">[</span><span class="o">-</span><span class="n">start_overlap</span><span class="p">:]</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[:</span><span class="n">start_overlap</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">int_end</span><span class="p">:</span>
        <span class="c1"># handle reads that end inside region</span>
        <span class="n">end_overlap</span> <span class="o">=</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">int_start</span>
        <span class="c1"># create region with nan values</span>
        <span class="n">region_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">int_end</span> <span class="o">-</span> <span class="n">int_start</span><span class="p">)</span>
        <span class="n">region_means</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
        <span class="n">region_means</span><span class="p">[:</span><span class="n">end_overlap</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[</span><span class="o">-</span><span class="n">end_overlap</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">region_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[</span>
            <span class="n">int_start</span> <span class="o">-</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">int_end</span> <span class="o">-</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span><span class="p">]</span>
</div>
    <span class="k">return</span> <span class="n">region_means</span>

<div class="viewcode-block" id="get_reg_events"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_reg_events">[docs]</a><span class="k">def</span> <span class="nf">get_reg_events</span><span class="p">(</span><span class="n">reg_reads</span><span class="p">,</span> <span class="n">int_start</span><span class="p">,</span> <span class="n">int_end</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span>
                   <span class="n">read_rows</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_reads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">reg_events</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">get_read_reg_events</span><span class="p">(</span><span class="n">r_data</span><span class="p">,</span> <span class="n">int_start</span><span class="p">,</span> <span class="n">int_end</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">reg_reads</span> <span class="k">if</span> <span class="n">strand</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="n">strand</span><span class="p">]</span>
    <span class="n">reg_events</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_means</span> <span class="k">for</span> <span class="n">r_means</span> <span class="ow">in</span> <span class="n">reg_events</span>
                  <span class="k">if</span> <span class="n">r_means</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">num_reads</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">reg_events</span> <span class="o">=</span> <span class="n">reg_events</span><span class="p">[:</span><span class="n">num_reads</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">read_rows</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">row_stack</span><span class="p">(</span><span class="n">reg_events</span><span class="p">)</span></div>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">reg_events</span><span class="p">)</span>

<div class="viewcode-block" id="get_event_data"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_event_data">[docs]</a><span class="k">def</span> <span class="nf">get_event_data</span><span class="p">(</span>
        <span class="n">all_reg_data</span><span class="p">,</span> <span class="n">plot_types</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">group_num</span><span class="o">=</span><span class="s1">&#39;Group1&#39;</span><span class="p">):</span>
    <span class="n">Position</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">Strand</span><span class="p">,</span> <span class="n">Region</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">reg_plot_sig</span><span class="p">,</span> <span class="n">reg_data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">plot_types</span><span class="p">,</span> <span class="n">all_reg_data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">reg_plot_sig</span> <span class="o">!=</span> <span class="s1">&#39;Density&#39;</span><span class="p">:</span> <span class="k">continue</span>

        <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="n">strand</span>
                   <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">reads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">reg_events</span> <span class="o">=</span> <span class="n">get_reg_events</span><span class="p">(</span>
                <span class="n">reg_data</span><span class="o">.</span><span class="n">reads</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">base_read_means</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg_events</span><span class="p">):</span>
                <span class="c1"># skip bases with zero or 1 read as ggplot won&#39;t</span>
                <span class="c1"># be able to estimate the density</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">base_read_means</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># remove nan  regions of reads from partial overlaps</span>
                <span class="n">base_read_means</span> <span class="o">=</span> <span class="n">base_read_means</span><span class="p">[</span>
                    <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">base_read_means</span><span class="p">)]</span>
                <span class="n">Position</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span>
                    <span class="n">pos</span> <span class="o">+</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">base_read_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">Signal</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">base_read_means</span><span class="p">)</span>
                <span class="n">Strand</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span>
                    <span class="n">FWD_STRAND</span> <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="n">REV_STRAND</span><span class="p">,</span>
                    <span class="n">base_read_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">Region</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span>
                    <span class="n">reg_data</span><span class="o">.</span><span class="n">reg_id</span><span class="p">,</span> <span class="n">base_read_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Position&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">IntVector</span><span class="p">(</span><span class="n">Position</span><span class="p">),</span>
        <span class="s1">&#39;Signal&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">Signal</span><span class="p">),</span>
        <span class="s1">&#39;Strand&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FactorVector</span><span class="p">(</span>
            <span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">Strand</span><span class="p">),</span>
            <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">((</span><span class="n">FWD_STRAND</span><span class="p">,</span> <span class="n">REV_STRAND</span><span class="p">))),</span>
        <span class="s1">&#39;Region&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">Region</span><span class="p">),</span></div>
        <span class="s1">&#39;Group&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">group_num</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Position</span><span class="p">))))})</span>

<div class="viewcode-block" id="get_boxplot_data"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_boxplot_data">[docs]</a><span class="k">def</span> <span class="nf">get_boxplot_data</span><span class="p">(</span>
        <span class="n">all_reg_data</span><span class="p">,</span> <span class="n">plot_types</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">group_num</span><span class="o">=</span><span class="s1">&#39;Group1&#39;</span><span class="p">):</span>
    <span class="p">(</span><span class="n">Position</span><span class="p">,</span> <span class="n">SigMin</span><span class="p">,</span> <span class="n">Sig25</span><span class="p">,</span> <span class="n">SigMed</span><span class="p">,</span> <span class="n">Sig75</span><span class="p">,</span> <span class="n">SigMax</span><span class="p">,</span> <span class="n">Strand</span><span class="p">,</span> <span class="n">Region</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[])</span>
    <span class="k">for</span> <span class="n">reg_plot_sig</span><span class="p">,</span> <span class="n">reg_data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">plot_types</span><span class="p">,</span> <span class="n">all_reg_data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">reg_plot_sig</span> <span class="o">!=</span> <span class="s1">&#39;Boxplot&#39;</span><span class="p">:</span> <span class="k">continue</span>

        <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="n">strand</span>
                   <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">reads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">reg_events</span> <span class="o">=</span> <span class="n">get_reg_events</span><span class="p">(</span>
                <span class="n">reg_data</span><span class="o">.</span><span class="n">reads</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">base_read_means</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg_events</span><span class="p">):</span>
                <span class="c1"># skip regions with no coverage</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">base_read_means</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># remove nan  regions of reads from partial overlaps</span>
                <span class="n">base_read_means</span> <span class="o">=</span> <span class="n">base_read_means</span><span class="p">[</span>
                    <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">base_read_means</span><span class="p">)]</span>
                <span class="n">Position</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
                <span class="n">SigMin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">base_read_means</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">Sig25</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">base_read_means</span><span class="p">,</span> <span class="mi">25</span><span class="p">))</span>
                <span class="n">SigMed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">base_read_means</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
                <span class="n">Sig75</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">base_read_means</span><span class="p">,</span> <span class="mi">75</span><span class="p">))</span>
                <span class="n">SigMax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">base_read_means</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
                <span class="n">Strand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">FWD_STRAND</span> <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="n">REV_STRAND</span><span class="p">)</span>
                <span class="n">Region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">reg_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Position&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">IntVector</span><span class="p">(</span><span class="n">Position</span><span class="p">),</span>
        <span class="s1">&#39;SigMin&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">SigMin</span><span class="p">),</span>
        <span class="s1">&#39;Sig25&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">Sig25</span><span class="p">),</span>
        <span class="s1">&#39;SigMed&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">SigMed</span><span class="p">),</span>
        <span class="s1">&#39;Sig75&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">Sig75</span><span class="p">),</span>
        <span class="s1">&#39;SigMax&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">SigMax</span><span class="p">),</span>
        <span class="s1">&#39;Strand&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FactorVector</span><span class="p">(</span>
            <span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">Strand</span><span class="p">),</span>
            <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">((</span><span class="n">FWD_STRAND</span><span class="p">,</span> <span class="n">REV_STRAND</span><span class="p">))),</span>
        <span class="s1">&#39;Region&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">Region</span><span class="p">),</span></div>
        <span class="s1">&#39;Group&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">group_num</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Position</span><span class="p">))))})</span>

<div class="viewcode-block" id="get_quant_data"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_quant_data">[docs]</a><span class="k">def</span> <span class="nf">get_quant_data</span><span class="p">(</span>
        <span class="n">all_reg_data</span><span class="p">,</span> <span class="n">plot_types</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">group_num</span><span class="o">=</span><span class="s1">&#39;Group1&#39;</span><span class="p">,</span>
        <span class="n">pos_offest</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pcntls</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">49</span><span class="p">]):</span>
    <span class="n">upper_pcntls</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span> <span class="o">-</span> <span class="n">pcntl</span> <span class="k">for</span> <span class="n">pcntl</span> <span class="ow">in</span> <span class="n">pcntls</span><span class="p">]</span>
    <span class="n">Position</span><span class="p">,</span> <span class="n">Lower</span><span class="p">,</span> <span class="n">Upper</span><span class="p">,</span> <span class="n">Strand</span><span class="p">,</span> <span class="n">Region</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">reg_plot_sig</span><span class="p">,</span> <span class="n">reg_data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">plot_types</span><span class="p">,</span> <span class="n">all_reg_data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">reg_plot_sig</span> <span class="o">!=</span> <span class="s1">&#39;Quantile&#39;</span><span class="p">:</span> <span class="k">continue</span>

        <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="n">strand</span>
                   <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">reads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">reg_events</span> <span class="o">=</span> <span class="n">get_reg_events</span><span class="p">(</span>
                <span class="n">reg_data</span><span class="o">.</span><span class="n">reads</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">base_read_means</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg_events</span><span class="p">):</span>
                <span class="c1"># skip regions with no coverage</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">base_read_means</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># remove nan regions of reads from partial overlaps</span>
                <span class="n">base_read_means</span> <span class="o">=</span> <span class="n">base_read_means</span><span class="p">[</span>
                    <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">base_read_means</span><span class="p">)]</span>
                <span class="n">Position</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span>
                    <span class="n">pos</span> <span class="o">+</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">pos_offest</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pcntls</span><span class="p">))))</span>
                <span class="n">Lower</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span>
                    <span class="n">base_read_means</span><span class="p">,</span> <span class="n">pcntls</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">))</span>
                <span class="n">Upper</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span>
                    <span class="n">base_read_means</span><span class="p">,</span> <span class="n">upper_pcntls</span><span class="p">,</span>
                    <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">))</span>
                <span class="n">Strand</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">FWD_STRAND</span> <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span>
                                <span class="n">REV_STRAND</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pcntls</span><span class="p">))))</span>
                <span class="n">Region</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">reg_id</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pcntls</span><span class="p">))))</span>

    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Position&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">Position</span><span class="p">),</span>
        <span class="s1">&#39;Lower&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">Lower</span><span class="p">),</span>
        <span class="s1">&#39;Upper&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">Upper</span><span class="p">),</span>
        <span class="s1">&#39;Strand&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FactorVector</span><span class="p">(</span>
            <span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">Strand</span><span class="p">),</span>
            <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">((</span><span class="n">FWD_STRAND</span><span class="p">,</span> <span class="n">REV_STRAND</span><span class="p">))),</span>
        <span class="s1">&#39;Region&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">Region</span><span class="p">),</span></div>
        <span class="s1">&#39;Group&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">group_num</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Position</span><span class="p">))))})</span>

<div class="viewcode-block" id="get_raw_signal_data"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_raw_signal_data">[docs]</a><span class="k">def</span> <span class="nf">get_raw_signal_data</span><span class="p">(</span>
        <span class="n">all_reg_data</span><span class="p">,</span> <span class="n">plot_types</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">group_num</span><span class="o">=</span><span class="s1">&#39;Group1&#39;</span><span class="p">):</span>
    <span class="n">not_warned</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">Position</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">Read</span><span class="p">,</span> <span class="n">Strand</span><span class="p">,</span> <span class="n">Region</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">reg_plot_sig</span><span class="p">,</span> <span class="n">reg_data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">plot_types</span><span class="p">,</span> <span class="n">all_reg_data</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reg_plot_sig</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Signal&#39;</span><span class="p">,</span> <span class="s1">&#39;Downsample&#39;</span><span class="p">):</span> <span class="k">continue</span>

        <span class="n">reg_reads</span> <span class="o">=</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">reads</span>
        <span class="k">if</span> <span class="n">reg_plot_sig</span> <span class="o">==</span> <span class="s1">&#39;Downsample&#39;</span><span class="p">:</span>
            <span class="n">plus_reads</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_data</span> <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">reads</span>
                          <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">]</span>
            <span class="n">minus_reads</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_data</span> <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">reads</span>
                           <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">]</span>
            <span class="c1"># randomly select reads to plot if too many</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plus_reads</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">overplot_thresh</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">plus_reads</span><span class="p">)</span>
                <span class="n">plus_reads</span> <span class="o">=</span> <span class="n">plus_reads</span><span class="p">[:</span><span class="n">overplot_thresh</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">minus_reads</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">overplot_thresh</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">minus_reads</span><span class="p">)</span>
                <span class="n">minus_reads</span> <span class="o">=</span> <span class="n">minus_reads</span><span class="p">[:</span><span class="n">overplot_thresh</span><span class="p">]</span>
            <span class="n">reg_reads</span> <span class="o">=</span> <span class="n">plus_reads</span> <span class="o">+</span> <span class="n">minus_reads</span>
        <span class="k">for</span> <span class="n">r_num</span><span class="p">,</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg_reads</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r_sig</span><span class="p">,</span> <span class="n">overlap_seg_data</span><span class="p">,</span> <span class="n">start_offset</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_raw_signal</span><span class="p">(</span>
                    <span class="n">r_data</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">not_warned</span><span class="p">:</span>
                    <span class="n">not_warned</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
                        <span class="s1">&#39;Genome resolved raw signal could not be retrieved &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;for some reads. Ensure that reads have been &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;re-squiggled and that all data slot corresponding &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;accordingly.&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">base_i</span><span class="p">,</span> <span class="p">(</span><span class="n">b_start</span><span class="p">,</span> <span class="n">b_end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                    <span class="n">overlap_seg_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">overlap_seg_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
                <span class="n">Position</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">base_i</span> <span class="o">+</span> <span class="n">start_offset</span> <span class="o">+</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b_end</span> <span class="o">-</span> <span class="n">b_start</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="n">Signal</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">r_sig</span><span class="p">[</span><span class="n">b_start</span><span class="o">-</span><span class="n">overlap_seg_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="n">b_end</span><span class="o">-</span><span class="n">overlap_seg_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">Read</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span>
                    <span class="n">unicode</span><span class="p">(</span><span class="n">r_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">group_num</span><span class="p">,</span> <span class="n">b_end</span> <span class="o">-</span> <span class="n">b_start</span><span class="p">)))</span>
                <span class="n">Strand</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span>
                    <span class="n">FWD_STRAND</span> <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span>
                    <span class="n">REV_STRAND</span><span class="p">,</span> <span class="n">b_end</span> <span class="o">-</span> <span class="n">b_start</span><span class="p">)))</span>
                <span class="n">Region</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">reg_id</span><span class="p">,</span> <span class="n">b_end</span> <span class="o">-</span> <span class="n">b_start</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Position&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">Position</span><span class="p">),</span>
        <span class="s1">&#39;Signal&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">Signal</span><span class="p">),</span>
        <span class="s1">&#39;Read&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">Read</span><span class="p">),</span>
        <span class="s1">&#39;Strand&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FactorVector</span><span class="p">(</span>
            <span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">Strand</span><span class="p">),</span>
            <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">((</span><span class="n">FWD_STRAND</span><span class="p">,</span> <span class="n">REV_STRAND</span><span class="p">))),</span>
        <span class="s1">&#39;Region&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">Region</span><span class="p">),</span></div>
        <span class="s1">&#39;Group&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">group_num</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Position</span><span class="p">))))})</span>

<div class="viewcode-block" id="get_plot_types_data"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_plot_types_data">[docs]</a><span class="k">def</span> <span class="nf">get_plot_types_data</span><span class="p">(</span><span class="n">plot_args</span><span class="p">,</span> <span class="n">quant_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">SignalData</span> <span class="o">=</span> <span class="n">get_raw_signal_data</span><span class="p">(</span><span class="o">*</span><span class="n">plot_args</span><span class="p">)</span>
    <span class="n">QuantData</span> <span class="o">=</span> <span class="n">get_quant_data</span><span class="p">(</span><span class="o">*</span><span class="n">plot_args</span><span class="p">,</span> <span class="n">pos_offest</span><span class="o">=</span><span class="n">quant_offset</span><span class="p">)</span>
    <span class="n">BoxData</span> <span class="o">=</span> <span class="n">get_boxplot_data</span><span class="p">(</span><span class="o">*</span><span class="n">plot_args</span><span class="p">)</span>
    <span class="n">EventData</span> <span class="o">=</span> <span class="n">get_event_data</span><span class="p">(</span><span class="o">*</span><span class="n">plot_args</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">SignalData</span><span class="p">,</span> <span class="n">QuantData</span><span class="p">,</span> <span class="n">BoxData</span><span class="p">,</span> <span class="n">EventData</span>

<div class="viewcode-block" id="get_base_r_data"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_base_r_data">[docs]</a><span class="k">def</span> <span class="nf">get_base_r_data</span><span class="p">(</span><span class="n">all_reg_data</span><span class="p">,</span> <span class="n">zero_start</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_rna</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">BaseStart</span><span class="p">,</span> <span class="n">Bases</span><span class="p">,</span> <span class="n">BaseRegion</span><span class="p">,</span> <span class="n">BaseStrand</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">reg_data</span> <span class="ow">in</span> <span class="n">all_reg_data</span><span class="p">:</span>
        <span class="c1"># skip regions without sequence data</span>
        <span class="k">if</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">seq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="ow">or</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">strand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">base</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">seq</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">is_rna</span> <span class="ow">and</span> <span class="n">base</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
                    <span class="n">base</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span>
                <span class="k">if</span> <span class="n">zero_start</span><span class="p">:</span>
                    <span class="n">BaseStart</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">BaseStart</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
                <span class="n">Bases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
                <span class="n">BaseRegion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">reg_id</span><span class="p">)</span>
                <span class="n">BaseStrand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FWD_STRAND</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="ow">or</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">strand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">base</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">seq</span><span class="p">):</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">COMP_BASES</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_rna</span> <span class="ow">and</span> <span class="n">base</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
                    <span class="n">base</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span>
                <span class="k">if</span> <span class="n">zero_start</span><span class="p">:</span>
                    <span class="n">BaseStart</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">BaseStart</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
                <span class="n">Bases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
                <span class="n">BaseRegion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">reg_id</span><span class="p">)</span>
                <span class="n">BaseStrand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">REV_STRAND</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Position&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">BaseStart</span><span class="p">),</span>
        <span class="s1">&#39;Base&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">Bases</span><span class="p">),</span>
        <span class="s1">&#39;Region&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">BaseRegion</span><span class="p">),</span>
        <span class="s1">&#39;Strand&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FactorVector</span><span class="p">(</span>
            <span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">BaseStrand</span><span class="p">),</span></div>
            <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">((</span><span class="n">FWD_STRAND</span><span class="p">,</span> <span class="n">REV_STRAND</span><span class="p">)))})</span>


<div class="viewcode-block" id="get_model_r_data"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_model_r_data">[docs]</a><span class="k">def</span> <span class="nf">get_model_r_data</span><span class="p">(</span><span class="n">all_reg_model_data</span><span class="p">):</span>
    <span class="n">Position</span><span class="p">,</span> <span class="n">Strand</span><span class="p">,</span> <span class="n">Mean</span><span class="p">,</span> <span class="n">SD</span><span class="p">,</span> <span class="n">Region</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">reg_id</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">fwd_model_data</span><span class="p">,</span> <span class="n">rev_model_data</span> <span class="ow">in</span> <span class="n">all_reg_model_data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="ow">or</span> <span class="n">strand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">base_model_mean</span><span class="p">,</span> <span class="n">base_model_sd</span> <span class="ow">in</span> <span class="n">fwd_model_data</span><span class="p">:</span>
                <span class="n">Position</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">Strand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FWD_STRAND</span><span class="p">)</span>
                <span class="n">Mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_model_mean</span><span class="p">)</span>
                <span class="n">SD</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_model_sd</span><span class="p">)</span>
                <span class="n">Region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="ow">or</span> <span class="n">strand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">base_model_mean</span><span class="p">,</span> <span class="n">base_model_sd</span> <span class="ow">in</span> <span class="n">rev_model_data</span><span class="p">:</span>
                <span class="n">Position</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">Strand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">REV_STRAND</span><span class="p">)</span>
                <span class="n">Mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_model_mean</span><span class="p">)</span>
                <span class="n">SD</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_model_sd</span><span class="p">)</span>
                <span class="n">Region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Position&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">Position</span><span class="p">),</span>
        <span class="s1">&#39;Strand&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FactorVector</span><span class="p">(</span>
            <span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">Strand</span><span class="p">),</span>
            <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">((</span><span class="n">FWD_STRAND</span><span class="p">,</span> <span class="n">REV_STRAND</span><span class="p">))),</span>
        <span class="s1">&#39;Mean&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">Mean</span><span class="p">),</span>
        <span class="s1">&#39;SD&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">SD</span><span class="p">),</span></div>
        <span class="s1">&#39;Region&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">Region</span><span class="p">)})</span>

<div class="viewcode-block" id="get_reg_r_stats"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_reg_r_stats">[docs]</a><span class="k">def</span> <span class="nf">get_reg_r_stats</span><span class="p">(</span><span class="n">all_reg_stats</span><span class="p">,</span> <span class="n">are_pvals</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">Stats</span><span class="p">,</span> <span class="n">Position</span><span class="p">,</span> <span class="n">Read</span><span class="p">,</span> <span class="n">Region</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">OrdRead</span><span class="p">,</span> <span class="n">OrdRegion</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">reg_id</span><span class="p">,</span> <span class="n">reg_stats</span> <span class="ow">in</span> <span class="n">all_reg_stats</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">are_pvals</span><span class="p">:</span>
            <span class="n">reg_stats</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">)</span>
        <span class="n">OrdRead</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">order_reads</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">))</span>
        <span class="n">OrdRegion</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">reg_id</span><span class="p">,</span> <span class="n">reg_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">read_i</span><span class="p">,</span> <span class="n">read_stats</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">pos_stat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">read_stats</span><span class="p">):</span>
                <span class="n">Stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_stat</span><span class="p">)</span>
                <span class="n">Position</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">Read</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_i</span><span class="p">)</span>
                <span class="n">Region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_id</span><span class="p">)</span>

    <span class="n">StatsData</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Stats&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">Stats</span><span class="p">),</span>
        <span class="s1">&#39;Position&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">Position</span><span class="p">),</span>
        <span class="s1">&#39;Read&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">Read</span><span class="p">),</span>
        <span class="s1">&#39;Region&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">Region</span><span class="p">)})</span>
    <span class="n">OrdData</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Read&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">OrdRead</span><span class="p">),</span>
        <span class="s1">&#39;Region&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">OrdRegion</span><span class="p">)})</span></div>
    <span class="k">return</span> <span class="n">StatsData</span><span class="p">,</span> <span class="n">OrdData</span>



<span class="c1">########################################</span>
<span class="c1">#### Base plotting linker functions ####</span>
<span class="c1">########################################</span>

<div class="viewcode-block" id="plot_corrections"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_corrections">[docs]</a><span class="k">def</span> <span class="nf">plot_corrections</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span>
        <span class="n">reg_type</span><span class="p">,</span> <span class="n">num_obs</span><span class="p">,</span> <span class="n">num_reads</span><span class="p">):</span>
    <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span><span class="s1">&#39;The plot_correction command may be deprecated in &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;future versions of Tombo.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Preparing plot data.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">OldSegDat</span><span class="p">,</span> <span class="n">NewSegDat</span><span class="p">,</span> <span class="n">SigDat</span><span class="p">,</span> <span class="n">DiffDat</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">raw_read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_data</span> <span class="k">for</span> <span class="n">cs_r_data</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
             <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">cs_r_data</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">old_dat</span><span class="p">,</span> <span class="n">new_dat</span><span class="p">,</span> <span class="n">signal_dat</span><span class="p">,</span> <span class="n">diff_dat</span> <span class="o">=</span> <span class="n">get_read_correction_data</span><span class="p">(</span>
            <span class="n">r_data</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">,</span> <span class="n">num_obs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old_dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># skip reads that don&#39;t have correction slots b/c they</span>
            <span class="c1"># couldn&#39;t be corrected</span>
            <span class="k">continue</span>
        <span class="n">OldSegDat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">old_dat</span><span class="p">)</span>
        <span class="n">NewSegDat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_dat</span><span class="p">)</span>
        <span class="n">SigDat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal_dat</span><span class="p">)</span>
        <span class="n">DiffDat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diff_dat</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">OldSegDat</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">num_reads</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">OldSegDat</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;No reads were able to be processed. This command is &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;only applicable to reads processed with event_resquiggle. &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;Also check that --corrected-group and --basecall-subgroup &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;match the event_resquiggle command.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">OldSegDat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_reads</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Fewer reads than requested were able to &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;be processed. Likely too few reads provided or &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;those provided were not corrected.&#39;</span><span class="p">)</span>
    <span class="n">OldSegDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">rbind</span><span class="p">(</span><span class="o">*</span><span class="n">OldSegDat</span><span class="p">)</span>
    <span class="n">NewSegDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">rbind</span><span class="p">(</span><span class="o">*</span><span class="n">NewSegDat</span><span class="p">)</span>
    <span class="n">SigDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">rbind</span><span class="p">(</span><span class="o">*</span><span class="n">SigDat</span><span class="p">)</span>
    <span class="n">DiffDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">rbind</span><span class="p">(</span><span class="o">*</span><span class="n">DiffDat</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Plotting.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">resource_string</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;R_scripts/plotReadCorr.R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;pdf(&quot;&#39;</span> <span class="o">+</span> <span class="n">pdf_fn</span> <span class="o">+</span> <span class="s1">&#39;&quot;, height=7, width=11)&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotReadCorr&#39;</span><span class="p">)](</span><span class="n">OldSegDat</span><span class="p">,</span> <span class="n">NewSegDat</span><span class="p">,</span> <span class="n">SigDat</span><span class="p">,</span> <span class="n">DiffDat</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;dev.off()&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="plot_multi_corrections"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_multi_corrections">[docs]</a><span class="k">def</span> <span class="nf">plot_multi_corrections</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span>
        <span class="n">num_reads_per_plot</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">,</span> <span class="n">num_obs</span><span class="p">,</span> <span class="n">include_orig_bcs</span><span class="p">,</span>
        <span class="n">genome_locations</span><span class="p">):</span>
    <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span><span class="s1">&#39;The plot_multi_correction command may be deprecated &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;in future versions of Tombo.&#39;</span><span class="p">)</span>
    <span class="n">num_regions</span> <span class="o">=</span> <span class="n">num_regions</span> <span class="k">if</span> <span class="n">num_regions</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
                  <span class="n">num_regions</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">raw_read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
    <span class="n">read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_coverage</span><span class="p">(</span><span class="n">raw_read_coverage</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">genome_locations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coverage_regions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">),</span> <span class="n">cs_coverage</span> <span class="ow">in</span> <span class="n">read_coverage</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">reg_covs</span><span class="p">,</span> <span class="n">reg_lens</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">cs_coverage</span><span class="p">)])</span>
            <span class="n">coverage_regions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                <span class="n">reg_covs</span><span class="p">,</span> <span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg_len</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">reg_len</span> <span class="ow">in</span>
                           <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">reg_lens</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">reg_lens</span><span class="p">)],</span>
                <span class="n">repeat</span><span class="p">(</span><span class="n">chrm</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="n">strand</span><span class="p">)))</span>

        <span class="c1"># randomly select regions with at least num_reads_to_plot regions</span>
        <span class="n">coverage_regions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">reg_center</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">stat</span><span class="p">,</span> <span class="n">reg_center</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span>
            <span class="n">coverage_regions</span> <span class="k">if</span> <span class="n">stat</span> <span class="o">&gt;=</span> <span class="n">num_reads_per_plot</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">coverage_regions</span><span class="p">)</span>
        <span class="n">plot_locs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rn</span><span class="p">)</span> <span class="k">for</span> <span class="n">rn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_regions</span><span class="p">)],</span>
            <span class="n">coverage_regions</span><span class="p">[:</span><span class="n">num_regions</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_locs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_regions</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
                <span class="s1">&#39;Fewer regions contain minimum &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;number of reads than requested.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Parsing genome locations.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">parsed_locations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chrm_pos_strand</span> <span class="ow">in</span> <span class="n">genome_locations</span><span class="p">:</span>
            <span class="n">split_vals</span> <span class="o">=</span> <span class="n">chrm_pos_strand</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="c1"># default to plus strand if not specified</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_vals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">parsed_locations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                    <span class="n">split_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">split_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;+&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parsed_locations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split_vals</span><span class="p">)</span>
        <span class="n">plot_locs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">strand</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parsed_locations</span><span class="p">)]</span>
        <span class="c1"># filter regions with no coverage</span>
        <span class="n">plot_locs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">reg_i</span><span class="p">,</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">strand</span><span class="p">))</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">reg_i</span><span class="p">,</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">strand</span><span class="p">))</span> <span class="ow">in</span> <span class="n">plot_locs</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">in</span> <span class="n">read_coverage</span> <span class="ow">and</span>
            <span class="n">read_coverage</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)][</span><span class="n">start</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_locs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsed_locations</span><span class="p">):</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
                <span class="s1">&#39;Some regions did not contain read coverage.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_locs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;No regions contain minimum number of reads.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Preparing plot data.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">OldSegDat</span><span class="p">,</span> <span class="n">NewSegDat</span><span class="p">,</span> <span class="n">SigDat</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">reg_i</span><span class="p">,</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">reg_center</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">in</span> <span class="n">plot_locs</span><span class="p">:</span>
        <span class="n">reg_num_reads</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">## get num_reads_per_region reads from this region</span>
        <span class="n">reg_reads</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">r_data</span> <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">reg_center</span> <span class="o">-</span> <span class="p">(</span><span class="n">num_obs</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">r_data</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">reg_center</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_obs</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="n">strand</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">reg_reads</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">old_dat</span><span class="p">,</span> <span class="n">new_dat</span><span class="p">,</span> <span class="n">signal_dat</span><span class="p">,</span> <span class="n">diff_dat</span> \
                    <span class="o">=</span> <span class="n">get_read_correction_data</span><span class="p">(</span>
                        <span class="n">r_data</span><span class="p">,</span> <span class="n">reg_center</span><span class="p">,</span> <span class="n">num_obs</span><span class="p">,</span> <span class="n">reg_i</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">r_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span><span class="p">)</span>
            <span class="c1"># some FAST5 files give an error:</span>
            <span class="c1">#     &quot;Can&#39;t read data (Inflate() failed)&quot;</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">old_dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># skip reads that don&#39;t have correction slots b/c they</span>
                <span class="c1"># couldn&#39;t be corrected</span>
                <span class="k">continue</span>
            <span class="n">OldSegDat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">old_dat</span><span class="p">)</span>
            <span class="n">NewSegDat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_dat</span><span class="p">)</span>
            <span class="n">SigDat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal_dat</span><span class="p">)</span>
            <span class="n">reg_num_reads</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">reg_num_reads</span> <span class="o">&gt;=</span> <span class="n">num_reads_per_plot</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">reg_num_reads</span> <span class="o">&lt;</span> <span class="n">num_reads_per_plot</span><span class="p">:</span>
            <span class="c1"># TODO: figure out if we should warn here</span>
            <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">OldSegDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">rbind</span><span class="p">(</span><span class="o">*</span><span class="n">OldSegDat</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">OldSegDat</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">NewSegDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">rbind</span><span class="p">(</span><span class="o">*</span><span class="n">NewSegDat</span><span class="p">)</span>
    <span class="n">SigDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">rbind</span><span class="p">(</span><span class="o">*</span><span class="n">SigDat</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Plotting.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">resource_string</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;R_scripts/plotMultiReadCorr.R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;pdf(&quot;&#39;</span> <span class="o">+</span> <span class="n">pdf_fn</span> <span class="o">+</span> <span class="s1">&#39;&quot;, height=5, width=11)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">include_orig_bcs</span> <span class="ow">and</span> <span class="n">OldSegDat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotMultiReadCorr&#39;</span><span class="p">)](</span><span class="n">OldSegDat</span><span class="p">,</span> <span class="n">NewSegDat</span><span class="p">,</span> <span class="n">SigDat</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotMultiReadCorrNoOrig&#39;</span><span class="p">)](</span><span class="n">NewSegDat</span><span class="p">,</span> <span class="n">SigDat</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;dev.off()&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="get_plots_titles"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_plots_titles">[docs]</a><span class="k">def</span> <span class="nf">get_plots_titles</span><span class="p">(</span><span class="n">all_reg_data</span><span class="p">,</span> <span class="n">all_reg_data2</span><span class="p">,</span> <span class="n">overplot_type</span><span class="p">,</span>
                     <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">model_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">strand_cov</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">reg_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_reg_data</span><span class="p">)):</span>
        <span class="n">reg_cov1</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">all_reg_data</span><span class="p">[</span><span class="n">reg_i</span><span class="p">]</span><span class="o">.</span><span class="n">reads</span><span class="p">),</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">all_reg_data</span><span class="p">[</span><span class="n">reg_i</span><span class="p">]</span><span class="o">.</span><span class="n">reads</span><span class="p">)]</span>
        <span class="n">reg_cov2</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">all_reg_data2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">all_reg_data2</span><span class="p">[</span><span class="n">reg_i</span><span class="p">]</span><span class="o">.</span><span class="n">reads</span><span class="p">),</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">all_reg_data2</span><span class="p">[</span><span class="n">reg_i</span><span class="p">]</span><span class="o">.</span><span class="n">reads</span><span class="p">)]</span>
        <span class="n">strand_cov</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_cov1</span> <span class="o">+</span> <span class="n">reg_cov2</span><span class="p">)</span>
    <span class="c1"># downsample can be plotted with any number of reads on either strand</span>
    <span class="k">if</span> <span class="n">overplot_type</span> <span class="o">==</span> <span class="s2">&quot;Downsample&quot;</span><span class="p">:</span>
        <span class="n">plot_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Downsample&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">strand_cov</span><span class="p">]</span>
        <span class="n">dnspl_stars</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="n">grp_r_ovr_cov</span> <span class="o">&gt;</span> <span class="n">overplot_thresh</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
             <span class="k">for</span> <span class="n">grp_r_ovr_cov</span> <span class="ow">in</span> <span class="n">r_cov</span><span class="p">]</span> <span class="k">for</span> <span class="n">r_cov</span> <span class="ow">in</span> <span class="n">strand_cov</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># need to remove 0 cov as might be plotting on just one strand</span>
        <span class="n">gt0_strand_cov</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">covs</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">covs</span> <span class="ow">in</span> <span class="n">strand_cov</span><span class="p">]</span>
        <span class="n">plot_types</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;Signal&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">covs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">overplot_thresh</span> <span class="ow">or</span>
                         <span class="nb">min</span><span class="p">(</span><span class="n">covs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">QUANT_MIN</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">overplot_type</span> <span class="k">for</span> <span class="n">covs</span> <span class="ow">in</span> <span class="n">gt0_strand_cov</span><span class="p">]</span>
        <span class="n">dnspl_stars</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">r_cov</span><span class="p">]</span> <span class="k">for</span> <span class="n">r_cov</span> <span class="ow">in</span> <span class="n">strand_cov</span><span class="p">]</span>

    <span class="n">titles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">int_i</span><span class="p">,</span> <span class="n">r_cov</span><span class="p">,</span> <span class="n">r_ovp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_reg_data</span><span class="p">,</span> <span class="n">strand_cov</span><span class="p">,</span> <span class="n">dnspl_stars</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">all_reg_data2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">reg_title</span> <span class="o">=</span> <span class="n">int_i</span><span class="o">.</span><span class="n">chrm</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">int_i</span><span class="o">.</span><span class="n">reg_text</span> <span class="o">+</span> \
                        <span class="s2">&quot; ::: Coverage: &quot;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">r_cov</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">r_ovp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="s2">&quot; + &quot;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">r_cov</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">r_ovp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; -&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cov_str</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">r_cov</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">r_ovp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> \
                          <span class="k">else</span> <span class="n">unicode</span><span class="p">(</span><span class="n">r_cov</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">r_ovp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">reg_title</span> <span class="o">=</span> <span class="n">int_i</span><span class="o">.</span><span class="n">chrm</span> <span class="o">+</span> <span class="p">(</span>
                    <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span> <span class="k">if</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> \
                    <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">int_i</span><span class="o">.</span><span class="n">reg_text</span> <span class="o">+</span> <span class="s2">&quot; ::: Coverage: &quot;</span> <span class="o">+</span> <span class="n">cov_str</span>
            <span class="k">if</span> <span class="n">model_plot</span> <span class="ow">and</span> <span class="n">overplot_type</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="s1">&#39;Density&#39;</span><span class="p">,</span> <span class="s1">&#39;Quantile&#39;</span><span class="p">,</span> <span class="s1">&#39;Boxplot&#39;</span><span class="p">):</span>
                <span class="n">reg_title</span> <span class="o">+=</span> <span class="s1">&#39; (Model in Black)&#39;</span>
            <span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_title</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">int_i</span><span class="o">.</span><span class="n">chrm</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">int_i</span><span class="o">.</span><span class="n">reg_text</span> <span class="o">+</span>
                    <span class="s2">&quot; ::: Coverage: Sample (Red): &quot;</span> <span class="o">+</span>
                    <span class="n">unicode</span><span class="p">(</span><span class="n">r_cov</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">r_ovp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; + &quot;</span> <span class="o">+</span>
                    <span class="n">unicode</span><span class="p">(</span><span class="n">r_cov</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">r_ovp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; -; Control (Black): &quot;</span> <span class="o">+</span>
                    <span class="n">unicode</span><span class="p">(</span><span class="n">r_cov</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">r_ovp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; + &quot;</span> <span class="o">+</span>
                    <span class="n">unicode</span><span class="p">(</span><span class="n">r_cov</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="n">r_ovp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; -&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cov_str</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s1">&#39;Sample (Red): &#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">r_cov</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">r_ovp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                    <span class="s1">&#39;; Control (Black): &#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">r_cov</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">r_ovp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="p">)</span> <span class="k">if</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="p">(</span>
                    <span class="s1">&#39;Sample (Red): &#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">r_cov</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">r_ovp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                    <span class="s1">&#39;; Control (Black): &#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">r_cov</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="n">r_ovp</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">int_i</span><span class="o">.</span><span class="n">chrm</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">int_i</span><span class="o">.</span><span class="n">reg_text</span> <span class="o">+</span>
                    <span class="s2">&quot; ::: Coverage: &quot;</span> <span class="o">+</span> <span class="n">cov_str</span><span class="p">)</span>

    <span class="n">Titles</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Title&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">titles</span><span class="p">),</span>
        <span class="s1">&#39;Region&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span><span class="n">int_i</span><span class="o">.</span><span class="n">reg_id</span> <span class="k">for</span> <span class="n">int_i</span> <span class="ow">in</span> <span class="n">all_reg_data</span><span class="p">])})</span>
</div>
    <span class="k">return</span> <span class="n">Titles</span><span class="p">,</span> <span class="n">plot_types</span>

<div class="viewcode-block" id="plot_single_sample"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_single_sample">[docs]</a><span class="k">def</span> <span class="nf">plot_single_sample</span><span class="p">(</span>
        <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span>
        <span class="n">overplot_type</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Preparing plot data.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">all_reg_data</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_region_reads</span><span class="p">(</span><span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_reg_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span><span class="s1">&#39;No reads in any selected regions.&#39;</span><span class="p">)</span>
    <span class="n">rna</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">is_rna</span><span class="p">(</span><span class="n">raw_read_coverage</span><span class="p">)</span>

    <span class="n">Titles</span><span class="p">,</span> <span class="n">plot_types</span> <span class="o">=</span> <span class="n">get_plots_titles</span><span class="p">(</span>
        <span class="n">all_reg_data</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">overplot_type</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">)</span>

    <span class="n">BasesData</span> <span class="o">=</span> <span class="n">get_base_r_data</span><span class="p">(</span><span class="n">all_reg_data</span><span class="p">,</span> <span class="n">is_rna</span><span class="o">=</span><span class="n">rna</span><span class="p">)</span>
    <span class="n">SignalData</span><span class="p">,</span> <span class="n">QuantData</span><span class="p">,</span> <span class="n">BoxData</span><span class="p">,</span> <span class="n">EventData</span> <span class="o">=</span> <span class="n">get_plot_types_data</span><span class="p">(</span>
        <span class="p">(</span><span class="n">all_reg_data</span><span class="p">,</span> <span class="n">plot_types</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="s1">&#39;Group1&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Plotting.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">resource_string</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;R_scripts/plotSingleRun.R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;pdf(&quot;&#39;</span> <span class="o">+</span> <span class="n">pdf_fn</span> <span class="o">+</span> <span class="s1">&#39;&quot;, height=5, width=11)&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotSingleRun&#39;</span><span class="p">)](</span><span class="n">SignalData</span><span class="p">,</span> <span class="n">QuantData</span><span class="p">,</span> <span class="n">BoxData</span><span class="p">,</span>
                                      <span class="n">EventData</span><span class="p">,</span> <span class="n">BasesData</span><span class="p">,</span> <span class="n">Titles</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;dev.off()&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="filter_and_merge_group_regs"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.filter_and_merge_group_regs">[docs]</a><span class="k">def</span> <span class="nf">filter_and_merge_group_regs</span><span class="p">(</span><span class="n">g1_data</span><span class="p">,</span> <span class="n">g2_data</span><span class="p">):</span>
    <span class="n">filt_g1</span><span class="p">,</span> <span class="n">filt_g2</span><span class="p">,</span> <span class="n">merged_reg_data</span><span class="p">,</span> <span class="n">both_no_cov</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">g1_data</span><span class="p">,</span> <span class="n">g2_data</span><span class="p">):</span>
        <span class="n">both_reads</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">reads</span> <span class="o">+</span> <span class="n">r2</span><span class="o">.</span><span class="n">reads</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">both_reads</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">merged_reg_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">reads</span><span class="o">=</span><span class="n">both_reads</span><span class="p">))</span>
            <span class="n">filt_g1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
            <span class="n">filt_g2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">both_no_cov</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">(</span>
                <span class="n">r1</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">unicode</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">end</span><span class="p">),</span>
                <span class="n">r1</span><span class="o">.</span><span class="n">strand</span><span class="p">))))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">both_no_cov</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Some regions include no reads: &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">both_no_cov</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_reg_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span><span class="s1">&#39;No reads in any selected regions.&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">merged_reg_data</span><span class="p">,</span> <span class="n">filt_g1</span><span class="p">,</span> <span class="n">filt_g2</span>

<div class="viewcode-block" id="plot_two_samples"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_two_samples">[docs]</a><span class="k">def</span> <span class="nf">plot_two_samples</span><span class="p">(</span>
        <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage1</span><span class="p">,</span> <span class="n">raw_read_coverage2</span><span class="p">,</span>
        <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">overplot_type</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span> <span class="n">seqs_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Preparing plot data.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># get reads overlapping each region</span>
    <span class="n">all_reg_data1</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_region_reads</span><span class="p">(</span>
        <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage1</span><span class="p">,</span> <span class="n">filter_no_cov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_seq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">all_reg_data2</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_region_reads</span><span class="p">(</span>
        <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage2</span><span class="p">,</span> <span class="n">filter_no_cov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_seq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># filter regions with no coverage in either read group</span>
    <span class="n">merged_reg_data</span><span class="p">,</span> <span class="n">all_reg_data1</span><span class="p">,</span> <span class="n">all_reg_data2</span> <span class="o">=</span> <span class="n">filter_and_merge_group_regs</span><span class="p">(</span>
        <span class="n">all_reg_data1</span><span class="p">,</span> <span class="n">all_reg_data2</span><span class="p">)</span>

    <span class="n">Titles</span><span class="p">,</span> <span class="n">plot_types</span> <span class="o">=</span> <span class="n">get_plots_titles</span><span class="p">(</span>
        <span class="n">all_reg_data1</span><span class="p">,</span> <span class="n">all_reg_data2</span><span class="p">,</span> <span class="n">overplot_type</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">)</span>

    <span class="n">merged_reg_data</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">add_reg_seq</span><span class="p">(</span><span class="n">merged_reg_data</span><span class="p">)</span>
    <span class="n">BasesData</span> <span class="o">=</span> <span class="n">get_base_r_data</span><span class="p">(</span><span class="n">merged_reg_data</span><span class="p">)</span>

    <span class="c1"># get plotting data for either quantiles of raw signal</span>
    <span class="n">SignalData1</span><span class="p">,</span> <span class="n">QuantData1</span><span class="p">,</span> <span class="n">BoxData1</span><span class="p">,</span> <span class="n">EventData1</span> <span class="o">=</span> <span class="n">get_plot_types_data</span><span class="p">(</span>
        <span class="p">(</span><span class="n">all_reg_data1</span><span class="p">,</span> <span class="n">plot_types</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="s1">&#39;Group1&#39;</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">SignalData2</span><span class="p">,</span> <span class="n">QuantData2</span><span class="p">,</span> <span class="n">BoxData2</span><span class="p">,</span> <span class="n">EventData2</span> <span class="o">=</span> <span class="n">get_plot_types_data</span><span class="p">(</span>
        <span class="p">(</span><span class="n">all_reg_data2</span><span class="p">,</span> <span class="n">plot_types</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="s1">&#39;Group2&#39;</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Plotting.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">resource_string</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;R_scripts/plotGroupComp.R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;pdf(&quot;&#39;</span> <span class="o">+</span> <span class="n">pdf_fn</span> <span class="o">+</span> <span class="s1">&#39;&quot;, height=5, width=11)&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotGroupComp&#39;</span><span class="p">)](</span>
        <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">rbind</span><span class="p">(</span><span class="n">SignalData1</span><span class="p">,</span> <span class="n">SignalData2</span><span class="p">),</span>
        <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">rbind</span><span class="p">(</span><span class="n">QuantData1</span><span class="p">,</span> <span class="n">QuantData2</span><span class="p">),</span>
        <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">rbind</span><span class="p">(</span><span class="n">BoxData1</span><span class="p">,</span> <span class="n">BoxData2</span><span class="p">),</span>
        <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">rbind</span><span class="p">(</span><span class="n">EventData1</span><span class="p">,</span> <span class="n">EventData2</span><span class="p">),</span>
        <span class="n">BasesData</span><span class="p">,</span> <span class="n">Titles</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;dev.off()&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">seqs_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Outputting region seqeuences.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">seqs_fn</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">seqs_fp</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">int_i</span> <span class="ow">in</span> <span class="n">merged_reg_data</span><span class="p">:</span>
                <span class="c1"># get the interval from the base data struct</span>
                <span class="n">reg_seq</span> <span class="o">=</span> <span class="n">int_i</span><span class="o">.</span><span class="n">seq</span> <span class="k">if</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="n">th</span><span class="o">.</span><span class="n">rev_comp</span><span class="p">(</span>
                    <span class="n">int_i</span><span class="o">.</span><span class="n">seq</span><span class="p">)</span>
                <span class="n">seqs_fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&gt;</span><span class="si">{0}</span><span class="s1">::</span><span class="si">{1:d}</span><span class="s1">::</span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3}</span><span class="se">\n</span><span class="si">{4}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">int_i</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">reg_text</span><span class="p">,</span>
                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reg_seq</span><span class="p">)))</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="get_reg_kmers"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_reg_kmers">[docs]</a><span class="k">def</span> <span class="nf">get_reg_kmers</span><span class="p">(</span><span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span>
                  <span class="n">min_reg_overlap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">filter_reads</span><span class="p">(</span><span class="n">reads</span><span class="p">,</span> <span class="n">int_start</span><span class="p">,</span> <span class="n">int_end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Filter reads obtained from expanded interval</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r_data</span> <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">reads</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">int_end</span> <span class="ow">or</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">int_start</span><span class="p">)]</span>
    <span class="n">std_ref</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">TomboModel</span><span class="p">(</span><span class="n">tb_model_fn</span><span class="p">)</span>
    <span class="c1"># compute kmer values to make strand specific calculations easier</span>
    <span class="n">dnstrm_bases</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">-</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">expand_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">)</span>
    <span class="n">filt_width</span> <span class="o">=</span> <span class="n">expand_width</span> <span class="k">if</span> <span class="n">min_reg_overlap</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                 <span class="n">expand_width</span> <span class="o">+</span> <span class="n">min_reg_overlap</span>
    <span class="k">if</span> <span class="n">alt_model_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">alt_ref</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">TomboModel</span><span class="p">(</span><span class="n">alt_model_fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">alt_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">!=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="ow">or</span>
            <span class="n">alt_ref</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">!=</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">):</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Standard model not based on the same kmer position &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;as alternative model.&#39;</span><span class="p">)</span>

    <span class="c1"># expand regions to get kmers at first and last positions</span>
    <span class="n">expanded_intervals</span> <span class="o">=</span> <span class="p">[</span><span class="n">p_int</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">p_int</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">expand_width</span><span class="p">,</span>
                                         <span class="n">end</span><span class="o">=</span><span class="n">p_int</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="n">expand_width</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">p_int</span> <span class="ow">in</span> <span class="n">plot_intervals</span><span class="p">]</span>
    <span class="c1"># get reads and region sequence</span>
    <span class="n">expanded_intervals</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_region_reads</span><span class="p">(</span>
        <span class="n">expanded_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">)</span>
    <span class="n">expand_seqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">int_i</span><span class="o">.</span><span class="n">seq</span> <span class="k">for</span> <span class="n">int_i</span> <span class="ow">in</span> <span class="n">expanded_intervals</span><span class="p">]</span>
    <span class="n">rev_expand_seqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">th</span><span class="o">.</span><span class="n">rev_comp</span><span class="p">(</span><span class="n">int_i</span><span class="o">.</span><span class="n">seq</span><span class="p">)</span> <span class="k">for</span> <span class="n">int_i</span> <span class="ow">in</span> <span class="n">expanded_intervals</span><span class="p">]</span>
    <span class="c1"># convert back to original plot_intervals with seq from exanded intervals</span>
    <span class="n">all_reg_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">int_i</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">int_i</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">expand_width</span><span class="p">,</span>
                       <span class="n">end</span><span class="o">=</span><span class="n">int_i</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">expand_width</span><span class="p">,</span>
                       <span class="n">reads</span><span class="o">=</span><span class="n">filter_reads</span><span class="p">(</span><span class="n">int_i</span><span class="o">.</span><span class="n">reads</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">filt_width</span><span class="p">,</span>
                                          <span class="n">int_i</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">filt_width</span><span class="p">),</span>
                       <span class="n">seq</span><span class="o">=</span><span class="n">int_i</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">expand_width</span><span class="p">:</span><span class="o">-</span><span class="n">expand_width</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">int_i</span> <span class="ow">in</span> <span class="n">expanded_intervals</span><span class="p">]</span>

    <span class="n">all_reg_model_data</span><span class="p">,</span> <span class="n">all_reg_alt_model_data</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">reg_data</span><span class="p">,</span> <span class="n">reg_seq</span><span class="p">,</span> <span class="n">rev_seq</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">all_reg_data</span><span class="p">,</span> <span class="n">expand_seqs</span><span class="p">,</span> <span class="n">rev_expand_seqs</span><span class="p">):</span>
        <span class="n">clipped_reg_seq</span> <span class="o">=</span> <span class="n">reg_seq</span>
        <span class="n">clipped_rev_seq</span> <span class="o">=</span> <span class="n">rev_seq</span>
        <span class="k">if</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">&gt;</span> <span class="n">dnstrm_bases</span><span class="p">:</span>
            <span class="n">clipped_reg_seq</span> <span class="o">=</span> <span class="n">reg_seq</span><span class="p">[:</span><span class="n">dnstrm_bases</span><span class="o">-</span><span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">]</span>
            <span class="n">clipped_rev_seq</span> <span class="o">=</span> <span class="n">rev_seq</span><span class="p">[:</span><span class="n">dnstrm_bases</span><span class="o">-</span><span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">dnstrm_bases</span> <span class="o">&gt;</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">:</span>
            <span class="n">clipped_reg_seq</span> <span class="o">=</span> <span class="n">reg_seq</span><span class="p">[</span><span class="n">dnstrm_bases</span><span class="o">-</span><span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">:]</span>
            <span class="n">clipped_rev_seq</span> <span class="o">=</span> <span class="n">rev_seq</span><span class="p">[</span><span class="n">dnstrm_bases</span><span class="o">-</span><span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">:]</span>
        <span class="n">fwd_kmers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">clipped_reg_seq</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clipped_reg_seq</span><span class="p">)</span> <span class="o">-</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">rev_kmers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">clipped_rev_seq</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clipped_rev_seq</span><span class="p">)</span> <span class="o">-</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">all_reg_model_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
            <span class="n">reg_data</span><span class="o">.</span><span class="n">reg_id</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">strand</span><span class="p">,</span>
            <span class="p">[(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">kmer</span><span class="p">],</span>
              <span class="n">std_ref</span><span class="o">.</span><span class="n">sds</span><span class="p">[</span><span class="n">kmer</span><span class="p">])</span>
             <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fwd_kmers</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">th</span><span class="o">.</span><span class="n">invalid_seq</span><span class="p">(</span><span class="n">kmer</span><span class="p">)],</span>
            <span class="p">[(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">kmer</span><span class="p">],</span>
              <span class="n">std_ref</span><span class="o">.</span><span class="n">sds</span><span class="p">[</span><span class="n">kmer</span><span class="p">])</span> <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rev_kmers</span><span class="p">)</span>
             <span class="k">if</span> <span class="ow">not</span> <span class="n">th</span><span class="o">.</span><span class="n">invalid_seq</span><span class="p">(</span><span class="n">kmer</span><span class="p">)]))</span>
        <span class="c1"># if alternative model is supplied add info</span>
        <span class="k">if</span> <span class="n">alt_model_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_reg_alt_model_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                <span class="n">reg_data</span><span class="o">.</span><span class="n">reg_id</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">strand</span><span class="p">,</span>
                <span class="p">[(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">kmer</span><span class="p">],</span>
                  <span class="n">alt_ref</span><span class="o">.</span><span class="n">sds</span><span class="p">[</span><span class="n">kmer</span><span class="p">])</span>
                 <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fwd_kmers</span><span class="p">)</span>
                 <span class="k">if</span> <span class="ow">not</span> <span class="n">th</span><span class="o">.</span><span class="n">invalid_seq</span><span class="p">(</span><span class="n">kmer</span><span class="p">)],</span>
                <span class="p">[(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">kmer</span><span class="p">],</span>
                  <span class="n">alt_ref</span><span class="o">.</span><span class="n">sds</span><span class="p">[</span><span class="n">kmer</span><span class="p">])</span>
                 <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rev_kmers</span><span class="p">)</span>
                 <span class="k">if</span> <span class="ow">not</span> <span class="n">th</span><span class="o">.</span><span class="n">invalid_seq</span><span class="p">(</span><span class="n">kmer</span><span class="p">)]))</span>
</div>
    <span class="k">return</span> <span class="n">all_reg_data</span><span class="p">,</span> <span class="n">all_reg_model_data</span><span class="p">,</span> <span class="n">all_reg_alt_model_data</span>

<div class="viewcode-block" id="plot_motif_centered_with_stats"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_motif_centered_with_stats">[docs]</a><span class="k">def</span> <span class="nf">plot_motif_centered_with_stats</span><span class="p">(</span>
        <span class="n">raw_read_coverage1</span><span class="p">,</span> <span class="n">raw_read_coverage2</span><span class="p">,</span> <span class="n">plot_intervals</span><span class="p">,</span>
        <span class="n">stat_locs</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span> <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Preparing plot data.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">ModelData</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;NULL&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">raw_read_coverage2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tb_model_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">merged_reg_data</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_region_reads</span><span class="p">(</span>
                <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage1</span><span class="p">,</span> <span class="n">filter_no_cov</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">plot_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Downsample&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">merged_reg_data</span><span class="p">]</span>
            <span class="n">SignalData</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_plot_types_data</span><span class="p">(</span>
                <span class="p">(</span><span class="n">merged_reg_data</span><span class="p">,</span> <span class="n">plot_types</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="s1">&#39;Group1&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">merged_reg_data</span><span class="p">,</span> <span class="n">all_reg_model_data</span><span class="p">,</span>
             <span class="n">all_reg_alt_model_data</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_reg_kmers</span><span class="p">(</span>
                 <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage1</span><span class="p">,</span>
                 <span class="n">alt_model_fn</span><span class="o">=</span><span class="n">alt_model_fn</span><span class="p">)</span>
            <span class="n">plot_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Downsample&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">merged_reg_data</span><span class="p">]</span>
            <span class="n">SignalData</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_plot_types_data</span><span class="p">(</span>
                <span class="p">(</span><span class="n">merged_reg_data</span><span class="p">,</span> <span class="n">plot_types</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="s1">&#39;Group1&#39;</span><span class="p">))</span>
            <span class="n">ModelData</span> <span class="o">=</span> <span class="n">get_model_r_data</span><span class="p">(</span><span class="n">all_reg_model_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alt_model_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">AltModelData</span> <span class="o">=</span> <span class="n">get_model_r_data</span><span class="p">(</span><span class="n">all_reg_alt_model_data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_reg_data1</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_region_reads</span><span class="p">(</span>
            <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage1</span><span class="p">,</span> <span class="n">filter_no_cov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">add_seq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">all_reg_data2</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_region_reads</span><span class="p">(</span>
            <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage2</span><span class="p">,</span> <span class="n">filter_no_cov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">add_seq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="p">(</span><span class="n">merged_reg_data</span><span class="p">,</span> <span class="n">all_reg_data1</span><span class="p">,</span>
         <span class="n">all_reg_data2</span><span class="p">)</span> <span class="o">=</span> <span class="n">filter_and_merge_group_regs</span><span class="p">(</span>
             <span class="n">all_reg_data1</span><span class="p">,</span> <span class="n">all_reg_data2</span><span class="p">)</span>
        <span class="n">plot_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Downsample&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">merged_reg_data</span><span class="p">]</span>
        <span class="n">merged_reg_data</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">add_reg_seq</span><span class="p">(</span><span class="n">merged_reg_data</span><span class="p">)</span>

        <span class="c1"># sigDat lists</span>
        <span class="n">SignalData1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_plot_types_data</span><span class="p">(</span>
            <span class="p">(</span><span class="n">all_reg_data1</span><span class="p">,</span> <span class="n">plot_types</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="s1">&#39;Group1&#39;</span><span class="p">))</span>
        <span class="n">SignalData2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_plot_types_data</span><span class="p">(</span>
            <span class="p">(</span><span class="n">all_reg_data2</span><span class="p">,</span> <span class="n">plot_types</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="s1">&#39;Group2&#39;</span><span class="p">))</span>
        <span class="n">SignalData</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">rbind</span><span class="p">(</span><span class="n">SignalData1</span><span class="p">,</span> <span class="n">SignalData2</span><span class="p">)</span>

    <span class="n">BasesData</span> <span class="o">=</span> <span class="n">get_base_r_data</span><span class="p">(</span><span class="n">merged_reg_data</span><span class="p">)</span>

    <span class="n">plot_poss</span><span class="p">,</span> <span class="n">plot_stats</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">stat_locs</span><span class="p">)</span>
    <span class="c1"># stat lists</span>
    <span class="n">StatsData</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Position&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">plot_poss</span><span class="p">),</span>
        <span class="s1">&#39;Stat&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">plot_stats</span><span class="p">)})</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Plotting.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">resource_string</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;R_scripts/plotMotifStats.R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;pdf(&quot;&#39;</span> <span class="o">+</span> <span class="n">pdf_fn</span> <span class="o">+</span> <span class="s1">&#39;&quot;, height=5, width=8)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alt_model_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotMotifStats&#39;</span><span class="p">)](</span>
            <span class="n">SignalData</span><span class="p">,</span> <span class="n">BasesData</span><span class="p">,</span> <span class="n">StatsData</span><span class="p">,</span> <span class="n">ModelData</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotMotifStats&#39;</span><span class="p">)](</span>
            <span class="n">SignalData</span><span class="p">,</span> <span class="n">BasesData</span><span class="p">,</span> <span class="n">StatsData</span><span class="p">,</span> <span class="n">ModelData</span><span class="p">,</span> <span class="n">AltModelData</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;dev.off()&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="plot_model_single_sample"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_model_single_sample">[docs]</a><span class="k">def</span> <span class="nf">plot_model_single_sample</span><span class="p">(</span>
        <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">tb_model_fn</span><span class="p">,</span>
        <span class="n">overplot_type</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seqs_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Preparing plot data.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># get reads overlapping each region along with all kmers</span>
    <span class="n">all_reg_data</span><span class="p">,</span> <span class="n">all_reg_model_data</span><span class="p">,</span> <span class="n">all_reg_alt_model_data</span> <span class="o">=</span> <span class="n">get_reg_kmers</span><span class="p">(</span>
        <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span>
        <span class="n">alt_model_fn</span><span class="o">=</span><span class="n">alt_model_fn</span><span class="p">)</span>
    <span class="n">rna</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">is_rna</span><span class="p">(</span><span class="n">raw_read_coverage</span><span class="p">)</span>

    <span class="n">Titles</span><span class="p">,</span> <span class="n">plot_types</span> <span class="o">=</span> <span class="n">get_plots_titles</span><span class="p">(</span>
        <span class="n">all_reg_data</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">overplot_type</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">ModelData</span> <span class="o">=</span> <span class="n">get_model_r_data</span><span class="p">(</span><span class="n">all_reg_model_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alt_model_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">AltModelData</span> <span class="o">=</span> <span class="n">get_model_r_data</span><span class="p">(</span><span class="n">all_reg_alt_model_data</span><span class="p">)</span>
    <span class="n">BasesData</span> <span class="o">=</span> <span class="n">get_base_r_data</span><span class="p">(</span><span class="n">all_reg_data</span><span class="p">,</span> <span class="n">is_rna</span><span class="o">=</span><span class="n">rna</span><span class="p">)</span>
    <span class="n">SignalData</span><span class="p">,</span> <span class="n">QuantData</span><span class="p">,</span> <span class="n">BoxData</span><span class="p">,</span> <span class="n">EventData</span> <span class="o">=</span> <span class="n">get_plot_types_data</span><span class="p">(</span>
        <span class="p">(</span><span class="n">all_reg_data</span><span class="p">,</span> <span class="n">plot_types</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="s1">&#39;Group1&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Plotting.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">resource_string</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;R_scripts/plotModelComp.R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;pdf(&quot;&#39;</span> <span class="o">+</span> <span class="n">pdf_fn</span> <span class="o">+</span> <span class="s1">&#39;&quot;, height=5, width=11)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alt_model_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotModelComp&#39;</span><span class="p">)](</span>
            <span class="n">SignalData</span><span class="p">,</span> <span class="n">QuantData</span><span class="p">,</span> <span class="n">BoxData</span><span class="p">,</span> <span class="n">EventData</span><span class="p">,</span>
            <span class="n">BasesData</span><span class="p">,</span> <span class="n">Titles</span><span class="p">,</span> <span class="n">ModelData</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotModelComp&#39;</span><span class="p">)](</span>
            <span class="n">SignalData</span><span class="p">,</span> <span class="n">QuantData</span><span class="p">,</span> <span class="n">BoxData</span><span class="p">,</span> <span class="n">EventData</span><span class="p">,</span>
            <span class="n">BasesData</span><span class="p">,</span> <span class="n">Titles</span><span class="p">,</span> <span class="n">ModelData</span><span class="p">,</span> <span class="n">AltModelData</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;dev.off()&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">seqs_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Outputting region seqeuences.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">seqs_fn</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">seqs_fp</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">int_i</span> <span class="ow">in</span> <span class="n">all_reg_data</span><span class="p">:</span>
                <span class="n">reg_seq</span> <span class="o">=</span> <span class="n">int_i</span><span class="o">.</span><span class="n">seq</span> <span class="k">if</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="n">th</span><span class="o">.</span><span class="n">rev_comp</span><span class="p">(</span>
                    <span class="n">int_i</span><span class="o">.</span><span class="n">seq</span><span class="p">)</span>
                <span class="n">seqs_fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&gt;</span><span class="si">{0}</span><span class="s1">::</span><span class="si">{1:d}</span><span class="s1">::</span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3}</span><span class="se">\n</span><span class="si">{4}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">int_i</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">reg_text</span><span class="p">,</span>
                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reg_seq</span><span class="p">)))</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="plot_per_read_modification"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_per_read_modification">[docs]</a><span class="k">def</span> <span class="nf">plot_per_read_modification</span><span class="p">(</span>
        <span class="n">all_reg_data</span><span class="p">,</span> <span class="n">all_reg_stats</span><span class="p">,</span> <span class="n">are_pvals</span><span class="p">,</span> <span class="n">box_center</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Preparing plot data.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">StatData</span><span class="p">,</span> <span class="n">OrdData</span> <span class="o">=</span> <span class="n">get_reg_r_stats</span><span class="p">(</span><span class="n">all_reg_stats</span><span class="p">,</span> <span class="n">are_pvals</span><span class="p">)</span>
    <span class="n">BasesData</span> <span class="o">=</span> <span class="n">get_base_r_data</span><span class="p">(</span><span class="n">all_reg_data</span><span class="p">,</span> <span class="n">zero_start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Plotting.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">resource_string</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;R_scripts/plotPerReadStats.R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;pdf(&quot;&#39;</span> <span class="o">+</span> <span class="n">pdf_fn</span> <span class="o">+</span> <span class="s1">&#39;&quot;, height=5, width=11)&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotPerReadStats&#39;</span><span class="p">)](</span>
        <span class="n">StatData</span><span class="p">,</span> <span class="n">OrdData</span><span class="p">,</span> <span class="n">BasesData</span><span class="p">,</span> <span class="n">box_center</span><span class="p">,</span> <span class="n">are_pvals</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;dev.off()&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span>


<span class="c1">#################################</span>
<span class="c1">#### Plot processing methods ####</span>
<span class="c1">#################################</span>

<div class="viewcode-block" id="get_valid_model_fns"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_valid_model_fns">[docs]</a><span class="k">def</span> <span class="nf">get_valid_model_fns</span><span class="p">(</span>
        <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">plot_default_stnd</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">,</span>
        <span class="n">plot_default_alt</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">f5_dirs2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># if no model was requested</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tb_model_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">plot_default_stnd</span> <span class="ow">and</span>
        <span class="n">alt_model_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">plot_default_alt</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">tb_model_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get_default_standard_ref</span><span class="p">(</span><span class="n">raw_read_coverage</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alt_model_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">plot_default_alt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">alt_model_fn</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get_default_alt_ref</span><span class="p">(</span>
            <span class="n">plot_default_alt</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">f5_dirs2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tb_model_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Both a second set of FAST5s and a tombo model were &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;provided. Two samples with model plotting is not &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;currently available. Models requested will be ignored.&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span>

<div class="viewcode-block" id="plot_max_coverage"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_max_coverage">[docs]</a><span class="k">def</span> <span class="nf">plot_max_coverage</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span>
        <span class="n">f5_dirs2</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">overplot_type</span><span class="p">,</span>
        <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">,</span> <span class="n">plot_default_stnd</span><span class="p">,</span> <span class="n">plot_default_alt</span><span class="p">):</span>
    <span class="n">raw_read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
    <span class="n">read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_coverage</span><span class="p">(</span><span class="n">raw_read_coverage</span><span class="p">)</span>

    <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span> <span class="o">=</span> <span class="n">get_valid_model_fns</span><span class="p">(</span>
        <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">plot_default_stnd</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">,</span> <span class="n">plot_default_alt</span><span class="p">,</span>
        <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">f5_dirs2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f5_dirs2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coverage_regions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">),</span> <span class="n">cs_coverage</span> <span class="ow">in</span> <span class="n">read_coverage</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">reg_covs</span><span class="p">,</span> <span class="n">reg_lens</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">cs_coverage</span><span class="p">)])</span>
            <span class="n">coverage_regions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                <span class="n">reg_covs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">reg_lens</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                <span class="n">repeat</span><span class="p">(</span><span class="n">chrm</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="n">strand</span><span class="p">)))</span>

        <span class="c1"># max coverage plots both strands coverage</span>
        <span class="n">plot_intervals</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rn</span><span class="p">),</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">num_bases</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rn</span><span class="p">,</span> <span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">in</span>
            <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">coverage_regions</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">num_regions</span><span class="p">])]</span>

        <span class="k">if</span> <span class="n">tb_model_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_single_sample</span><span class="p">(</span>
                <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span>
                <span class="n">overplot_type</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_model_single_sample</span><span class="p">(</span>
                <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">tb_model_fn</span><span class="p">,</span>
                <span class="n">overplot_type</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">raw_read_coverage2</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
            <span class="n">f5_dirs2</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
        <span class="n">read_coverage2</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_coverage</span><span class="p">(</span><span class="n">raw_read_coverage2</span><span class="p">)</span>
        <span class="n">coverage_regions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># only process chromosomes in both read groups</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">read_coverage</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
                <span class="n">read_coverage2</span><span class="p">):</span>
            <span class="n">chrm_coverage</span> <span class="o">=</span> <span class="n">read_coverage</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span>
            <span class="n">chrm_coverage2</span> <span class="o">=</span> <span class="n">read_coverage2</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">chrm_coverage</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">chrm_coverage2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">merged_chrm_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
                    <span class="n">chrm_coverage2</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">chrm_coverage</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span>
                                     <span class="n">chrm_coverage2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">chrm_coverage</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">merged_chrm_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
                    <span class="n">chrm_coverage</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">chrm_coverage2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span>
                                    <span class="n">chrm_coverage</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">chrm_coverage2</span>

            <span class="n">reg_covs</span><span class="p">,</span> <span class="n">reg_lens</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">merged_chrm_cov</span><span class="p">)])</span>
            <span class="n">coverage_regions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                <span class="n">reg_covs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">reg_lens</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                <span class="n">repeat</span><span class="p">(</span><span class="n">chrm</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="n">strand</span><span class="p">)))</span>

        <span class="c1"># max coverage plots both strands coverage</span>
        <span class="n">plot_intervals</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rn</span><span class="p">),</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">num_bases</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rn</span><span class="p">,</span> <span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">in</span>
            <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">coverage_regions</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">num_regions</span><span class="p">])]</span>

        <span class="n">plot_two_samples</span><span class="p">(</span>
            <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">raw_read_coverage2</span><span class="p">,</span>
            <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">overplot_type</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">)</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="plot_genome_locations"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_genome_locations">[docs]</a><span class="k">def</span> <span class="nf">plot_genome_locations</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span>
        <span class="n">f5_dirs2</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">overplot_type</span><span class="p">,</span>
        <span class="n">genome_locations</span><span class="p">,</span> <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">,</span> <span class="n">plot_default_stnd</span><span class="p">,</span>
        <span class="n">plot_default_alt</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Parsing genome locations.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># ignore strand for genome location plotting</span>
    <span class="n">genome_locations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">chrm_pos</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">chrm_pos</span> <span class="ow">in</span> <span class="n">genome_locations</span><span class="p">]</span>
    <span class="c1"># minus one here as all python internal coords are 0-based, but</span>
    <span class="c1"># genome is generally 1-based</span>
    <span class="n">plot_intervals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chrm_pos_strand</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">genome_locations</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chrm_pos_strand</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">chrm</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">chrm_pos_strand</span>
            <span class="n">strand</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chrm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strand</span> <span class="o">=</span> <span class="n">chrm_pos_strand</span>
        <span class="n">int_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">num_bases</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">plot_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">int_start</span><span class="p">,</span> <span class="n">int_start</span> <span class="o">+</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">strand</span><span class="p">))</span>

    <span class="n">raw_read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
    <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span> <span class="o">=</span> <span class="n">get_valid_model_fns</span><span class="p">(</span>
        <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">plot_default_stnd</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">,</span> <span class="n">plot_default_alt</span><span class="p">,</span>
        <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">f5_dirs2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">f5_dirs2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tb_model_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_single_sample</span><span class="p">(</span>
                <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span>
                <span class="n">overplot_type</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_model_single_sample</span><span class="p">(</span>
                <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">tb_model_fn</span><span class="p">,</span>
                <span class="n">overplot_type</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">raw_read_coverage2</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
            <span class="n">f5_dirs2</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
        <span class="n">plot_two_samples</span><span class="p">(</span>
            <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">raw_read_coverage2</span><span class="p">,</span>
            <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">overplot_type</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">)</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="plot_per_read_mods_genome_location"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_per_read_mods_genome_location">[docs]</a><span class="k">def</span> <span class="nf">plot_per_read_mods_genome_location</span><span class="p">(</span>
        <span class="n">f5_dirs</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span>
        <span class="n">per_read_stats_fn</span><span class="p">,</span> <span class="n">genome_locations</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">num_reads</span><span class="p">,</span> <span class="n">box_center</span><span class="p">,</span>
        <span class="n">fasta_fn</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Parsing genome locations.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">genome_locations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">chrm_pos</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">chrm_pos</span> <span class="ow">in</span> <span class="n">genome_locations</span><span class="p">]</span>
    <span class="n">plot_intervals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chrm_pos_strand</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">genome_locations</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chrm_pos_strand</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">chrm</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">chrm_pos_strand</span>
            <span class="n">strand</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chrm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strand</span> <span class="o">=</span> <span class="n">chrm_pos_strand</span>
        <span class="n">int_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">num_bases</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">plot_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">int_start</span><span class="p">,</span> <span class="n">int_start</span> <span class="o">+</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">strand</span><span class="p">))</span>

    <span class="c1"># add sequence to each region if fast5s or fasta are provided</span>
    <span class="k">if</span> <span class="n">fasta_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">genome_index</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">Fasta</span><span class="p">(</span><span class="n">fasta_fn</span><span class="p">)</span>
        <span class="n">plot_intervals_w_seq</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">int_data</span> <span class="ow">in</span> <span class="n">plot_intervals</span><span class="p">:</span>
            <span class="n">plot_intervals_w_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">int_data</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">seq</span><span class="o">=</span><span class="n">genome_index</span><span class="o">.</span><span class="n">get_seq</span><span class="p">(</span>
                    <span class="n">int_data</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">int_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">int_data</span><span class="o">.</span><span class="n">end</span><span class="p">)))</span>
        <span class="n">plot_intervals</span> <span class="o">=</span> <span class="n">plot_intervals_w_seq</span>
    <span class="k">elif</span> <span class="n">f5_dirs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">raw_read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
            <span class="n">f5_dirs</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
        <span class="n">plot_intervals</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_region_reads</span><span class="p">(</span><span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
            <span class="s1">&#39;No read FAST5 directory or genome FASTA file provided. &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;Plotting without sequence.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Parsing per read statistics.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">per_read_stats</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">PerReadStats</span><span class="p">(</span><span class="n">per_read_stats_fn</span><span class="p">)</span>
    <span class="n">interval_stats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">int_data</span> <span class="ow">in</span> <span class="n">plot_intervals</span><span class="p">:</span>
        <span class="n">int_stats</span> <span class="o">=</span> <span class="n">per_read_stats</span><span class="o">.</span><span class="n">get_region_stats</span><span class="p">(</span><span class="n">int_data</span><span class="p">,</span> <span class="n">num_reads</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">int_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># convert long form stats to matrix form (so they can be clustered)</span>
            <span class="n">int_stats</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;read_id&#39;</span><span class="p">))</span>
            <span class="c1"># use interval data instead of stats dimensions since regDat is</span>
            <span class="c1"># used to compute some window distances in R, so it must be full</span>
            <span class="c1"># matrix for the region with NAs</span>
            <span class="n">int_len</span> <span class="o">=</span> <span class="n">int_data</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">int_data</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">all_read_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                <span class="n">int_stats</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">int_stats</span><span class="p">[</span><span class="s1">&#39;read_id&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span>
                                    <span class="n">int_stats</span><span class="p">[</span><span class="s1">&#39;read_id&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">read_stats_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">all_read_stats</span><span class="p">),</span> <span class="n">int_len</span><span class="p">))</span>
            <span class="n">read_stats_mat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
            <span class="k">for</span> <span class="n">read_i</span><span class="p">,</span> <span class="n">read_int_stats</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_read_stats</span><span class="p">):</span>
                <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">read_stats_mat</span><span class="p">[</span><span class="n">read_i</span><span class="p">,:],</span>
                       <span class="n">read_int_stats</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">int_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                       <span class="n">read_int_stats</span><span class="p">[</span><span class="s1">&#39;stat&#39;</span><span class="p">])</span>
            <span class="n">interval_stats</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">int_data</span><span class="o">.</span><span class="n">reg_id</span><span class="p">,</span> <span class="n">read_stats_mat</span><span class="p">))</span>

    <span class="n">are_pvals</span> <span class="o">=</span> <span class="n">per_read_stats</span><span class="o">.</span><span class="n">are_pvals</span>
    <span class="n">per_read_stats</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">plot_per_read_modification</span><span class="p">(</span>
        <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">interval_stats</span><span class="p">,</span> <span class="n">are_pvals</span><span class="p">,</span> <span class="n">box_center</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">)</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="plot_motif_centered"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_motif_centered">[docs]</a><span class="k">def</span> <span class="nf">plot_motif_centered</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span>
        <span class="n">f5_dirs2</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">overplot_type</span><span class="p">,</span>
        <span class="n">motif</span><span class="p">,</span> <span class="n">fasta_fn</span><span class="p">,</span> <span class="n">deepest_coverage</span><span class="p">,</span> <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">,</span>
        <span class="n">plot_default_stnd</span><span class="p">,</span> <span class="n">plot_default_alt</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Identifying genomic k-mer locations.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">genome_index</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">Fasta</span><span class="p">(</span><span class="n">fasta_fn</span><span class="p">)</span>
    <span class="n">motif</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboMotif</span><span class="p">(</span><span class="n">motif</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_motif_locs</span><span class="p">(</span><span class="n">covered_chrms</span><span class="p">):</span>
        <span class="n">motif_locs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chrm</span> <span class="ow">in</span> <span class="n">genome_index</span><span class="o">.</span><span class="n">iter_chrms</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">chrm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">covered_chrms</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">genome_index</span><span class="o">.</span><span class="n">get_seq</span><span class="p">(</span><span class="n">chrm</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">motif_loc</span> <span class="ow">in</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_pat</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
                <span class="n">motif_locs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">chrm</span><span class="p">,</span> <span class="n">motif_loc</span><span class="o">.</span><span class="n">start</span><span class="p">(),</span> <span class="s1">&#39;+&#39;</span>
                                   <span class="k">if</span> <span class="ow">not</span> <span class="n">motif</span><span class="o">.</span><span class="n">is_palindrome</span> <span class="k">else</span> <span class="kc">None</span><span class="p">))</span>
            <span class="c1"># search over negative strand as well if not palindromic</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">motif</span><span class="o">.</span><span class="n">is_palindrome</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">motif_loc</span> <span class="ow">in</span> <span class="n">motif</span><span class="o">.</span><span class="n">rev_comp_pat</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
                    <span class="n">motif_locs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">chrm</span><span class="p">,</span> <span class="n">motif_loc</span><span class="o">.</span><span class="n">start</span><span class="p">(),</span> <span class="s1">&#39;-&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">motif_locs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Motif (&#39;</span> <span class="o">+</span> <span class="n">motif</span><span class="o">.</span><span class="n">raw_motif</span> <span class="o">+</span> <span class="s1">&#39;) not found in genome.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">motif_locs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_regions</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
                <span class="s1">&#39;Motif (&#39;</span> <span class="o">+</span> <span class="n">motif</span><span class="o">.</span><span class="n">raw_motif</span> <span class="o">+</span> <span class="s1">&#39;) only found &#39;</span> <span class="o">+</span>
                <span class="n">unicode</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">motif_locs</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; times in genome.&#39;</span><span class="p">)</span>
            <span class="n">num_region</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">motif_locs</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">motif_locs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">motif_locs</span>

    <span class="k">def</span> <span class="nf">get_pos_cov</span><span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">read_coverage</span><span class="p">,</span> <span class="n">read_coverage2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">get_strand_cov</span><span class="p">(</span><span class="n">cov_strand</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">read_coverage2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">read_coverage</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">cov_strand</span><span class="p">)][</span><span class="n">pos</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">read_coverage</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">cov_strand</span><span class="p">)][</span><span class="n">pos</span><span class="p">],</span>
                               <span class="n">read_coverage2</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">cov_strand</span><span class="p">)][</span><span class="n">pos</span><span class="p">])</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># if strand is not specified get max coverage over both strands</span>
        <span class="k">if</span> <span class="n">strand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">get_strand_cov</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="n">get_strand_cov</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span>
        <span class="c1"># else get coverage for strand with motif</span>
        <span class="k">return</span> <span class="n">get_strand_cov</span><span class="p">(</span><span class="n">strand</span><span class="p">)</span>


    <span class="n">raw_read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
    <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span> <span class="o">=</span> <span class="n">get_valid_model_fns</span><span class="p">(</span>
        <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">plot_default_stnd</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">,</span> <span class="n">plot_default_alt</span><span class="p">,</span>
        <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">f5_dirs2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">deepest_coverage</span><span class="p">:</span>
        <span class="n">read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_coverage</span><span class="p">(</span><span class="n">raw_read_coverage</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f5_dirs2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">covered_chrms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">raw_read_coverage</span><span class="p">))</span>
        <span class="c1"># filter out motif_locs to chromosomes not covered</span>
        <span class="n">motif_locs</span> <span class="o">=</span> <span class="n">get_motif_locs</span><span class="p">(</span><span class="n">covered_chrms</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">deepest_coverage</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Finding deepest coverage regions.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">motif_locs_cov</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
                <span class="p">(</span><span class="n">get_pos_cov</span><span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">read_coverage</span><span class="p">),</span>
                 <span class="n">chrm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">motif_locs</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plot_intervals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">motif_locs_cov</span><span class="p">):</span>
                <span class="n">int_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">pos</span> <span class="o">-</span> <span class="nb">int</span><span class="p">((</span><span class="n">num_bases</span> <span class="o">-</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
                <span class="n">int_end</span> <span class="o">=</span> <span class="n">int_start</span> <span class="o">+</span> <span class="n">num_bases</span>
                <span class="n">plot_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">int_start</span><span class="p">,</span> <span class="n">int_end</span><span class="p">,</span> <span class="n">strand</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_intervals</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">num_regions</span><span class="p">:</span> <span class="k">break</span>
        <span class="c1"># plot random covered regions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># iterate over regions and check if they have any coverage</span>
            <span class="n">plot_intervals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">motif_locs</span><span class="p">):</span>
                <span class="n">int_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">pos</span> <span class="o">-</span> <span class="nb">int</span><span class="p">((</span><span class="n">num_bases</span> <span class="o">-</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
                <span class="n">int_end</span> <span class="o">=</span> <span class="n">int_start</span> <span class="o">+</span> <span class="n">num_bases</span>
                <span class="k">if</span> <span class="n">strand</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="p">((</span><span class="n">chrm</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span> <span class="ow">and</span>
                         <span class="nb">any</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span>
                             <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">s</span><span class="p">)]))</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)):</span>
                    <span class="n">plot_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">int_start</span><span class="p">,</span> <span class="n">int_end</span><span class="p">,</span> <span class="n">strand</span><span class="p">))</span>
                <span class="k">elif</span> <span class="p">((</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span> <span class="ow">and</span>
                      <span class="nb">any</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span>
                          <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)])):</span>
                    <span class="n">plot_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">int_start</span><span class="p">,</span> <span class="n">int_end</span><span class="p">,</span> <span class="n">strand</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_intervals</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">num_regions</span><span class="p">:</span> <span class="k">break</span>

        <span class="k">if</span> <span class="n">tb_model_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_single_sample</span><span class="p">(</span>
                <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span>
                <span class="n">overplot_type</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_model_single_sample</span><span class="p">(</span>
                <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">tb_model_fn</span><span class="p">,</span>
                <span class="n">overplot_type</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">)</span>
    <span class="c1"># two sample plot</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">raw_read_coverage2</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
            <span class="n">f5_dirs2</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>

        <span class="n">covered_chrms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">raw_read_coverage</span><span class="p">))</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">raw_read_coverage2</span><span class="p">))</span>
        <span class="c1"># filter out motif_locs to chromosomes not covered</span>
        <span class="n">motif_locs</span> <span class="o">=</span> <span class="n">get_motif_locs</span><span class="p">(</span><span class="n">covered_chrms</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">deepest_coverage</span><span class="p">:</span>
            <span class="n">read_coverage2</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_coverage</span><span class="p">(</span><span class="n">raw_read_coverage2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Finding deepest coverage regions.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">motif_locs_cov</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
                <span class="p">(</span><span class="n">get_pos_cov</span><span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">read_coverage</span><span class="p">,</span> <span class="n">read_coverage2</span><span class="p">),</span>
                 <span class="n">chrm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">motif_locs</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">motif_locs_cov</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
                    <span class="s1">&#39;Motif not covered by both groups at any positions.&#39;</span><span class="p">)</span>

            <span class="n">plot_intervals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">motif_locs_cov</span><span class="p">):</span>
                <span class="n">int_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">pos</span> <span class="o">-</span> <span class="nb">int</span><span class="p">((</span><span class="n">num_bases</span> <span class="o">-</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
                <span class="n">plot_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">int_start</span><span class="p">,</span>
                    <span class="n">int_start</span> <span class="o">+</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">strand</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_intervals</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">num_regions</span><span class="p">:</span> <span class="k">break</span>
        <span class="c1"># plot random covered regions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># iterate over regions and check if they have any coverage</span>
            <span class="n">plot_intervals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">motif_locs</span><span class="p">):</span>
                <span class="n">int_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">pos</span> <span class="o">-</span> <span class="nb">int</span><span class="p">((</span><span class="n">num_bases</span> <span class="o">-</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
                <span class="n">int_end</span> <span class="o">=</span> <span class="n">int_start</span> <span class="o">+</span> <span class="n">num_bases</span>
                <span class="k">if</span> <span class="n">strand</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">((</span>
                        <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span> <span class="ow">and</span>
                        <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">raw_read_coverage2</span> <span class="ow">and</span>
                        <span class="nb">any</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span>
                            <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">s</span><span class="p">)])</span> <span class="ow">and</span>
                        <span class="nb">any</span><span class="p">(</span><span class="n">r_data2</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">r_data2</span><span class="o">.</span><span class="n">end</span>
                            <span class="k">for</span> <span class="n">r_data2</span> <span class="ow">in</span> <span class="n">raw_read_coverage2</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">s</span><span class="p">)]))</span>
                                          <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)):</span>
                    <span class="n">plot_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">int_start</span><span class="p">,</span> <span class="n">int_end</span><span class="p">,</span> <span class="n">strand</span><span class="p">))</span>
                <span class="k">elif</span> <span class="p">((</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span> <span class="ow">and</span>
                      <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">in</span> <span class="n">raw_read_coverage2</span> <span class="ow">and</span>
                      <span class="nb">any</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span>
                          <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">raw_read_coverage</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)])</span> <span class="ow">and</span>
                      <span class="nb">any</span><span class="p">(</span><span class="n">r_data2</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">r_data2</span><span class="o">.</span><span class="n">end</span>
                          <span class="k">for</span> <span class="n">r_data2</span> <span class="ow">in</span> <span class="n">raw_read_coverage2</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)])):</span>
                    <span class="n">plot_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">int_start</span><span class="p">,</span> <span class="n">int_end</span><span class="p">,</span> <span class="n">strand</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_intervals</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">num_regions</span><span class="p">:</span> <span class="k">break</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_intervals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
                    <span class="s1">&#39;Motif not covered by both groups at any positions.&#39;</span><span class="p">)</span>

        <span class="n">plot_two_samples</span><span class="p">(</span>
            <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">raw_read_coverage2</span><span class="p">,</span>
            <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">overplot_type</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">)</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="plot_max_diff"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_max_diff">[docs]</a><span class="k">def</span> <span class="nf">plot_max_diff</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span>
        <span class="n">f5_dirs2</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">overplot_type</span><span class="p">,</span>
        <span class="n">seqs_fn</span><span class="p">):</span>
    <span class="n">raw_read_coverage1</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
    <span class="n">raw_read_coverage2</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">f5_dirs2</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>

    <span class="n">chrm_sizes</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_chrm_sizes</span><span class="p">(</span><span class="n">raw_read_coverage1</span><span class="p">,</span> <span class="n">raw_read_coverage2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Getting base signal.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">base_means1</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_all_mean_levels</span><span class="p">(</span><span class="n">raw_read_coverage1</span><span class="p">,</span> <span class="n">chrm_sizes</span><span class="p">)</span>
    <span class="n">base_means2</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_all_mean_levels</span><span class="p">(</span><span class="n">raw_read_coverage2</span><span class="p">,</span> <span class="n">chrm_sizes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s1">&#39;Get differences between base signal.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># get num_region max diff regions from each chrm then find</span>
    <span class="c1"># global largest after</span>
    <span class="n">largest_diff_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">chrm_size</span> <span class="ow">in</span> <span class="n">chrm_sizes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
            <span class="c1"># calculate difference and set no coverage (nan) values</span>
            <span class="c1"># to zero</span>
            <span class="n">chrm_diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">base_means1</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span> <span class="o">-</span>
                       <span class="n">base_means2</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]))</span>
            <span class="n">chrm_max_diff_regs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span>
                <span class="n">chrm_diffs</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="n">num_regions</span><span class="p">]</span>
            <span class="n">largest_diff_indices</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span>
                <span class="n">chrm_diffs</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="nb">max</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_bases</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">chrm_max_diff_regs</span><span class="p">)</span>

    <span class="n">plot_intervals</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rn</span><span class="p">),</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span>
            <span class="s1">&#39;(Mean diff: </span><span class="si">{:.2f}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stat</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">rn</span><span class="p">,</span> <span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">in</span>
        <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">largest_diff_indices</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">num_regions</span><span class="p">])]</span>

    <span class="n">plot_two_samples</span><span class="p">(</span>
        <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage1</span><span class="p">,</span> <span class="n">raw_read_coverage2</span><span class="p">,</span>
        <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">overplot_type</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span> <span class="n">seqs_fn</span><span class="p">)</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="plot_most_signif"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_most_signif">[docs]</a><span class="k">def</span> <span class="nf">plot_most_signif</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span>
        <span class="n">f5_dirs2</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">seqs_fn</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">,</span>
        <span class="n">overplot_type</span><span class="p">,</span> <span class="n">stats_fn</span><span class="p">,</span> <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">,</span>
        <span class="n">plot_default_stnd</span><span class="p">,</span> <span class="n">plot_default_alt</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Loading statistics from file.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">all_stats</span><span class="p">,</span> <span class="n">stat_type</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">parse_stats</span><span class="p">(</span><span class="n">stats_fn</span><span class="p">)</span>

    <span class="n">raw_read_coverage</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
    <span class="n">plot_intervals</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get_most_signif_regions</span><span class="p">(</span>
        <span class="n">all_stats</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">)</span>
    <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span> <span class="o">=</span> <span class="n">get_valid_model_fns</span><span class="p">(</span>
        <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">plot_default_stnd</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">,</span> <span class="n">plot_default_alt</span><span class="p">,</span>
        <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">f5_dirs2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">f5_dirs2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tb_model_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_single_sample</span><span class="p">(</span>
                <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span>
                <span class="n">overplot_type</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_model_single_sample</span><span class="p">(</span>
                <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">tb_model_fn</span><span class="p">,</span>
                <span class="n">overplot_type</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">raw_read_coverage2</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
            <span class="n">f5_dirs2</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
        <span class="n">plot_two_samples</span><span class="p">(</span>
            <span class="n">plot_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage</span><span class="p">,</span> <span class="n">raw_read_coverage2</span><span class="p">,</span>
            <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">overplot_type</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span> <span class="n">seqs_fn</span><span class="p">)</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="get_unique_intervals"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.get_unique_intervals">[docs]</a><span class="k">def</span> <span class="nf">get_unique_intervals</span><span class="p">(</span><span class="n">plot_intervals</span><span class="p">,</span> <span class="n">covered_poss</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_regions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># unique genomic regions filter</span>
    <span class="n">uniq_p_intervals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">used_intervals</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">int_i</span> <span class="ow">in</span> <span class="n">plot_intervals</span><span class="p">:</span>
        <span class="c1"># could have significant region immediately next to</span>
        <span class="c1"># beginning/end of reads</span>
        <span class="n">interval_poss</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">int_i</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">end</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">int_i</span><span class="o">.</span><span class="n">start</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_intervals</span><span class="p">[(</span><span class="n">int_i</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span><span class="p">)]</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">covered_poss</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="n">pos</span> <span class="ow">in</span> <span class="n">covered_poss</span><span class="p">[(</span><span class="n">int_i</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">interval_poss</span><span class="p">)):</span>
            <span class="n">uniq_p_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">int_i</span><span class="p">)</span>
            <span class="n">used_intervals</span><span class="p">[(</span><span class="n">int_i</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">interval_poss</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_regions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniq_p_intervals</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">num_regions</span><span class="p">:</span>
            <span class="k">break</span>
</div>
    <span class="k">return</span> <span class="n">uniq_p_intervals</span>

<div class="viewcode-block" id="plot_motif_centered_signif"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_motif_centered_signif">[docs]</a><span class="k">def</span> <span class="nf">plot_motif_centered_signif</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span>
        <span class="n">f5_dirs2</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">motif</span><span class="p">,</span> <span class="n">stats_fn</span><span class="p">,</span>
        <span class="n">context_width</span><span class="p">,</span> <span class="n">num_stats</span><span class="p">,</span> <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">,</span>
        <span class="n">plot_default_stnd</span><span class="p">,</span> <span class="n">plot_default_alt</span><span class="p">,</span> <span class="n">fasta_fn</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">importr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;gridExtra&#39;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Must have R packge `gridExtra` installed in order to &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;create motif centered plots.&#39;</span><span class="p">)</span>

    <span class="n">motif</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboMotif</span><span class="p">(</span><span class="n">motif</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fasta_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">genome_index</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">Fasta</span><span class="p">(</span><span class="n">fasta_fn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Loading statistics from file.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">all_stats</span><span class="p">,</span> <span class="n">stat_type</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">parse_stats</span><span class="p">(</span><span class="n">stats_fn</span><span class="p">)</span>
    <span class="n">all_stats</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;frac&#39;</span><span class="p">))</span>

    <span class="n">raw_read_coverage1</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
    <span class="n">raw_read_coverage2</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">f5_dirs2</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span> \
        <span class="k">if</span> <span class="n">f5_dirs2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span> <span class="o">=</span> <span class="n">get_valid_model_fns</span><span class="p">(</span>
        <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">plot_default_stnd</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">,</span> <span class="n">plot_default_alt</span><span class="p">,</span>
        <span class="n">raw_read_coverage1</span><span class="p">,</span> <span class="n">f5_dirs2</span><span class="p">)</span>

    <span class="n">all_stats_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">((</span><span class="n">stat</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;chrm&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">stat</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;strand&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
          <span class="n">stat</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">)]),</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">stat</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;frac&#39;</span><span class="p">)])</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">all_stats</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Finding signficant regions with motif.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">motif_regions_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">search_width</span> <span class="o">=</span> <span class="p">((</span><span class="n">context_width</span> <span class="o">+</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">all_stats</span><span class="p">:</span>
        <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;chrm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">-</span> <span class="n">context_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">+</span> <span class="n">context_width</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fasta_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reg_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_region_sequences</span><span class="p">(</span>
                <span class="p">[</span><span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">strand</span><span class="p">)],</span>
                <span class="n">raw_read_coverage1</span><span class="p">,</span> <span class="n">raw_read_coverage2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">seq</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reg_seq</span> <span class="o">=</span> <span class="n">genome_index</span><span class="o">.</span><span class="n">get_seq</span><span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
            <span class="n">reg_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">rev_comp</span><span class="p">(</span><span class="n">reg_seq</span><span class="p">)</span>

        <span class="n">reg_match</span> <span class="o">=</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_pat</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">reg_seq</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reg_match</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">reg_match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">search_width</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span>
            <span class="n">reg_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">-</span>
                         <span class="p">(</span><span class="n">context_width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">reg_start</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">motif_regions_data</span><span class="p">:</span>
                <span class="n">motif_regions_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">reg_start</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">motif_regions_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">num_stats</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">motif_regions_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;No covered and tested sites contain motif of interest.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">motif_regions_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_stats</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Fewer covered and tested motif sites found than requested.&#39;</span><span class="p">)</span>

    <span class="n">plot_width</span> <span class="o">=</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">+</span> <span class="p">(</span><span class="n">context_width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_stat_pos</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">):</span>
        <span class="c1"># need to handle forward and reverse strand stats separately since</span>
        <span class="c1"># reverse strand stats are in reverse order wrt motif</span>
        <span class="c1"># note try-except for key in stats dict as significant position</span>
        <span class="c1"># may lie next to region with coverage below the threshold</span>
        <span class="n">reg_pos_stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">plot_width</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="n">all_stats_dict</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">pos</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">plot_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">start</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">start</span> <span class="o">-</span> <span class="n">plot_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">reg_pos_stats</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">plot_pos</span><span class="p">,</span> <span class="n">stat</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">reg_pos_stats</span>

    <span class="n">stat_locs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">loc_stat</span> <span class="k">for</span> <span class="n">motif_loc</span> <span class="ow">in</span> <span class="n">motif_regions_data</span>
        <span class="k">for</span> <span class="n">loc_stat</span> <span class="ow">in</span> <span class="n">get_stat_pos</span><span class="p">(</span><span class="o">*</span><span class="n">motif_loc</span><span class="p">)]</span>

    <span class="c1"># TODO: Fix so that negative strand reads are plotted too.</span>
    <span class="c1"># requires adding &quot;don&#39;t reverse signal&quot; option in getting plot data</span>
    <span class="n">plot_intervals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">reg_start</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">motif_regions_data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">plot_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">plot_width</span><span class="p">,</span> <span class="n">strand</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_intervals</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">num_regions</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">plot_motif_centered_with_stats</span><span class="p">(</span>
        <span class="n">raw_read_coverage1</span><span class="p">,</span> <span class="n">raw_read_coverage2</span><span class="p">,</span> <span class="n">plot_intervals</span><span class="p">,</span>
        <span class="n">stat_locs</span><span class="p">,</span> <span class="n">overplot_thresh</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span> <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">)</span>
</div>
    <span class="k">return</span>

<div class="viewcode-block" id="cluster_most_signif"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.cluster_most_signif">[docs]</a><span class="k">def</span> <span class="nf">cluster_most_signif</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">,</span> <span class="n">pdf_fn</span><span class="p">,</span>
        <span class="n">f5_dirs2</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">,</span>
        <span class="n">r_struct_fn</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">,</span> <span class="n">fasta_fn</span><span class="p">,</span> <span class="n">stats_fn</span><span class="p">,</span> <span class="n">slide_span</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Loading statistics from file.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">all_stats</span><span class="p">,</span> <span class="n">stat_type</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">parse_stats</span><span class="p">(</span><span class="n">stats_fn</span><span class="p">)</span>

    <span class="n">raw_read_coverage1</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">f5_dirs1</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>
    <span class="n">raw_read_coverage2</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_fast5s</span><span class="p">(</span>
        <span class="n">f5_dirs2</span><span class="p">,</span> <span class="n">corrected_group</span><span class="p">,</span> <span class="n">basecall_subgroups</span><span class="p">)</span>

    <span class="c1"># calculate positions covered by at least one read in both sets</span>
    <span class="n">read_coverage1</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_coverage</span><span class="p">(</span><span class="n">raw_read_coverage1</span><span class="p">)</span>
    <span class="n">read_coverage2</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_coverage</span><span class="p">(</span><span class="n">raw_read_coverage2</span><span class="p">)</span>
    <span class="n">covered_poss</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="n">chrm_strand</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">read_coverage1</span><span class="p">[</span><span class="n">chrm_strand</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">read_coverage2</span><span class="p">[</span><span class="n">chrm_strand</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">chrm_strand</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">read_coverage1</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
                <span class="n">read_coverage2</span><span class="p">))</span>

    <span class="n">plot_intervals</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get_most_signif_regions</span><span class="p">(</span>
        <span class="n">all_stats</span><span class="p">,</span> <span class="n">num_bases</span> <span class="o">+</span> <span class="p">(</span><span class="n">slide_span</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">num_regions</span><span class="p">)</span>

    <span class="c1"># unique genomic regions filter</span>
    <span class="n">plot_intervals</span> <span class="o">=</span> <span class="n">get_unique_intervals</span><span class="p">(</span><span class="n">plot_intervals</span><span class="p">,</span> <span class="n">covered_poss</span><span class="p">)</span>

    <span class="c1"># get region data if outputting R data structure</span>
    <span class="k">if</span> <span class="n">r_struct_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Getting sequences.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># expand regions for getting sequence by N in case motif is</span>
        <span class="c1"># the exact range found</span>
        <span class="n">expand_pos</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">seq_intervals</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">int_i</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                <span class="n">start</span><span class="o">=</span><span class="n">int_i</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">expand_pos</span><span class="p">,</span>
                <span class="n">end</span><span class="o">=</span><span class="n">int_i</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">expand_pos</span> <span class="o">+</span> <span class="n">num_bases</span> <span class="o">+</span> <span class="p">(</span><span class="n">slide_span</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">int_i</span> <span class="ow">in</span> <span class="n">plot_intervals</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fasta_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># add region sequences to column names for saved dist matrix</span>
            <span class="n">reg_seqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">reg_data</span><span class="o">.</span><span class="n">seq</span> <span class="k">for</span> <span class="n">reg_data</span> <span class="ow">in</span> <span class="n">th</span><span class="o">.</span><span class="n">get_region_sequences</span><span class="p">(</span>
                <span class="n">seq_intervals</span><span class="p">,</span> <span class="n">raw_read_coverage1</span><span class="p">,</span> <span class="n">raw_read_coverage2</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">genome_index</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">Fasta</span><span class="p">(</span><span class="n">fasta_fn</span><span class="p">)</span>
            <span class="n">reg_seqs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">genome_index</span><span class="o">.</span><span class="n">get_seq</span><span class="p">(</span><span class="n">int_i</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">int_i</span> <span class="ow">in</span> <span class="n">seq_intervals</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Getting base signal.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">chrm_sizes</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_chrm_sizes</span><span class="p">(</span><span class="n">raw_read_coverage1</span><span class="p">,</span> <span class="n">raw_read_coverage2</span><span class="p">)</span>

    <span class="n">base_means1</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_all_mean_levels</span><span class="p">(</span><span class="n">raw_read_coverage1</span><span class="p">,</span> <span class="n">chrm_sizes</span><span class="p">)</span>
    <span class="n">base_means2</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_all_mean_levels</span><span class="p">(</span><span class="n">raw_read_coverage2</span><span class="p">,</span> <span class="n">chrm_sizes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Getting region signal difference.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">slide_span_val</span> <span class="o">=</span> <span class="n">slide_span</span> <span class="k">if</span> <span class="n">slide_span</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">reg_sig_diffs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span>
            <span class="n">base_means1</span><span class="p">[(</span><span class="n">int_i</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span><span class="p">)][</span>
                <span class="n">int_i</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">int_i</span><span class="o">.</span><span class="n">start</span><span class="o">+</span><span class="n">num_bases</span><span class="o">+</span><span class="p">(</span><span class="n">slide_span_val</span><span class="o">*</span><span class="mi">2</span><span class="p">)]</span> <span class="o">-</span>
            <span class="n">base_means2</span><span class="p">[(</span><span class="n">int_i</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span><span class="p">)][</span>
                <span class="n">int_i</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">int_i</span><span class="o">.</span><span class="n">start</span><span class="o">+</span><span class="n">num_bases</span><span class="o">+</span><span class="p">(</span><span class="n">slide_span_val</span><span class="o">*</span><span class="mi">2</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">int_i</span> <span class="ow">in</span> <span class="n">plot_intervals</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Getting distance between signals.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
    <span class="n">index_q</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">dists_q</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reg_sig_diffs</span><span class="p">)):</span>
        <span class="n">index_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg_sig_diffs</span><span class="p">,</span> <span class="n">index_q</span><span class="p">,</span> <span class="n">dists_q</span><span class="p">,</span> <span class="n">slide_span</span><span class="p">)</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_processes</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">ts</span><span class="o">.</span><span class="n">get_pairwise_dists</span><span class="p">,</span>
                       <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="n">reg_sig_diff_dists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">row_dists</span> <span class="o">=</span> <span class="n">dists_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">reg_sig_diff_dists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_dists</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">continue</span>
    <span class="c1"># empty any entries left in queue after processes have finished</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">dists_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">row_dists</span> <span class="o">=</span> <span class="n">dists_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">reg_sig_diff_dists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_dists</span><span class="p">)</span>

    <span class="n">reg_sig_diff_dists</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">reg_sig_diff_dists</span><span class="p">)))</span>

    <span class="n">reg_sig_diff_dists</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span>
        <span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">reg_sig_diff_dists</span><span class="p">)),</span>
        <span class="n">ncol</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">reg_sig_diffs</span><span class="p">),</span> <span class="n">byrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">r_struct_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">reg_sig_diff_dists</span><span class="o">.</span><span class="n">colnames</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;::&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">seq</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">int_i</span><span class="o">.</span><span class="n">strand</span><span class="p">,</span> <span class="n">unicode</span><span class="p">(</span><span class="n">int_i</span><span class="o">.</span><span class="n">start</span><span class="p">)))</span>
             <span class="k">for</span> <span class="n">seq</span><span class="p">,</span> <span class="n">int_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">reg_seqs</span><span class="p">,</span> <span class="n">plot_intervals</span><span class="p">)])</span>
        <span class="n">r_struct_fn</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span><span class="n">r_struct_fn</span><span class="p">,])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r_struct_fn</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">NA_Character</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Plotting (and saving data).</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">resource_string</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;R_scripts/plotSigMDS.R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;pdf(&quot;&#39;</span> <span class="o">+</span> <span class="n">pdf_fn</span> <span class="o">+</span> <span class="s1">&#39;&quot;, height=7, width=7)&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotSigMDS&#39;</span><span class="p">)](</span><span class="n">reg_sig_diff_dists</span><span class="p">,</span> <span class="n">r_struct_fn</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;dev.off()&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span>




<span class="c1">################################</span>
<span class="c1">#### Main plotting function ####</span>
<span class="c1">################################</span>

<div class="viewcode-block" id="plot_main"><a class="viewcode-back" href="../../tombo.html#tombo.plot_commands.plot_main">[docs]</a><span class="k">def</span> <span class="nf">plot_main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">VERBOSE</span>
    <span class="n">VERBOSE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span>
    <span class="n">th</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">VERBOSE</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">VERBOSE</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ggplot</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;ggplot2&#39;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">_error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Must have rpy2, R and R package ggplot2 installed in &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;order to plot. If these packages are installed, &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;run:</span><span class="se">\n\t\t</span><span class="s1">`python -c &quot;import rpy2.robjects; from &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;rpy2.robjects.packages import importr; &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;importr(str(</span><span class="se">\&#39;</span><span class="s1">ggplot2</span><span class="se">\&#39;</span><span class="s1">));&quot;`</span><span class="se">\n\t</span><span class="s1"> to see installation issues.&#39;</span><span class="p">)</span>

    <span class="c1"># roc plotting doesn&#39;t use read dirs</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">base_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">fast5_basedirs</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">corrected_group</span><span class="p">,</span>
                     <span class="n">args</span><span class="o">.</span><span class="n">basecall_subgroups</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">pdf_filename</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">genome_opts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;overplot_thresh&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">overplot_threshold</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;overplot_type&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">overplot_type</span><span class="p">)]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">nbase_opt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;num_bases&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_bases</span>
                  <span class="k">if</span> <span class="s1">&#39;num_bases&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),]</span>
    <span class="n">nreg_opt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;num_regions&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_regions</span>
                 <span class="k">if</span> <span class="s1">&#39;num_regions&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),]</span>
    <span class="n">nobs_opt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;num_obs&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_obs</span>
                 <span class="k">if</span> <span class="s1">&#39;num_obs&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),]</span>
    <span class="n">nread_opt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;num_reads&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_reads</span>
                  <span class="k">if</span> <span class="s1">&#39;num_reads&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),]</span>
    <span class="n">glocs_opt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;genome_locations&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">genome_locations</span>
                  <span class="k">if</span> <span class="s1">&#39;genome_locations&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),]</span>
    <span class="n">f5dirs2_opt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;f5_dirs2&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">control_fast5_basedirs</span>
                    <span class="k">if</span> <span class="s1">&#39;control_fast5_basedirs&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),]</span>
    <span class="n">rdata_opt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;r_struct_fn&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">r_data_filename</span>
                  <span class="k">if</span> <span class="s1">&#39;r_data_filename&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),]</span>
    <span class="n">tbmod_opt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;tb_model_fn&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">tombo_model_filename</span> \
                  <span class="k">if</span> <span class="s1">&#39;tombo_model_filename&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),]</span>
    <span class="n">dtbmod_opt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;plot_default_stnd&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">plot_standard_model</span> \
                  <span class="k">if</span> <span class="s1">&#39;plot_standard_model&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),]</span>
    <span class="n">atbmod_opt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;alt_model_fn&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">alternate_model_filename</span> \
                  <span class="k">if</span> <span class="s1">&#39;alternate_model_filename&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),]</span>
    <span class="n">datbmod_opt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;plot_default_alt&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">plot_alternate_model</span> \
                  <span class="k">if</span> <span class="s1">&#39;plot_alternate_model&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),]</span>
    <span class="n">fasta_opt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;fasta_fn&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">genome_fasta</span>
                  <span class="k">if</span> <span class="s1">&#39;genome_fasta&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),]</span>
    <span class="n">motif_opt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;motif&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">motif</span> <span class="k">if</span> <span class="s1">&#39;motif&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),]</span>
    <span class="n">seqfn_opt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;seqs_fn&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">sequences_filename</span>
                  <span class="k">if</span> <span class="s1">&#39;sequences_filename&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),]</span>
    <span class="n">statfn_opt</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;stats_fn&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">statistics_filename</span>
                   <span class="k">if</span> <span class="s1">&#39;statistics_filename&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),]</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">subcmd</span> <span class="o">==</span> <span class="s1">&#39;plot_max_coverage&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">f5dirs2_opt</span> <span class="o">+</span> <span class="n">nreg_opt</span> <span class="o">+</span> <span class="n">nbase_opt</span> <span class="o">+</span> <span class="n">genome_opts</span> <span class="o">+</span>
                      <span class="n">tbmod_opt</span> <span class="o">+</span> <span class="n">atbmod_opt</span> <span class="o">+</span> <span class="n">dtbmod_opt</span> <span class="o">+</span> <span class="n">datbmod_opt</span><span class="p">)</span>
        <span class="n">plot_max_coverage</span><span class="p">(</span><span class="o">*</span><span class="n">base_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">subcmd</span> <span class="o">==</span> <span class="s1">&#39;plot_genome_location&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">f5dirs2_opt</span> <span class="o">+</span> <span class="n">nbase_opt</span> <span class="o">+</span> <span class="n">genome_opts</span> <span class="o">+</span> <span class="n">glocs_opt</span> <span class="o">+</span>
                      <span class="n">tbmod_opt</span> <span class="o">+</span> <span class="n">atbmod_opt</span> <span class="o">+</span> <span class="n">dtbmod_opt</span> <span class="o">+</span> <span class="n">datbmod_opt</span><span class="p">)</span>
        <span class="n">plot_genome_locations</span><span class="p">(</span><span class="o">*</span><span class="n">base_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">subcmd</span> <span class="o">==</span> <span class="s1">&#39;plot_motif_centered&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">f5dirs2_opt</span> <span class="o">+</span> <span class="n">nreg_opt</span> <span class="o">+</span> <span class="n">nbase_opt</span> <span class="o">+</span> <span class="n">genome_opts</span> <span class="o">+</span>
                      <span class="n">fasta_opt</span> <span class="o">+</span> <span class="n">motif_opt</span> <span class="o">+</span> <span class="n">tbmod_opt</span> <span class="o">+</span> <span class="n">atbmod_opt</span> <span class="o">+</span>
                      <span class="n">dtbmod_opt</span> <span class="o">+</span> <span class="n">datbmod_opt</span> <span class="o">+</span>
                      <span class="p">[(</span><span class="s1">&#39;deepest_coverage&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">deepest_coverage</span><span class="p">),])</span>
        <span class="n">plot_motif_centered</span><span class="p">(</span><span class="o">*</span><span class="n">base_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">subcmd</span> <span class="o">==</span> <span class="s1">&#39;plot_max_difference&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">f5dirs2_opt</span> <span class="o">+</span> <span class="n">nreg_opt</span> <span class="o">+</span> <span class="n">nbase_opt</span> <span class="o">+</span> <span class="n">genome_opts</span> <span class="o">+</span>
                      <span class="n">seqfn_opt</span><span class="p">)</span>
        <span class="n">plot_max_diff</span><span class="p">(</span><span class="o">*</span><span class="n">base_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">subcmd</span> <span class="o">==</span> <span class="s1">&#39;plot_most_significant&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">f5dirs2_opt</span> <span class="o">+</span> <span class="n">nreg_opt</span> <span class="o">+</span> <span class="n">nbase_opt</span> <span class="o">+</span> <span class="n">genome_opts</span> <span class="o">+</span>
                      <span class="n">seqfn_opt</span> <span class="o">+</span> <span class="n">statfn_opt</span> <span class="o">+</span> <span class="n">tbmod_opt</span> <span class="o">+</span> <span class="n">atbmod_opt</span> <span class="o">+</span>
                      <span class="n">dtbmod_opt</span> <span class="o">+</span> <span class="n">datbmod_opt</span><span class="p">)</span>
        <span class="n">plot_most_signif</span><span class="p">(</span><span class="o">*</span><span class="n">base_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">subcmd</span> <span class="o">==</span> <span class="s1">&#39;plot_motif_with_stats&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">f5dirs2_opt</span> <span class="o">+</span> <span class="n">nreg_opt</span> <span class="o">+</span> <span class="n">motif_opt</span> <span class="o">+</span> <span class="n">statfn_opt</span> <span class="o">+</span>
                      <span class="n">tbmod_opt</span> <span class="o">+</span> <span class="n">atbmod_opt</span> <span class="o">+</span> <span class="n">dtbmod_opt</span> <span class="o">+</span> <span class="n">datbmod_opt</span> <span class="o">+</span>
                      <span class="n">fasta_opt</span> <span class="o">+</span>
                      <span class="p">[(</span><span class="s1">&#39;overplot_thresh&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">overplot_threshold</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;context_width&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_context</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;num_stats&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_statistics</span><span class="p">)])</span>
        <span class="n">plot_motif_centered_signif</span><span class="p">(</span><span class="o">*</span><span class="n">base_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">subcmd</span> <span class="o">==</span> <span class="s1">&#39;plot_correction&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">nobs_opt</span> <span class="o">+</span> <span class="n">nread_opt</span> <span class="o">+</span> <span class="p">[(</span><span class="s1">&#39;reg_type&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">region_type</span><span class="p">),])</span>
        <span class="n">plot_corrections</span><span class="p">(</span><span class="o">*</span><span class="n">base_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">subcmd</span> <span class="o">==</span> <span class="s1">&#39;plot_multi_correction&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">nreg_opt</span> <span class="o">+</span> <span class="n">nobs_opt</span> <span class="o">+</span> <span class="n">glocs_opt</span> <span class="o">+</span>
                      <span class="p">[(</span><span class="s1">&#39;num_reads_per_plot&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_reads</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;include_orig_bcs&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">include_original_basecalls</span><span class="p">)])</span>
        <span class="n">plot_multi_corrections</span><span class="p">(</span><span class="o">*</span><span class="n">base_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">subcmd</span> <span class="o">==</span> <span class="s1">&#39;cluster_most_significant&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">f5dirs2_opt</span> <span class="o">+</span> <span class="n">nreg_opt</span> <span class="o">+</span> <span class="n">nbase_opt</span> <span class="o">+</span>
                      <span class="n">fasta_opt</span> <span class="o">+</span> <span class="n">statfn_opt</span> <span class="o">+</span> <span class="n">rdata_opt</span> <span class="o">+</span>
                      <span class="p">[(</span><span class="s1">&#39;num_processes&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;slide_span&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">slide_span</span><span class="p">)])</span>
        <span class="n">cluster_most_signif</span><span class="p">(</span><span class="o">*</span><span class="n">base_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">subcmd</span> <span class="o">==</span> <span class="s1">&#39;plot_per_read&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">glocs_opt</span> <span class="o">+</span> <span class="n">fasta_opt</span> <span class="o">+</span> <span class="n">nbase_opt</span> <span class="o">+</span>
                      <span class="p">[(</span><span class="s1">&#39;per_read_stats_fn&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">per_read_statistics_filename</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;num_reads&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_reads</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;box_center&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">box_center</span><span class="p">)])</span>
        <span class="n">plot_per_read_mods_genome_location</span><span class="p">(</span><span class="o">*</span><span class="n">base_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">subcmd</span> <span class="o">==</span> <span class="s1">&#39;plot_kmer&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">nread_opt</span> <span class="o">+</span> <span class="n">rdata_opt</span> <span class="o">+</span>
                      <span class="p">[(</span><span class="s1">&#39;read_mean&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">read_mean</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;upstrm_bases&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">upstream_bases</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;dnstrm_bases&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">downstream_bases</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;kmer_thresh&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_kmer_threshold</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;dont_plot&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">dont_plot</span><span class="p">)])</span>
        <span class="n">plot_kmer_dist</span><span class="p">(</span><span class="o">*</span><span class="n">base_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">subcmd</span> <span class="o">==</span> <span class="s1">&#39;plot_roc&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fasta_opt</span> <span class="o">+</span>
                      <span class="p">[(</span><span class="s1">&#39;pdf_fn&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">pdf_filename</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;motif_descs&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">motif_descriptions</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;stats_fns&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">statistics_filenames</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;min_reads&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">minimum_test_reads</span><span class="p">)])</span>
        <span class="n">plot_roc</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ERROR: Invalid tombo sub-command entered. &#39;</span> <span class="o">+</span>
                         <span class="s1">&#39;Should have been caught by argparse.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</div>
    <span class="k">return</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s1">&#39;This is a module. See commands with `tombo -h`&#39;</span><span class="p">)</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Oxford Nanopore Technologies.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>